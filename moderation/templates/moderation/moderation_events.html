{% extends "basemode.html" %}
{% load static %}

{% block title %}Duyá»‡t Ä‘Äƒng kÃ½ sá»± kiá»‡n â€¢ Moderator Center{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/basemode.css' %}">
{% endblock %}

{% block content %}
<h2>ğŸ“… Duyá»‡t Ä‘Äƒng kÃ½ sá»± kiá»‡n</h2>

<!-- Tabs -->
<div class="tab-wrapper">
  <a href="{% url 'moderation_reports' %}" class="tab-btn">BÃ¡o cÃ¡o vi pháº¡m</a>
  <a href="{% url 'moderation_events' %}" class="tab-btn active">ÄÄƒng kÃ½ sá»± kiá»‡n</a>
</div>

<!-- Báº£ng danh sÃ¡ch sá»± kiá»‡n -->
<table class="styled-table">
  <thead>
    <tr>
      <th>#</th>
      <th>TÃªn sá»± kiá»‡n</th>
      <th>NgÆ°á»i táº¡o</th>
      <th>Thá»i gian</th>
      <th>Äá»‹a Ä‘iá»ƒm</th>
      <th>Tráº¡ng thÃ¡i</th>
      <th>HÃ nh Ä‘á»™ng</th>
    </tr>
  </thead>
  <tbody>
    {% for e in pending_events %}
    <tr data-id="{{ e.id }}">
      <td>#{{ e.id }}</td>
      <td>{{ e.title }}</td>
      <td>{{ e.creator.username }}</td>
      <td>{{ e.date|date:"d/m/Y H:i" }}</td>
      <td>{{ e.location }}</td>
      <td>
        <span class="status-badge status-{{ e.status }}">{{ e.status|capfirst }}</span>
      </td>
      <td>
        <button class="btn-check"
                onclick="openModal(this)"
                data-title="{{ e.title }}"
                data-user="{{ e.creator.username }}"
                data-date="{{ e.date|date:'d/m/Y H:i' }}"
                data-location="{{ e.location }}"
                data-desc="{{ e.description }}"
                data-status="{{ e.status }}">
          Kiá»ƒm tra
        </button>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="7" style="text-align:center; color:gray;">KhÃ´ng cÃ³ sá»± kiá»‡n nÃ o cáº§n duyá»‡t.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Modal chi tiáº¿t sá»± kiá»‡n -->
<div class="modal-overlay" id="modal" style="display:none;">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Chi tiáº¿t sá»± kiá»‡n</h3>
      <span class="modal-close" onclick="closeModal()">Ã—</span>
    </div>

    <p><strong>TÃªn:</strong> <span id="modal-title"></span></p>
    <p><strong>NgÆ°á»i táº¡o:</strong> <span id="modal-user"></span></p>
    <p><strong>Thá»i gian:</strong> <span id="modal-date"></span></p>
    <p><strong>Äá»‹a Ä‘iá»ƒm:</strong> <span id="modal-location"></span></p>
    <p><strong>MÃ´ táº£:</strong> <span id="modal-desc"></span></p>
    <p><strong>Tráº¡ng thÃ¡i:</strong>
      <span id="modal-status" class="status-badge status-pending">Pending</span>
    </p>

    <div class="modal-footer">
      <button class="btn-approve" onclick="updateEvent('approve')">PhÃª duyá»‡t</button>
      <button class="btn-reject" onclick="updateEvent('reject')">Tá»« chá»‘i</button>
      <button class="btn-close" onclick="closeModal()">ÄÃ³ng</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ========== Má» POPUP ==========
function openModal(button) {
  const title = button.getAttribute('data-title');
  const user = button.getAttribute('data-user');
  const date = button.getAttribute('data-date');
  const location = button.getAttribute('data-location');
  const desc = button.getAttribute('data-desc');
  const status = button.getAttribute('data-status');
  const eventId = button.closest('tr').querySelector('td').innerText.replace('#', '').trim();

  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-user").textContent = user;
  document.getElementById("modal-date").textContent = date;
  document.getElementById("modal-location").textContent = location;
  document.getElementById("modal-desc").textContent = desc;
  document.getElementById("modal-status").textContent = status;
  document.getElementById("modal").dataset.eventId = eventId;

  const badge = document.getElementById("modal-status");
  badge.className = "status-badge status-" + status;

  document.getElementById("modal").style.display = "flex";
}

// ========== ÄÃ“NG POPUP ==========
function closeModal() {
  document.getElementById("modal").style.display = "none";
}

// ========== AJAX Cáº¬P NHáº¬T Sá»° KIá»†N ==========
function updateEvent(action) {
  const modal = document.getElementById("modal");
  const eventId = modal.dataset.eventId;

  fetch(`/moderation/events/update/${eventId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: `action=${action}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const newStatus = data.new_status;
      const row = document.querySelector(`tr[data-id="${eventId}"]`);

      // cáº­p nháº­t tráº¡ng thÃ¡i trong báº£ng
      if (row) {
        const badge = row.querySelector('.status-badge');
        if (badge) {
          badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
          badge.className = `status-badge status-${newStatus}`;
        }
      }

      // cáº­p nháº­t modal
      const modalBadge = document.getElementById("modal-status");
      modalBadge.textContent = newStatus;
      modalBadge.className = `status-badge status-${newStatus}`;

      closeModal();

      // âœ… ThÃ´ng bÃ¡o nhá» gá»n
      showToast(`âœ… ÄÃ£ ${newStatus === 'approved' ? 'phÃª duyá»‡t' : 'tá»« chá»‘i'} sá»± kiá»‡n #${eventId}`, newStatus);

      // TÃ¹y chá»n reload nháº¹
      setTimeout(() => window.location.reload(), 800);
    } else {
      showToast("âŒ Lá»—i: " + (data.error || 'KhÃ´ng thá»ƒ cáº­p nháº­t.'), "error");
    }
  })
  .catch(err => console.error(err));
}

// ========== HÃ€M TOAST THÃ”NG BÃO ==========
function showToast(message, type) {
  const toast = document.createElement("div");
  toast.className = `toast-message toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

// ========== Láº¤Y CSRF TOKEN ==========
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<style>
.toast-message {
  position: fixed;
  bottom: 30px;
  right: 30px;
  padding: 12px 18px;
  color: #fff;
  border-radius: 8px;
  font-weight: 500;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  animation: fadein 0.3s, fadeout 0.5s 1.8s;
  z-index: 9999;
}
.toast-approved { background: #22c55e; }
.toast-rejected { background: #ef4444; }
.toast-error { background: #f97316; }
@keyframes fadein { from { opacity: 0; bottom: 10px; } to { opacity: 1; bottom: 30px; } }
@keyframes fadeout { from { opacity: 1; } to { opacity: 0; bottom: 10px; } }
</style>
{% endblock %}