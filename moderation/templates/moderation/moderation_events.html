{% extends "basemode.html" %}
{% load static %}

{% block title %}Duyệt đăng ký sự kiện • Moderator Center{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/basemode.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <h2>Duyệt đăng ký sự kiện</h2>

  <!-- Tabs -->
  <div class="tab-wrapper">
    <a href="{% url 'moderation_reports' %}" class="tab-btn">Báo cáo vi phạm</a>
    <a href="{% url 'moderation_events' %}" class="tab-btn active">Đăng ký sự kiện</a>
  </div>

  <!-- Bảng danh sách sự kiện -->
  <table class="styled-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Tên sự kiện</th>
        <th>Người tạo</th>
        <th>Thời gian</th>
        <th>Địa điểm</th>
        <th>Trạng thái</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
      {% for e in pending_events %}
      <tr data-id="{{ e.id }}">
        <td>#{{ e.id }}</td>
        <td>{{ e.title }}</td>
        <td>{{ e.creator.username }}</td>
        <td>{{ e.date|date:"d/m/Y H:i" }}</td>
        <td>{{ e.location }}</td>
        <td><span class="status-badge status-{{ e.status }}">{{ e.status|capfirst }}</span></td>
        <td>
          <button class="btn-check"
                  onclick="openModal(this)"
                  data-title="{{ e.title }}"
                  data-user="{{ e.creator.username }}"
                  data-date="{{ e.date|date:'d/m/Y H:i' }}"
                  data-location="{{ e.location }}"
                  data-desc="{{ e.description }}"
                  data-status="{{ e.status }}">
            Kiểm tra
          </button>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" style="text-align:center; color:gray;">Không có sự kiện nào cần duyệt.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal chi tiết sự kiện -->
<div class="modal-overlay" id="modal" style="display:none;">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Chi tiết sự kiện</h3>
      <span class="modal-close" onclick="closeModal()">×</span>
    </div>

    <p><strong>Tên:</strong> <span id="modal-title"></span></p>
    <p><strong>Người tạo:</strong> <span id="modal-user"></span></p>
    <p><strong>Thời gian:</strong> <span id="modal-date"></span></p>
    <p><strong>Địa điểm:</strong> <span id="modal-location"></span></p>
    <p><strong>Mô tả:</strong> <span id="modal-desc"></span></p>
    <p><strong>Trạng thái:</strong>
      <span id="modal-status" class="status-badge status-pending">Pending</span>
    </p>

    <div class="modal-footer">
      <button class="btn-approve" onclick="updateEvent('approve')">Phê duyệt</button>
      <button class="btn-reject" onclick="updateEvent('reject')">Từ chối</button>
      <button class="btn-close" onclick="closeModal()">Đóng</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ========== MỞ POPUP ==========
function openModal(button) {
  const title = button.getAttribute('data-title');
  const user = button.getAttribute('data-user');
  const date = button.getAttribute('data-date');
  const location = button.getAttribute('data-location');
  const desc = button.getAttribute('data-desc');
  const status = button.getAttribute('data-status');
  const eventId = button.closest('tr').dataset.id;

  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-user").textContent = user;
  document.getElementById("modal-date").textContent = date;
  document.getElementById("modal-location").textContent = location;
  document.getElementById("modal-desc").textContent = desc;
  document.getElementById("modal-status").textContent = status;
  document.getElementById("modal").dataset.eventId = eventId;

  const badge = document.getElementById("modal-status");
  badge.className = "status-badge status-" + status;
  document.getElementById("modal").style.display = "flex";
}

// ========== ĐÓNG POPUP ==========
function closeModal() {
  document.getElementById("modal").style.display = "none";
}

// ========== AJAX CẬP NHẬT ==========
function updateEvent(action) {
  const modal = document.getElementById("modal");
  const eventId = modal.dataset.eventId;

  fetch(`/moderation/events/update/${eventId}/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: `action=${action}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const newStatus = data.new_status;
      const row = document.querySelector(`tr[data-id="${eventId}"]`);
      if (row) {
        const badge = row.querySelector('.status-badge');
        if (badge) {
          badge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
          badge.className = `status-badge status-${newStatus}`;
        }
      }

      const modalBadge = document.getElementById("modal-status");
      modalBadge.textContent = newStatus;
      modalBadge.className = `status-badge status-${newStatus}`;

      closeModal();
      showToast(`✅ Đã ${newStatus === 'approved' ? 'phê duyệt' : 'từ chối'} sự kiện #${eventId}`, newStatus);
      setTimeout(() => window.location.reload(), 800);
    } else {
      showToast("❌ Lỗi: " + (data.error || 'Không thể cập nhật.'), "error");
    }
  })
  .catch(err => console.error(err));
}

// ========== TOAST ==========
function showToast(message, type) {
  const toast = document.createElement("div");
  toast.className = `toast-message toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

// ========== CSRF ==========
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
