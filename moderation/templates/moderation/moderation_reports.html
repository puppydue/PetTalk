{% extends "basemode.html" %}
{% load static %}

{% block title %}Báo cáo vi phạm • Moderator Center{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/basemode.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
  <h2>Báo cáo vi phạm</h2>

  <div class="tab-wrapper">
    <a href="{% url 'moderation_reports' %}" class="tab-btn active">Báo cáo vi phạm</a>
    <a href="{% url 'moderation_events' %}" class="tab-btn">Đăng ký sự kiện</a>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="group">
      <span class="filter-title">Loại:</span>
      {% for opt,val in type_options %}
        <a class="pill {% if type_filter == val %}active{% endif %}"
           href="?type={{ val }}&status={{ status_filter }}">{{ opt }}</a>
      {% endfor %}
    </div>
    <div class="group" style="margin-left:12px">
      <span class="filter-title">Trạng thái:</span>
      {% for opt,val in status_options %}
        <a class="pill {% if status_filter == val %}active{% endif %}"
           href="?type={{ type_filter }}&status={{ val }}">{{ opt }}</a>
      {% endfor %}
    </div>
  </div>

  <table class="styled-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Loại</th>
        <th>Người báo cáo</th>
        <th style="width:35%">Nội dung bị báo cáo</th>
        <th>Thời gian</th>
        <th>Trạng thái</th>
        <th>Hành động</th>
      </tr>
    </thead>
    <tbody>
      {% for r in reports %}
        <tr data-type="{{ r.rtype }}" data-id="{{ r.rid }}">
          <td>#{{ r.rid }}</td>
          <td>{{ r.rtype|capfirst }}</td>
          <td>{{ r.reporter }}</td>
          <td>
            <div style="font-weight:600">{{ r.target_title }}</div>
            <div style="color:var(--muted); font-size:.9rem">{{ r.target_preview }}</div>
          </td>
          <td>{{ r.created_at|date:"d/m/Y H:i" }}</td>
          <td><span class="badge badge-{{ r.status }}">{{ r.status|capfirst }}</span></td>
          <td>
            <button class="btn-check"
                    onclick="openModal(this)"
                    data-type="{{ r.rtype }}"
                    data-id="{{ r.rid }}"
                    data-reporter="{{ r.reporter }}"
                    data-reason="{{ r.reason }}"
                    data-details="{{ r.details|default_if_none:'' }}"
                    data-status="{{ r.status }}"
                    data-title="{{ r.target_title }}"
                    data-preview="{{ r.target_preview|default:'' }}">
              Kiểm tra
            </button>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="7" style="text-align:center;color:gray">Không có báo cáo nào.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal" style="display:none;">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Chi tiết báo cáo</h3>
      <span class="modal-close" onclick="closeModal()">×</span>
    </div>

    <p><strong>Loại:</strong> <span id="m-type"></span></p>
    <p><strong>Người báo cáo:</strong> <span id="m-reporter"></span></p>
    <p><strong>Lý do:</strong> <span id="m-reason"></span></p>
    <p><strong>Chi tiết:</strong> <span id="m-details"></span></p>
    <p><strong>Nội dung bị báo cáo:</strong></p>
    <div id="m-target" style="background:#f8fafc;border:1px solid var(--line);padding:10px;border-radius:8px;margin-bottom:8px"></div>

    <p><strong>Trạng thái:</strong> <span id="m-status" class="badge badge-pending">Pending</span></p>

    <div class="modal-footer">
      <button class="btn-approve" onclick="updateReport('approve')">Phê duyệt</button>
      <button class="btn-reject" onclick="updateReport('reject')">Từ chối</button>
      <button class="btn-close" onclick="closeModal()">Đóng</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openModal(btn){
  const tr = btn.closest('tr');
  const rtype = btn.dataset.type;
  const rid   = btn.dataset.id;
  const reporter = btn.dataset.reporter;
  const reason   = btn.dataset.reason || '';
  const details  = btn.dataset.details || '';
  const status   = btn.dataset.status || 'pending';
  const title    = btn.dataset.title || '';
  const preview  = btn.dataset.preview || '';

  const modal = document.getElementById('modal');
  modal.dataset.rtype = rtype;
  modal.dataset.rid   = rid;

  document.getElementById('m-type').textContent     = rtype;
  document.getElementById('m-reporter').textContent = reporter;
  document.getElementById('m-reason').textContent   = reason;
  document.getElementById('m-details').textContent  = details;
  document.getElementById('m-target').innerHTML     =
    `<div style="font-weight:600;margin-bottom:6px">${title}</div>
     <div style="color:var(--muted)">${preview}</div>`;

  const badge = document.getElementById('m-status');
  badge.textContent = status.charAt(0).toUpperCase()+status.slice(1);
  badge.className = `badge badge-${status}`;
  modal.style.display = 'flex';
}
function closeModal(){ document.getElementById('modal').style.display = 'none'; }

function updateReport(action){
  const modal = document.getElementById('modal');
  const rtype = modal.dataset.rtype;
  const rid   = modal.dataset.rid;

  fetch(`/moderation/reports/update/${rtype}/${rid}/`, {
    method: 'POST',
    headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/x-www-form-urlencoded'},
    body: `action=${action}`
  })
  .then(r => r.json())
  .then(data => {
    if(!data.success){ showToast("Lỗi: " + (data.error || 'Không cập nhật được'), 'error'); return; }

    const newStatus = data.new_status;
    const row = document.querySelector(`tr[data-type="${rtype}"][data-id="${rid}"]`);
    if(row){
      const badge = row.querySelector('.badge');
      badge.textContent = newStatus.charAt(0).toUpperCase()+newStatus.slice(1);
      badge.className = `badge badge-${newStatus}`;
    }

    closeModal();
    showToast(`Đã ${newStatus === 'approved' ? 'phê duyệt' : 'từ chối'} báo cáo #${rid}`, newStatus);

    setTimeout(() => window.location.reload(), 800);
  })
  .catch(() => showToast("Lỗi mạng", 'error'));
}

function showToast(msg,type){
  const t = document.createElement('div');
  t.className = `toast-message toast-${type}`;
  t.textContent = msg; document.body.appendChild(t);
  setTimeout(()=>t.remove(), 2000);
}

function getCookie(name){
  let cookieValue = null;
  if(document.cookie && document.cookie !== ''){
    const cookies = document.cookie.split(';');
    for(let c of cookies){
      c = c.trim();
      if(c.substring(0, name.length+1) === (name+'=')){
        cookieValue = decodeURIComponent(c.substring(name.length+1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}
