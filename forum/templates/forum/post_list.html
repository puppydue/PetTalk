{% extends "base.html" %}
{% load static %}
{% load forum_extras %}
{% block title %}Diễn đàn PetTalk{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">

<style>
/* ================================================= */
/* 1. MENU 3 CHẤM (SỬA/XÓA) GỌN & ĐỀU CHỮ          */
/* ================================================= */
.post-menu-wrapper {
  position: relative;
  display: inline-block;
}

.post-menu-btn {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #64748b;
  padding: 0 8px;
  line-height: 1;
}
.post-menu-btn:hover { color: #003459; }

.post-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 6px;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 14px;
  box-shadow: 0 6px 24px rgba(15,23,42,0.16);
  padding: 6px;
  min-width: 170px;
  z-index: 100;
}

.post-menu button,
.post-menu a {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 9px 12px;
  background: transparent;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #0f172a;
  text-decoration: none !important;
  box-sizing: border-box;
  text-align: left;
  white-space: nowrap;
}
.post-menu button i,
.post-menu a i {
  width: 18px;
  text-align: center;
}
.post-menu button:hover,
.post-menu a:hover {
  background: #f1f5f9;
  color: #003459;
}

/* ================================================= */
/* 2. CHỌN CHỦ ĐỀ KIỂU CHIPS (CÓ ICON RIÊNG)        */
/* ================================================= */
.topic-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 6px;
}

.topic-radio { display: none; }

.topic-label {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 8px 16px;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 99px;
  color: #64748b;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}
.topic-label i {
  font-size: 14px;
  color: #94a3b8;
  transition: color 0.2s;
}

.topic-label:hover {
  background: #f1f5f9;
  border-color: #94a3b8;
  color: #334155;
}

/* Khi được chọn */
.topic-radio:checked + .topic-label {
  background: #003459;
  color: #fff;
  border-color: #003459;
  font-weight: 600;
  box-shadow: 0 4px 6px rgba(0, 52, 89, 0.2);
  transform: translateY(-1px);
}
.topic-radio:checked + .topic-label i {
  color: #fff;
}

/* ================================================= */
/* 3. TRÌNH QUẢN LÝ ẢNH TÙY CHỈNH                   */
/* ================================================= */
.custom-file-upload {
  border: 2px dashed #cbd5e1;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  background: #f8fafc;
  color: #64748b;
  transition: 0.2s;
  display: block;
}
.custom-file-upload:hover {
  border-color: #003459;
  background: #f0f9ff;
  color: #003459;
}

.preview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 10px;
  margin-top: 15px;
}

.preview-item {
  position: relative;
  width: 100%;
  padding-top: 100%;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  background: #f1f5f9;
  border: 1px solid #e2e8f0;
}

.preview-item img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.btn-remove-img {
  position: absolute;
  top: 4px;
  right: 4px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: 0.2s;
  z-index: 2;
}
.btn-remove-img:hover { background: #ef4444; }

/* ================================================= */
/* 4. STYLE CŨ: CARD, AVATAR, BADGE...               */
/* ================================================= */
.create-post-trigger {
  background: #fff;
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  margin-bottom: 16px;
  transition: all 0.25s ease;
}
.create-post-trigger:hover { box-shadow: 0 6px 14px rgba(0,0,0,0.12); }

.trigger-avatar, .avatar {
  width: 40px;
  height: 40px;
  border-radius: 9999px;
  background: #003459;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  overflow: hidden;
}
.trigger-avatar img, .avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* badge user */
.badge-chip {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 10px;
  border: 1px solid;
  cursor: default;
  transition: all 0.2s ease-out;
  animation: badgeGlow 3s ease-in-out infinite;
}
.badge-chip:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
  animation: none;
}
@keyframes badgeGlow {
  0%,100% { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  50% { box-shadow: 0 3px 8px rgba(0,0,0,0.08); }
}
.badge-color-gold { background: #fff4c2; border-color: #f7d98b; color: #8a5a00; }
.badge-color-blue { background: #e0f2fe; border-color: #7dd3fc; color: #0369a1; }
.badge-color-green { background: #dcfce7; border-color: #86efac; color: #15803d; }
.badge-color-red { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
.badge-color-cyan { background: #cffafe; border-color: #67e8f9; color: #0e7490; }
.badge-color-lime { background: #f7fee7; border-color: #bef264; color: #4d7c0f; }

.trigger-input {
  flex: 1;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 12px;
  background: #f8fafc;
  color: #475569;
  transition: 0.2s;
}
.trigger-input:hover { border-color: #003459; }

.post-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 780px;
  margin: 0 auto;
  padding: 8px 0;
}

.post-card {
  background: #fff;
  border-radius: 16px;
  padding: 16px 18px 14px;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
  border-left: 6px solid #003459;
}

.post-title {
  font-weight: 700;
  color: #0f172a;
  margin: 6px 0;
}

/* topic tag trong bài */
.post-topic-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  background: #e0f2fe;
  color: #0369a1;
  font-size: 13px;
  font-weight: 600;
}

/* GRID ẢNH & LIGHTBOX */
.post-images {
  display: grid;
  gap: 4px;
  border-radius: 12px;
  overflow: hidden;
  margin-top: 15px;
}

/* 1 ảnh – căn giữa, nền trắng 2 bên */
.images-count-1 {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 14px;
  background: #f8fafc;
  border-radius: 16px;
}
.images-count-1 .image-wrapper {
  width: 100%;
  height: auto;
  position: relative;
}
.images-count-1 img {
  width: 100%;
  height: auto;
  max-height: 480px;
  object-fit: contain;
  position: relative !important;
}

/* 2+ ảnh */
.image-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  background: #f8fafc;
}
.post-images img {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s;
}
.post-images img:hover { transform: scale(1.03); }

.images-count-2 { grid-template-columns: 1fr 1fr; height: 300px; }
.images-count-3 { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-3 .image-wrapper:first-child { grid-row: span 2; }
.images-count-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-more { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-more .image-wrapper:nth-child(n+5) { display: none; }

.images-count-more .image-wrapper[data-more-count]::after {
  content: attr(data-more-count);
  position: absolute;
  inset: 0;
  background: rgba(15,23,42,0.55);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.1rem;
  font-weight: 800;
}
.images-count-more .image-wrapper[data-more-count] {
  cursor: pointer;
}

/* Lightbox */
.lightbox {
  position: fixed;
  z-index: 9990;
  padding-top: 50px;
  inset: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.9);
  display: none;
  animation: fadeIn 0.3s ease;
}
.lightbox-content {
  margin: auto;
  display: block;
  max-width: 90%;
  max-height: 85vh;
  animation: zoom 0.3s ease;
}
.lightbox-close {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
}
.lightbox-close:hover { color: #bbb; }
.lightbox-prev, .lightbox-next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  margin-top: -50px;
  color: white;
  font-weight: bold;
  font-size: 30px;
  user-select: none;
}
.lightbox-next { right: 0; border-radius: 3px 0 0 3px; }
.lightbox-prev { left: 0; }
.lightbox-prev:hover, .lightbox-next:hover {
  background-color: rgba(255,255,255,0.2);
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoom { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

/* ACTIONS */
.actions {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
}
.vote-btn {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  border: 1px solid #cbd5e1;
  background: #f8fafc;
  color: #003459;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.vote-btn:hover { background: #f7dba7; }
.vote-count {
  font-weight: 700;
  font-size: 15px;
  min-width: 28px;
  text-align: center;
  color: #003459;
}
.vote-btn.active-up { background: #ff4500; color: #fff; border-color: #ff4500; }
.vote-btn.active-down { background: #6a5cff; color: #fff; border-color: #6a5cff; }

.btn-ghost {
  border: 1px solid #003459;
  color: #003459;
  background: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none !important;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.25s ease;
}
.btn-ghost:hover { background: #f7dba7; border-color: #003459; }

.btn-primary {
  border: none;
  color: #fff;
  background: #003459;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.25s ease;
}
.btn-primary:hover { background: #00509e; }

/* ================================================= */
/* 5. CUSTOM SELECT (ĐẸP HƠN NATIVE)                */
/* ================================================= */
.search-wrap {
  display: flex;
  align-items: stretch;
  gap: 10px;
  margin-bottom: 20px;
  background: #fff;
  padding: 8px;
  border-radius: 14px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.03);
  border: 1px solid #f1f5f9;
}

.search-wrap input {
    flex: 1;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 0 16px;
    background: #f8fafc;
    height: 40px;
    font-size: 14px;
    transition: all 0.2s;
    background-image: none !important;
}
.search-wrap input:focus {
  border-color: #003459;
  background: #fff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,52,89,0.1);
}
.search-wrap button {
  height: 40px;
  width: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  border-radius: 10px;
}

/* Custom Select CSS */
.custom-select-wrapper {
  position: relative;
  width: 200px;
  user-select: none;
}
.custom-select-trigger {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  font-size: 14px;
  font-weight: 500;
  color: #334155;
  height: 40px;
  line-height: 40px;
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.custom-select-trigger:hover {
  background: #fff;
  border-color: #003459;
}
.custom-select-trigger::after {
  content: '\f078'; /* fa-chevron-down */
  font-family: "Font Awesome 6 Free";
  font-weight: 900;
  font-size: 12px;
  color: #64748b;
  transition: transform 0.2s;
}
.custom-select-wrapper.open .custom-select-trigger::after {
  transform: rotate(180deg);
}

.custom-options {
  position: absolute;
  display: block;
  top: 110%;
  left: 0;
  right: 0;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  z-index: 99;
  transform: translateY(-10px);
  transition: all 0.2s cubic-bezier(0.165, 0.84, 0.44, 1);
  overflow: hidden;
  max-height: 300px;
  overflow-y: auto;
}
.custom-select-wrapper.open .custom-options {
  opacity: 1;
  visibility: visible;
  pointer-events: all;
  transform: translateY(0);
}

.custom-option {
  padding: 10px 14px;
  font-size: 14px;
  color: #475569;
  cursor: pointer;
  border-bottom: 1px solid #f1f5f9;
  transition: all 0.1s;
}
.custom-option:last-child { border-bottom: none; }
.custom-option:hover {
  background: #f1f5f9;
  color: #003459;
  padding-left: 18px; /* Hiệu ứng đẩy nhẹ khi hover */
}
.custom-option.selected {
  background: #e0f2fe;
  color: #003459;
  font-weight: 600;
}

/* ================================================= */
/* 6. MODAL                                         */
/* ================================================= */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,52,89,0.25);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;
}

.modal__panel {
  background: #fff;
  border-radius: 16px;
  width: 100%;
  padding: 25px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  animation: fadeIn 0.25s ease;
  max-height: 90vh;
  overflow-y: auto;
  max-width: 700px;
}

.modal__head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 10px;
}
.modal__head h3 {
  margin: 0;
  color: #003459;
  font-weight: 700;
}
.close-x {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #64748b;
  transition: 0.2s;
}
.close-x:hover { color: #003459; }

.modal__panel input,
.modal__panel select {
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 8px 12px;
  background: #fff;
  color: #0f172a;
  font-size: 15px;
  width: 100%;
  transition: all 0.2s ease;
  height: 42px;
}
.modal__panel textarea {
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 12px;
  background: #fff;
  color: #0f172a;
  font-size: 15px;
  width: 100%;
  transition: all 0.2s ease;
  min-height: 120px;
  resize: vertical;
  line-height: 1.5;
  font-family: inherit;
}
.modal__panel input:focus,
.modal__panel select:focus,
.modal__panel textarea:focus {
  border-color: #003459;
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,52,89,0.1);
}
.modal__panel input[type=file] {
  background: none;
  border: none;
  padding: 4px 0;
  color: #003459;
}

.form-group { margin-bottom: 20px; }
.form-label {
  display: block;
  font-weight: 700;
  color: #0f172a;
  margin-bottom: 8px;
  font-size: 14.5px;
}

/* ================================================= */
/* 7. STYLE BÁO CÁO (REPORT) MỚI                    */
/* ================================================= */
.report-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 15px;
}
.report-radio-label {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  color: #334155;
}
.report-radio-label:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}
.report-radio-label input[type="radio"] {
  margin-right: 12px;
  width: 18px;
  height: 18px;
  accent-color: #003459;
}
/* Khi được chọn */
.report-radio-label:has(input:checked) {
  background: #f0f9ff;
  border-color: #003459;
  color: #003459;
  font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="post-list">
  <!-- Ô tạo bài nhanh -->
  <div id="btn-open-create" class="create-post-trigger">
    <div class="trigger-avatar">
      {% if request.user.userprofile.avatar_image %}
        <img src="{{ request.user.userprofile.avatar_image.url }}" alt="avatar">
      {% else %}
        {{ request.user.username|slice:":1"|upper }}
      {% endif %}
    </div>
    <div class="trigger-input">Đặt câu hỏi cho cộng đồng…</div>
    <button class="btn-ghost" type="button"><i class="fa-regular fa-image"></i> Ảnh</button>
    <button class="btn-primary" type="button">Đăng</button>
  </div>

  <!-- Tìm kiếm + lọc (ĐÃ FIX: CUSTOM SELECT ĐẸP HƠN) -->
  <form method="get" class="search-wrap" id="search-form">
    <input name="q" value="{{ request.GET.q|default:'' }}" placeholder="Tìm theo tiêu đề/nội dung…">

    <!-- Hidden input để giữ giá trị gửi đi -->
    <input type="hidden" name="topic" id="hidden-topic-input" value="{{ request.GET.topic|default:'' }}">

    <!-- Custom Select UI -->
    <div class="custom-select-wrapper" id="custom-select">
      <div class="custom-select-trigger">
        <span id="select-label">— Tất cả chủ đề —</span>
      </div>
      <div class="custom-options">
        <div class="custom-option {% if not request.GET.topic %}selected{% endif %}" data-value="">— Tất cả chủ đề —</div>
        {% for value,label in all_topic_choices %}
          <div class="custom-option {% if request.GET.topic == value %}selected{% endif %}" data-value="{{ value }}">
            {{ label }}
          </div>
        {% endfor %}
      </div>
    </div>

    <button class="btn-primary" type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
  </form>

  {% for post in posts %}
    {% reaction_of post request.user as me_react %}
    <article class="post-card" data-post="{{ post.post_id }}">
      <div class="user-info" style="display:flex;gap:10px;align-items:center;">
        <div class="avatar">
          {% if post.username.userprofile.avatar_image %}
            <a href="{% url 'profiles:view_user_profile' post.username.username %}">
              <img src="{{ post.username.userprofile.avatar_image.url }}" alt="avatar">
            </a>
          {% else %}
            <a href="{% url 'profiles:view_user_profile' post.username.username %}" style="color:#fff;text-decoration:none;">
              {{ post.username.username|slice:":1"|upper }}
            </a>
          {% endif %}
        </div>

        <div>
          <div style="display:flex; align-items:center; gap:8px; font-weight:700; color:#003459;">
            <a href="{% url 'profiles:view_user_profile' post.username.username %}" style="color:#003459;text-decoration:none;">
              {{ post.username.username }}
            </a>

            {% if post.username.userprofile.display_badge %}
              {% with badge=post.username.userprofile.display_badge %}
              <span class="badge-chip badge-color-{{ badge.color }}">
                {{ badge.icon }}
                {{ badge.name }}
              </span>
              {% endwith %}
            {% endif %}
          </div>
          <small style="color:#64748b">{{ post.created_at|date:"d/m/Y H:i" }}</small>
        </div>

        {% if post.username == request.user %}
        <div class="post-menu-wrapper" style="margin-left:auto;">
          <button class="post-menu-btn" data-menu="{{ post.post_id }}">
            <i class="fa-solid fa-ellipsis"></i>
          </button>

          <div class="post-menu" id="menu-{{ post.post_id }}">
            <button class="js-open-edit" data-post="{{ post.post_id }}">
              <i class="fa-solid fa-pen"></i>
              <span>Sửa bài viết</span>
            </button>
            <a href="{% url 'forum:post_delete' post.post_id %}"
               onclick="return confirm('Bạn chắc muốn xóa bài này?')">
              <i class="fa-solid fa-trash-can"></i>
              <span>Xóa bài viết</span>
            </a>
          </div>
        </div>
        {% endif %}
      </div>

      <h3 class="post-title">{{ post.title }}</h3>

      <div style="margin-bottom:8px;">
        <span class="post-topic-tag">
          <i class="fa-solid fa-hashtag"></i>
          {{ post.get_topic_display }}
        </span>
      </div>

      <div class="post-content">{{ post.content|linebreaksbr }}</div>

      {% if post.images.all %}
        {% with all_images=post.images.all %}
          {% with image_count=all_images|length %}
            {% if image_count == 1 %}
              {% with class_name="images-count-1" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% elif image_count == 2 %}
              {% with class_name="images-count-2" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% elif image_count == 3 %}
              {% with class_name="images-count-3" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% elif image_count == 4 %}
              {% with class_name="images-count-4" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% else %}
              {% with class_name="images-count-more" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images|slice:":4" %}
                  <div class="image-wrapper"
                       {% if forloop.last %}data-more-count="+{{ image_count|add:"-4" }}"{% endif %}>
                    <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}

                  <div style="display:none;">
                    {% for img in all_images|slice:"4:" %}
                      <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                    {% endfor %}
                  </div>
                </div>
              {% endwith %}
            {% endif %}
          {% endwith %}
        {% endwith %}
      {% endif %}

      <div class="actions">
        <div class="vote-box" data-post="{{ post.post_id }}">
          <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}"
                  data-type="upvote">
            <i class="fa-solid fa-arrow-up"></i>
          </button>
          <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
          <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}"
                  data-type="downvote">
            <i class="fa-solid fa-arrow-down"></i>
          </button>
        </div>

        <a class="btn-ghost" href="{% url 'forum:post_detail' post.post_id %}">
          <i class="fa-regular fa-comment"></i> {{ post.comments.count }}
        </a>

        <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
          <i class="fa-solid fa-flag"></i> Báo cáo
        </button>
      </div>

      {% include "forum/_report_modal.html" with post=post %}
    </article>
  {% empty %}
    <p style="color:#64748b;text-align:center">Chưa có bài viết nào.</p>
  {% endfor %}
</div>

<!-- Modal tạo bài -->
<div id="create-modal" class="modal">
  <div class="modal__panel">
    <div class="modal__head">
      <h3>✨ Tạo bài viết mới</h3>
      <button class="close-x" data-close>&times;</button>
    </div>

    <form id="create-post-form" method="post" action="{% url 'forum:create_post' %}" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-group">
        <label class="form-label">Tiêu đề</label>
        <input class="form-control" name="title" placeholder="Tiêu đề..." required>
      </div>

      <div class="form-group">
        <label class="form-label">Chủ đề</label>
        <!-- ĐÃ FIX: MỖI CHIP CÓ ICON RIÊNG -->
        <div class="topic-grid">
          {% for value,label in all_topic_choices %}
          <label>
            <input type="radio" name="topic" value="{{ value }}" class="topic-radio" {% if forloop.first %}checked{% endif %}>
            <span class="topic-label">
              <i class="fa-solid
                {% if value == 'nutrition' %}fa-bowl-food
                {% elif value == 'health' %}fa-notes-medical
                {% elif value == 'training' %}fa-graduation-cap
                {% elif value == 'care' %}fa-pump-soap
                {% elif value == 'emergency' %}fa-truck-medical
                {% elif value == 'showoff' %}fa-camera
                {% elif value == 'review' %}fa-star-half-stroke
                {% elif value == 'location' %}fa-map-location-dot
                {% elif value == 'rescue' %}fa-hand-holding-heart
                {% elif value == 'adopt' %}fa-house-chimney-user
                {% elif value == 'memory' %}fa-dove
                {% elif value == 'general' %}fa-comments
                {% else %}fa-paw
                {% endif %}
              "></i>
              {{ label }}
            </span>
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Nội dung</label>
        <textarea class="form-control" name="content" rows="4" placeholder="Nội dung..." required></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Hình ảnh (Không giới hạn)</label>
        <label for="create-file-input" class="custom-file-upload">
          <i class="fa-solid fa-images" style="font-size:24px; margin-bottom:5px;"></i><br>
          Bấm để chọn nhiều ảnh hoặc kéo thả
        </label>
        <input id="create-file-input" type="file" name="images" accept="image/*" multiple style="display:none;">
        <div id="create-preview-box" class="preview-grid"></div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:15px; border-top:1px solid #eee;">
        <button type="button" class="btn-ghost" data-close>Hủy</button>
        <button type="submit" class="btn-primary">Đăng bài</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal sửa bài -->
<div id="edit-post-modal" class="modal">
  <div class="modal__panel">
    <div class="modal__head">
      <h3>✏️ Chỉnh sửa bài viết</h3>
      <button class="close-x" data-close>&times;</button>
    </div>

    <form id="edit-post-form" method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-group">
        <label class="form-label">Tiêu đề</label>
        <input class="form-control" type="text" id="edit-title" name="title" required>
      </div>

      <div class="form-group">
        <label class="form-label">Chủ đề</label>
        <!-- ĐÃ FIX: MỖI CHIP CÓ ICON RIÊNG -->
        <div class="topic-grid">
          {% for value,label in all_topic_choices %}
          <label>
            <input type="radio" name="topic" value="{{ value }}" class="topic-radio edit-topic-radio">
            <span class="topic-label">
              <i class="fa-solid
                {% if value == 'nutrition' %}fa-bowl-food
                {% elif value == 'health' %}fa-notes-medical
                {% elif value == 'training' %}fa-graduation-cap
                {% elif value == 'care' %}fa-pump-soap
                {% elif value == 'emergency' %}fa-truck-medical
                {% elif value == 'showoff' %}fa-camera
                {% elif value == 'review' %}fa-star-half-stroke
                {% elif value == 'location' %}fa-map-location-dot
                {% elif value == 'rescue' %}fa-hand-holding-heart
                {% elif value == 'adopt' %}fa-house-chimney-user
                {% elif value == 'memory' %}fa-dove
                {% elif value == 'general' %}fa-comments
                {% else %}fa-paw
                {% endif %}
              "></i>
              {{ label }}
            </span>
          </label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Nội dung</label>
        <textarea id="edit-content" name="content" class="form-control" rows="5"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Ảnh hiện có (Bấm X để xóa)</label>
        <div id="old-images" class="preview-grid"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Thêm ảnh mới</label>
        <label for="edit-file-input" class="custom-file-upload">
          <i class="fa-solid fa-plus"></i> Chọn thêm ảnh
        </label>
        <input id="edit-file-input" type="file" accept="image/*" multiple style="display:none;">
        <div id="edit-preview-box" class="preview-grid"></div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; padding-top:15px; border-top:1px solid #eee;">
        <button type="button" class="btn-ghost" data-close>Hủy</button>
        <button type="submit" class="btn-primary">Lưu thay đổi</button>
      </div>
    </form>
  </div>
</div>

<!-- Lightbox -->
<div id="image-lightbox" class="lightbox">
  <span class="lightbox-close">×</span>
  <img class="lightbox-content" id="lightbox-img">
  <a class="lightbox-prev" id="lightbox-prev">&#10094;</a>
  <a class="lightbox-next" id="lightbox-next">&#10095;</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){
  let v=null;
  if(document.cookie && document.cookie!==''){
    const c=document.cookie.split(';');
    for(let i=0;i<c.length;i++){
      const s=c[i].trim();
      if(s.substring(0,name.length+1)===(name+'=')){
        v=decodeURIComponent(s.substring(name.length+1));
        break;
      }
    }
  }
  return v;
}
const csrftoken=getCookie('csrftoken');

/* =============== 1. CUSTOM SELECT JS (Dropdown đẹp) =============== */
const wrapper = document.querySelector('.custom-select-wrapper');
if (wrapper) {
  const trigger = wrapper.querySelector('.custom-select-trigger');
  const options = wrapper.querySelectorAll('.custom-option');
  const hiddenInput = document.getElementById('hidden-topic-input');
  const label = document.getElementById('select-label');

  // Set initial label
  const initialSelected = wrapper.querySelector('.custom-option.selected');
  if(initialSelected) label.textContent = initialSelected.textContent.trim();

  // Toggle open
  trigger.addEventListener('click', (e) => {
    e.stopPropagation();
    wrapper.classList.toggle('open');
  });

  // Select option
  options.forEach(option => {
    option.addEventListener('click', (e) => {
      e.stopPropagation();
      options.forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');

      const val = option.dataset.value;
      const text = option.textContent.trim();

      label.textContent = text;
      hiddenInput.value = val;
      wrapper.classList.remove('open');
    });
  });

  // Close when click outside
  document.addEventListener('click', (e) => {
    if(!wrapper.contains(e.target)) {
      wrapper.classList.remove('open');
    }
  });
}

/* =============== 2. QUẢN LÝ ẢNH TẠO / SỬA =============== */
function setupImageManager(inputId, previewBoxId, formId, isAjax=false){
  const input=document.getElementById(inputId);
  const previewBox=document.getElementById(previewBoxId);
  const form=document.getElementById(formId);
  if(!input || !previewBox || !form) return null;

  let dataTransfer=new DataTransfer();

  input.addEventListener('change',e=>{
    const files=e.target.files;
    for(let i=0;i<files.length;i++){
      dataTransfer.items.add(files[i]);
    }
    input.value="";
    render();
  });

  function render(){
    previewBox.innerHTML="";
    for(let i=0;i<dataTransfer.files.length;i++){
      const file=dataTransfer.files[i];
      const reader=new FileReader();
      reader.onload=(ev)=>{
        const div=document.createElement('div');
        div.className='preview-item';
        div.innerHTML=`
          <img src="${ev.target.result}">
          <button type="button" class="btn-remove-img" data-index="${i}">&times;</button>`;
        previewBox.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
  }

  previewBox.addEventListener('click',e=>{
    if(e.target.classList.contains('btn-remove-img')){
      const index=e.target.dataset.index;
      dataTransfer.items.remove(index);
      render();
    }
  });

  if(!isAjax){
    form.addEventListener('submit',()=>{
      input.files=dataTransfer.files;
    });
  }

  form.addEventListener('reset',()=>{
    dataTransfer=new DataTransfer();
    previewBox.innerHTML="";
  });

  return dataTransfer;
}

// tạo
setupImageManager('create-file-input','create-preview-box','create-post-form',false);
// sửa
const editDataTransfer=setupImageManager('edit-file-input','edit-preview-box','edit-post-form',true);

/* =============== FIXED — AJAX VOTE =============== */
document.querySelectorAll('.vote-box').forEach(box=>{
  const buttons = box.querySelectorAll('.js-vote');
  const countEl = box.querySelector('.js-count');
  const postId = box.dataset.post;

  buttons.forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const type = btn.dataset.type;
      const url = `/forum/${postId}/react/${type}/`;

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        const data = await res.json();

        countEl.textContent = data.total_votes ?? 0;

        // reset class
        buttons.forEach(b=>b.classList.remove('active-up','active-down'));

        if(data.reaction === 'upvote') {
          box.querySelector('[data-type="upvote"]').classList.add('active-up');
        }
        if(data.reaction === 'downvote') {
          box.querySelector('[data-type="downvote"]').classList.add('active-down');
        }

      } catch(err) {
        console.error(err);
      }
    });
  });
});

/* =============== 3. MENU 3 CHẤM =============== */
document.addEventListener("click",(e)=>{
  const btn=e.target.closest(".post-menu-btn");
  if(btn){
    e.stopPropagation();
    const id=btn.dataset.menu;
    document.querySelectorAll(".post-menu").forEach(m=>{
      if(m.id!=="menu-"+id) m.style.display="none";
    });
    const menu=document.getElementById("menu-"+id);
    if(menu){
      menu.style.display=(menu.style.display==="block")?"none":"block";
    }
    return;
  }
  if(!e.target.closest(".post-menu")){
    document.querySelectorAll(".post-menu").forEach(m=>m.style.display="none");
  }
});

/* =============== 4. LOAD DỮ LIỆU SỬA BÀI (AJAX) =============== */
document.querySelectorAll(".js-open-edit").forEach(btn=>{
  btn.addEventListener("click",async()=>{
    const postId=btn.dataset.post;
    const modal=document.getElementById("edit-post-modal");
    if(!modal) return;

    // reset
    editDataTransfer && editDataTransfer.items.clear();
    const editPreview=document.getElementById("edit-preview-box");
    const oldImagesBox=document.getElementById("old-images");
    if(editPreview) editPreview.innerHTML="";
    if(oldImagesBox) oldImagesBox.innerHTML="";
    document.querySelectorAll('input[name="delete_images"]').forEach(el=>el.remove());

    // fetch data
    const res=await fetch(`/forum/${postId}/edit-data/`);
    const data=await res.json();

    document.getElementById("edit-title").value=data.title;
    document.getElementById("edit-content").value=data.content;

    // topic
    document.querySelectorAll(".edit-topic-radio").forEach(r=>{
      if(r.value===data.topic) r.checked=true;
    });

    document.getElementById("edit-post-form").action=`/forum/post/${postId}/edit/`;

    // ảnh cũ
    data.images.forEach(img=>{
      const div=document.createElement("div");
      div.className="preview-item";
      div.innerHTML=`
        <img src="${img.url}">
        <button type="button" class="btn-remove-img js-remove-old" data-id="${img.id}">&times;</button>`;
      oldImagesBox.appendChild(div);
    });

    modal.style.display="flex";
  });
});

// xóa ảnh cũ trong form sửa
document.getElementById("old-images").addEventListener("click",e=>{
  if(e.target.classList.contains("js-remove-old")){
    const id=e.target.dataset.id;
    const input=document.createElement("input");
    input.type="hidden";
    input.name="delete_images";
    input.value=id;
    document.getElementById("edit-post-form").appendChild(input);
    e.target.closest(".preview-item").remove();
  }
});

// submit form sửa (AJAX – tránh nhân đôi ảnh)
document.getElementById("edit-post-form").addEventListener("submit",async function(e){
  e.preventDefault();
  const btn=this.querySelector("button[type=submit]");
  const originalText=btn.textContent;
  btn.textContent="Đang lưu...";
  btn.disabled=true;

  const formData=new FormData(this);
  for(let i=0;i<editDataTransfer.files.length;i++){
    formData.append('images',editDataTransfer.files[i]);
  }

  try{
    const res=await fetch(this.action,{
      method:"POST",
      body:formData,
      headers:{ "X-Requested-With":"XMLHttpRequest" }
    });
    const data=await res.json();

    if(data.status==="ok"){
      location.reload();
    }else{
      alert("Lỗi: "+JSON.stringify(data));
    }
  }catch(err){
    alert("Có lỗi xảy ra, vui lòng thử lại.");
  }finally{
    btn.textContent=originalText;
    btn.disabled=false;
  }
});

/* =============== 5. MỞ / ĐÓNG MODAL CREATE / EDIT =============== */
const createModal=document.getElementById('create-modal');
document.getElementById('btn-open-create')?.addEventListener('click',()=>createModal.style.display='flex');
document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>{
  document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
});

/* =============== 6. LIGHTBOX (kèm fix click +4) =============== */
const lightbox=document.getElementById('image-lightbox');
const lbImg=document.getElementById('lightbox-img');
const lbPrev=document.getElementById('lightbox-prev');
const lbNext=document.getElementById('lightbox-next');
let lbImages=[], lbIndex=0;

function showLb(idx){
  lbIndex=(idx+lbImages.length)%lbImages.length;
  lbImg.src=lbImages[lbIndex];
  if(lbImages.length>1){
    lbPrev.style.display='block';
    lbNext.style.display='block';
  }else{
    lbPrev.style.display='none';
    lbNext.style.display='none';
  }
}

document.addEventListener('click',e=>{
  /* click vào overlay +X */
  const moreWrapper=e.target.closest('.images-count-more .image-wrapper[data-more-count]');
  if(moreWrapper){
    const wrapper=moreWrapper.closest('.post-images');
    lbImages=Array.from(wrapper.querySelectorAll('img')).map(img=>img.src);
    const img=moreWrapper.querySelector('img');
    const currentSrc=img ? img.src : lbImages[0];
    lightbox.style.display='block';
    showLb(lbImages.indexOf(currentSrc));
    return;
  }

  /* click vào ảnh */
  const imgEl=e.target.closest('.post-images img');
  if(imgEl){
    const wrapper=imgEl.closest('.post-images');
    lbImages=Array.from(wrapper.querySelectorAll('img')).map(img=>img.src);
    const currentSrc=imgEl.src;
    lightbox.style.display='block';
    showLb(lbImages.indexOf(currentSrc));
    return;
  }

  if(e.target===lightbox || e.target.classList.contains('lightbox-close')){
    lightbox.style.display='none';
  }
  if(e.target===lbNext) showLb(lbIndex+1);
  if(e.target===lbPrev) showLb(lbIndex-1);
});

document.addEventListener('keydown',e=>{
  if(lightbox.style.display==='block'){
    if(e.key==='ArrowRight') showLb(lbIndex+1);
    if(e.key==='ArrowLeft') showLb(lbIndex-1);
    if(e.key==='Escape') lightbox.style.display='none';
  }
});

/* =============== 7. BÁO CÁO BÀI VIẾT (REPORT) =============== */
/* mở modal báo cáo */
document.querySelectorAll('.js-open-report').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const targetId=btn.dataset.target;
    const modal=document.getElementById(targetId);
    if(modal){
      modal.style.display='flex';
    }
  });
});

/* submit form báo cáo qua AJAX */
document.querySelectorAll('.js-report-form').forEach(form=>{
  form.addEventListener('submit',async e=>{
    e.preventDefault();
    const postId=form.dataset.post;
    const modal=form.closest('.modal');
    const submitBtn=form.querySelector('button[type="submit"]');
    const originalText=submitBtn.textContent;

    const url=`/forum/${postId}/report/`;
    const formData=new FormData(form);

    submitBtn.textContent='Đang gửi...';
    submitBtn.disabled=true;

    try{
      const res=await fetch(url,{
        method:'POST',
        headers:{
          'X-CSRFToken': csrftoken,
          'X-Requested-With':'XMLHttpRequest'
        },
        body:formData
      });
      const data=await res.json();
      if(data.status==='ok'){
        alert('Cảm ơn bạn đã báo cáo. Đội ngũ kiểm duyệt sẽ xem xét sớm nhất.');
        form.reset();
        if(modal) modal.style.display='none';
      }else{
        alert('Có lỗi xảy ra, vui lòng thử lại.');
      }
    }catch(err){
      console.error(err);
      alert('Có lỗi xảy ra, vui lòng thử lại.');
    }finally{
      submitBtn.textContent=originalText;
      submitBtn.disabled=false;
    }
  });
});
</script>
{% endblock %}