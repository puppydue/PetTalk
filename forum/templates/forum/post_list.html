{% extends "base.html" %}
{% load static %}
{% load forum_extras %}
{% block title %}Di·ªÖn ƒë√†n PetTalk{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">

<style>
/* === √î t·∫°o b√†i vi·∫øt nhanh === */
.create-post-trigger {
  background: #fff;
  border-radius: 16px;
  padding: 18px;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  margin-bottom: 16px;
  transition: all 0.25s ease;
}
.create-post-trigger:hover { box-shadow: 0 6px 14px rgba(0,0,0,0.12); }

/* === Avatar user === */
.trigger-avatar, .avatar {
  width: 40px;
  height: 40px;
  border-radius: 9999px;
  background: #003459;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  overflow: hidden;
}
.trigger-avatar img, .avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* === ‚úÖ S·ª¨A: CSS CHO CHIP DANH HI·ªÜU ƒêA M√ÄU === */
.badge-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px; /* Gi·∫£m gap 1 ch√∫t */
    padding: 2px 8px; /* D√πng padding nh·ªè */
    font-size: 12px;  /* Font nh·ªè */
    font-weight: 600; /* Gi·∫£m ƒë·ªô ƒë·∫≠m */
    border-radius: 10px; /* Bo tr√≤n √≠t h∆°n */
    border: 1px solid;
    cursor: default; /* Kh√¥ng c·∫ßn hover ·ªü ƒë√¢y */
    transition: all 0.2s ease-out;
    animation: badgeGlow 3s ease-in-out infinite;
}
.badge-chip:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    animation: none; /* T·∫Øt glow khi hover */
}
@keyframes badgeGlow {
  0%, 100% { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  50% { box-shadow: 0 3px 8px rgba(0,0,0,0.08); }
}
.badge-color-gold { background: #fff4c2; border-color: #f7d98b; color: #8a5a00; }
.badge-color-blue { background: #e0f2fe; border-color: #7dd3fc; color: #0369a1; }
.badge-color-green { background: #dcfce7; border-color: #86efac; color: #15803d; }
.badge-color-red { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
.badge-color-cyan { background: #cffafe; border-color: #67e8f9; color: #0e7490; }
.badge-color-lime { background: #f7fee7; border-color: #bef264; color: #4d7c0f; }
/* === H·∫æT CSS M·ªöI === */


/* === √î nh·∫≠p c√¢u h·ªèi nhanh === */
.trigger-input {
  flex: 1;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 12px;
  background: #f8fafc;
  color: #475569;
  transition: 0.2s;
}
.trigger-input:hover { border-color: #003459; }

/* === Danh s√°ch b√†i vi·∫øt === */
.post-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 780px;
  margin: 0 auto;
  padding: 8px 0;
}
.post-card {
  background: #fff;
  border-radius: 16px;
  padding: 16px 18px;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
  border-left: 6px solid #003459;
}
.post-title { font-weight: 700; color: #0f172a; margin: 6px 0; }


/* === CSS Grid ·∫¢nh & Lightbox === */
.post-images {
  display: grid;
  gap: 4px;
  border-radius: 12px;
  overflow: hidden;
  margin-top: 15px;
}
.image-wrapper {
  position: relative;
  width: 100%;
  height: 100%;
  background: #f8fafc;
}
.post-images img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s;
}
.post-images img:hover { transform: scale(1.03); }
.images-count-1 { display: flex; justify-content: center; max-height: 450px; }
.images-count-1 img { position: relative; object-fit: contain; max-height: 450px; width: auto; max-width: 100%; cursor: zoom-in; }
.images-count-2 { grid-template-columns: 1fr 1fr; height: 300px; }
.images-count-3 { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-3 .image-wrapper:first-child { grid-row: span 2; }
.images-count-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-more { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-more .image-wrapper:nth-child(n+5) { display: none; }
.images-count-more .image-wrapper[data-more-count]::after {
  content: attr(data-more-count);
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); color: white; display: flex;
  align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; cursor: pointer;
}

/* Lightbox Modal */
.lightbox {
  position: fixed; z-index: 9990; padding-top: 50px; left: 0; top: 0;
  width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);
  display: none; animation: fadeIn 0.3s ease;
}
.lightbox-content { margin: auto; display: block; max-width: 90%; max-height: 85vh; animation: zoom 0.3s ease; }
.lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
.lightbox-close:hover { color: #bbb; }
.lightbox-prev, .lightbox-next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  margin-top: -50px;
  color: white;
  font-weight: bold;
  font-size: 30px;
  user-select: none;
}
.lightbox-next { right: 0; border-radius: 3px 0 0 3px; }
.lightbox-prev { left: 0; }
.lightbox-prev:hover, .lightbox-next:hover { background-color: rgba(255,255,255,0.2); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoom { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
/* === H·∫æT CSS C·∫¢I TI·∫æN === */


/* === Khu v·ª±c vote + actions === */
.actions {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
}
.vote-btn {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  border: 1px solid #cbd5e1;
  background: #f8fafc;
  color: #003459;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.vote-btn:hover { background: #f7dba7; }
.vote-count {
  font-weight: 700;
  font-size: 15px;
  min-width: 28px;
  text-align: center;
  color: #003459;
}
.vote-btn.active-up { background: #ff4500; color: #fff; border-color: #ff4500; }
.vote-btn.active-down { background: #6a5cff; color: #fff; border-color: #6a5cff; }

/* === N√∫t v√† button === */
.btn-ghost {
  border: 1px solid #003459;
  color: #003459;
  background: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none !important;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.25s ease;
}
.btn-ghost:hover { background: #f7dba7; border-color: #003459; }
.btn-primary {
  border: none;
  color: #fff;
  background: #003459;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.25s ease;
}
.btn-primary:hover { background: #00509e; }

/* === √î t√¨m ki·∫øm + l·ªçc === */
.search-wrap {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}
.search-wrap input, .search-wrap select {
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 12px;
  background: #ffffff;
  flex: 1;
  color: #0f172a;
  transition: all 0.2s ease;
}
.search-wrap input:focus, .search-wrap select:focus {
  border-color: #003459;
  background: #fff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,52,89,0.1);
}

/* === Modal overlay === */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 52, 89, 0.25);
  backdrop-filter: blur(3px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
  overflow-y: auto;
}

/* === Panel trong modal === */
.modal__panel {
  background: #fff;
  border-radius: 16px;
  max-width: 640px;
  width: 100%;
  padding: 20px 22px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.1);
  animation: fadeIn 0.25s ease;
  max-height: 90vh;
  overflow-y: auto;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* === Header c·ªßa modal === */
.modal__head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  border-bottom: 1px solid #e2e8f0;
  padding-bottom: 10px;
}
.modal__head h3 {
  margin: 0;
  color: #003459;
  font-weight: 700;
}
.close-x {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #64748b;
  transition: 0.2s;
}
.close-x:hover { color: #003459; }

/* === C√°c input trong modal === */
.modal__panel input,
.modal__panel select {
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 8px 12px;
  background: #fff;
  color: #0f172a;
  font-size: 15px;
  width: 100%;
  transition: all 0.2s ease;
  height: 42px;
}
.modal__panel textarea {
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 10px 12px;
  background: #fff;
  color: #0f172a;
  font-size: 15px;
  width: 100%;
  transition: all 0.2s ease;
  min-height: 120px;
  resize: vertical;
  line-height: 1.5;
  font-family: inherit;
}
.modal__panel input:focus,
.modal__panel select:focus,
.modal__panel textarea:focus {
  border-color: #003459;
  outline: none;
  box-shadow: 0 0 0 3px rgba(0,52,89,0.1);
}

/* === Ch·ªçn file === */
.modal__panel input[type=file] {
  background: none;
  border: none;
  padding: 4px 0;
  color: #003459;
}


/* ================================================= */
/* === ‚úÖ (M·ªöI) CSS CHO XEM TR∆Ø·ªöC ·∫¢NH & LOADING === */
/* ================================================= */
#image-preview-container {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.image-preview-wrapper {
  position: relative;
  width: 90px;
  height: 90px;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid #e2e8f0;
  background: #f8fafc;
}
.image-preview-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* === CSS N√∫t loading === */
.btn-primary.is-loading {
  cursor: not-allowed;
  opacity: 0.8;
}
.btn-primary.is-loading .fa-spinner {
  margin-left: 8px;
  /* Th√™m animation xoay */
  animation: spin 1s linear infinite;
}
/* ƒê·ªãnh nghƒ©a animation 'spin' */
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
/* ================================== */
/* === H·∫æT CSS M·ªöI === */
/* ================================== */
.post-menu-btn {
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: #64748b;
}
.post-menu-btn:hover { color: #003459; }

.post-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 30px;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,.1);
  padding: 8px;
  min-width: 140px;
  z-index: 99;
}
.post-menu button,
.post-menu a {
  display: block;
  text-align: left;
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 14px;
  border-radius: 8px;
  color: #0f172a;
}
.post-menu button:hover,
.post-menu a:hover {
  background: #f7f7f7;
}

.post-images {
  display: grid;
  gap: 4px;
  border-radius: 12px;
  overflow: hidden;
  margin-top: 15px;
  place-items: center;        /* D√≤ng n√†y s·∫Ω cƒÉn gi·ªØa m·ªçi tr∆∞·ªùng h·ª£p */
}
</style>
{% endblock %}

{% block content %}
<div class="post-list">
  <div id="btn-open-create" class="create-post-trigger">
    <div class="trigger-avatar">
      {% if request.user.userprofile.avatar_image %}
        <img src="{{ request.user.userprofile.avatar_image.url }}" alt="avatar">
      {% else %}
        {{ request.user.username|slice:":1"|upper }}
      {% endif %}
    </div>
    <div class="trigger-input">ƒê·∫∑t c√¢u h·ªèi cho c·ªông ƒë·ªìng‚Ä¶</div>
    <button class="btn-ghost" type="button"><i class="fa-regular fa-image"></i> ·∫¢nh</button>
    <button class="btn-primary" type="button">ƒêƒÉng</button>
  </div>

  <form method="get" class="search-wrap">
    <input name="q" value="{{ request.GET.q|default:'' }}" placeholder="T√¨m theo ti√™u ƒë·ªÅ/n·ªôi dung‚Ä¶">
    <select name="topic">
      <option value="">‚Äî T·∫•t c·∫£ ch·ªß ƒë·ªÅ ‚Äî</option>
      {% for value,label in all_topic_choices %}
        <option value="{{ value }}" {% if request.GET.topic == value %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
    <button class="btn-primary" type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
  </form>

  {% for post in posts %}
    {% reaction_of post request.user as me_react %}
    <article class="post-card" data-post="{{ post.post_id }}">
      <div class="user-info" style="display:flex;gap:10px;align-items:center;">
        <div class="avatar">
          {% if post.username.userprofile.avatar_image %}
            <img src="{{ post.username.userprofile.avatar_image.url }}" alt="avatar">
          {% else %}
            {{ post.username.username|slice:":1"|upper }}
          {% endif %}
        </div>
        <div>
            <div style="display:flex; align-items:center; gap:8px; font-weight:700; color:#003459;">
                {{ post.username.username }}

                {% if post.username.userprofile.display_badge %}
                    {% with badge=post.username.userprofile.display_badge %}
                    <span class="badge-chip badge-color-{{ badge.color }}">
                        {{ badge.icon }}
                        {{ badge.name }}
                    </span>
                    {% endwith %}
                {% endif %}
            </div>
            <small style="color:#64748b">{{ post.created_at|date:"d/m/Y H:i" }}</small>
        </div>
          {% if post.username == request.user %}
<div class="post-menu-wrapper" style="margin-left:auto; position:relative;">
  <button class="post-menu-btn" data-menu="{{ post.post_id }}">‚ãØ</button>

  <div class="post-menu" id="menu-{{ post.post_id }}">
    <button class="js-open-edit" data-post="{{ post.post_id }}">‚úèÔ∏è S·ª≠a</button>
    <a href="{% url 'forum:post_delete' post.post_id %}"
       onclick="return confirm('B·∫°n ch·∫Øc mu·ªën x√≥a b√†i n√†y?')">üóëÔ∏è X√≥a</a>
  </div>
</div>
{% endif %}

      </div>

      <h3 class="post-title">{{ post.title }}</h3>
      <div class="post-content">{{ post.content|linebreaksbr }}</div>

      {% if post.images.all %}
        {% with all_images=post.images.all %}
          {% with image_count=all_images|length %}
            {% if image_count == 1 %}
              {% with class_name="images-count-1" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% elif image_count == 2 %}
              {% with class_name="images-count-2" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% elif image_count == 3 %}
              {% with class_name="images-count-3" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% elif image_count == 4 %}
              {% with class_name="images-count-4" %}
                <div class="post-images {{ class_name }}">
                  {% for img in all_images %}
                  <div class="image-wrapper">
                    <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}
                </div>
              {% endwith %}
            {% else %}
              {% with class_name="images-count-more" %}
                <div class="post-images {{ class_name }}">

                  {% for img in all_images|slice:":4" %}
                  <div class="image-wrapper"
                       {% if forloop.last %}data-more-count="+{{ image_count|add:"-4" }}"{% endif %}>
                    <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
                  </div>
                  {% endfor %}

                  <div style="display:none;">
                    {% for img in all_images|slice:"4:" %}
                      <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                    {% endfor %}
                  </div>
                </div>
              {% endwith %}
            {% endif %}
          {% endwith %}
        {% endwith %}
      {% endif %}

      <div class="actions">
        <div class="vote-box" data-post="{{ post.post_id }}">
          <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote">
            <i class="fa-solid fa-arrow-up"></i>
          </button>
          <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
          <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote">
            <i class="fa-solid fa-arrow-down"></i>
          </button>
        </div>

        <a class="btn-ghost" href="{% url 'forum:post_detail' post.post_id %}">
          <i class="fa-regular fa-comment"></i> {{ post.comments.count }}
        </a>

        <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
          <i class="fa-solid fa-flag"></i> B√°o c√°o
        </button>
      </div>

      {% include "forum/_report_modal.html" with post=post %}
    </article>
  {% empty %}
    <p style="color:#64748b;text-align:center">Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</p>
  {% endfor %}
</div>

<div id="create-modal" class="modal">
  <div class="modal__panel">
    <div class="modal__head">
      <h3 style="margin:0;color:#003459">T·∫°o b√†i vi·∫øt m·ªõi</h3>
      <button class="close-x" data-close>&times;</button>
    </div>

    <form id="create-post-form" method="post" action="{% url 'forum:create_post' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div style="display:grid;gap:10px">
        <input class="form-control" name="title" placeholder="Ti√™u ƒë·ªÅ" required>

        <select class="form-control" name="topic" required>
          <option value="" disabled selected>‚Äî Ch·ªçn ch·ªß ƒë·ªÅ ‚Äî</option>

          {% for value,label in all_topic_choices %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}

        </select>
        <textarea class="form-control" name="content" rows="4" placeholder="Chia s·∫ª ƒëi·ªÅu g√¨ ƒë√≥‚Ä¶"></textarea>

        <input id="post-images-input" class="form-control" type="file" name="images" accept="image/*" multiple>

        <div id="image-preview-container"></div>

      </div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px">
        <button type="button" class="btn-ghost" data-close>H·ªßy</button>

        <button id="create-post-submit" type="submit" class="btn-primary">ƒêƒÉng</button>
      </div>
    </form>
  </div>
</div>
<div id="image-lightbox" class="lightbox">
  <span class="lightbox-close">√ó</span>
  <img class="lightbox-content" id="lightbox-img">

  <a class="lightbox-prev" id="lightbox-prev">&#10094;</a>
  <a class="lightbox-next" id="lightbox-next">&#10095;</a>
</div>
<div id="edit-post-modal" class="modal">
  <div class="modal__panel" style="max-width: 680px;">
    <div class="modal__head">
      <h3>Ch·ªânh s·ª≠a b√†i vi·∫øt</h3>
      <button class="close-x" data-close>&times;</button>
    </div>

    <form id="edit-post-form" method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <div style="display:grid; gap:12px;">
        <input type="text" id="edit-title" name="title" placeholder="Ti√™u ƒë·ªÅ" required>
        <select id="edit-topic" name="topic" required>
          <option value="" disabled>‚Äî Ch·ªçn ch·ªß ƒë·ªÅ ‚Äî</option>
          {% for value,label in all_topic_choices %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
        <textarea id="edit-content" name="content" rows="5" placeholder="N·ªôi dung..."></textarea>

        <!-- ·∫¢nh hi·ªán c√≥ -->
        <div>
        <div id="old-images" style="display:flex; flex-wrap:wrap; gap:8px;"></div>

        <!-- Th√™m ·∫£nh m·ªõi -->
        <input type="file" name="images" accept="image/*" multiple id="edit-images-input">
        <div id="edit-preview" style="display:flex;flex-wrap:wrap;gap:10px;margin-top:8px;"></div>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:16px;">
        <button type="button" class="btn-ghost" data-close>H·ªßy</button>
        <button type="submit" class="btn-primary is-loading-hide">
          <span class="text">L∆∞u thay ƒë·ªïi</span>
          <i class="fa-solid fa-spinner fa-spin" style="display:none"></i>
        </button>
      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){let v=null;if(document.cookie&&document.cookie!==''){const c=document.cookie.split(';');for(let i=0;i<c.length;i++){const s=c[i].trim();if(s.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(s.substring(name.length+1));break}}}return v}
const csrftoken=getCookie('csrftoken');

// === M·ªü modal t·∫°o b√†i ===
const modal=document.getElementById('create-modal');
document.getElementById('btn-open-create')?.addEventListener('click',()=>modal.style.display='flex');
modal?.addEventListener('click',e=>{if(e.target===modal||e.target.hasAttribute('data-close'))modal.style.display='none'});

// === Vote AJAX ===
document.querySelectorAll(".js-open-edit").forEach(btn => {
  btn.addEventListener("click", async () => {

    const postId = btn.dataset.post;
    const modal = document.getElementById("edit-post-modal");
    modal.style.display = "flex";

    const res = await fetch(`/forum/${postId}/edit-data/`);
    const data = await res.json();

    // ƒêi·ªÅn n·ªôi dung
    document.getElementById("edit-title").value = data.title;
    document.getElementById("edit-content").value = data.content;
    document.getElementById("edit-topic").value = data.topic;

    // Action c·ªßa form
document.getElementById("edit-post-form").action = `/forum/post/${postId}/edit/`;

    // Load ·∫£nh c≈©
    const oldBox = document.getElementById("old-images");
    oldBox.innerHTML = "";

    data.images.forEach(img => {
      oldBox.innerHTML += `
        <div style="position:relative; display:inline-block; margin:6px;">
          <img src="${img.url}" style="width:90px;height:90px;border-radius:8px;">
          <button class="remove-old-img"
                  data-id="${img.id}"
                  style="position:absolute;top:2px;right:2px;background:#fff;border:none;width:22px;height:22px;border-radius:50%;">‚úñ</button>
        </div>
      `;
    });
  });
});


// === Modal b√°o c√°o ===
document.addEventListener("click", (e) => {
  const btn = e.target.closest(".remove-old-img");
  if (!btn) return;

  const id = btn.dataset.id;

  const hidden = document.createElement("input");
  hidden.type = "hidden";
  hidden.name = "delete_images";
  hidden.value = id;

  document.getElementById("edit-post-form").appendChild(hidden);

  btn.parentElement.remove();
});

    // === X·ª≠ l√Ω g·ª≠i form b√°o c√°o b√†i vi·∫øt ===

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // === Lightbox ===
  let lightboxImages = [], currentImageIndex = 0;
  const lightbox = document.getElementById('image-lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const lightboxClose = document.querySelector('.lightbox-close');

  if (!lightbox || !lightboxImg || !lightboxPrev || !lightboxNext || !lightboxClose) {
    console.error("L·ªói: Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ Lightbox!");
    return;
  }
  const openLightbox = (postElement, src) => {
    lightboxImages = Array.from(postElement.querySelectorAll('.js-lightbox-trigger')).map(img => img.src);
    currentImageIndex = lightboxImages.indexOf(src);
    updateLightboxImage();
    lightbox.style.display = 'block';
    document.body.style.overflow = 'hidden';
  };
  const updateLightboxImage = () => {
    lightboxImg.src = lightboxImages[currentImageIndex];
    const show = lightboxImages.length > 1;
    lightboxPrev.style.display = show ? 'block' : 'none';
    lightboxNext.style.display = show ? 'block' : 'none';
  };
  const closeLightbox = () => {
    lightbox.style.display = 'none';
    document.body.style.overflow = 'auto';
  };
  const nextImage = () => { currentImageIndex = (currentImageIndex + 1) % lightboxImages.length; updateLightboxImage(); };
  const prevImage = () => { currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length; updateLightboxImage(); };
  lightboxNext.onclick = nextImage;
  lightboxPrev.onclick = prevImage;
  lightboxClose.onclick = closeLightbox;
  lightbox.onclick = e => { if (e.target === lightbox) closeLightbox(); };
  document.querySelectorAll('.js-lightbox-trigger').forEach(img => {
    img.addEventListener('click', (e) => {
      e.preventDefault();
      openLightbox(img.closest('.post-images'), img.src);
    });
  });
  document.querySelectorAll('.images-count-more .image-wrapper[data-more-count]').forEach(wrapper => {
      wrapper.addEventListener('click', (e) => {
          e.preventDefault();
          const firstImg = wrapper.parentElement.querySelector('.js-lightbox-trigger');
          if(firstImg) { openLightbox(wrapper.closest('.post-images'), firstImg.src); }
      });
  });
  document.addEventListener('keydown', (e) => {
    if (lightbox.style.display === 'block' && lightboxImages.length > 1) {
      if (e.key === 'ArrowRight') { nextImage(); }
      else if (e.key === 'ArrowLeft') { prevImage(); }
      else if (e.key === 'Escape') { closeLightbox(); }
    } else if (e.key === 'Escape') { closeLightbox(); }
  });
});
</script>

<script>
const textarea=document.querySelector('textarea[name="content"]');
if(textarea){
  textarea.style.resize='none';
  textarea.style.overflowY='hidden';
  const autoGrow=el=>{el.style.height='auto';el.style.height=(el.scrollHeight)+'px';};
  textarea.addEventListener('input',()=>autoGrow(textarea));
  autoGrow(textarea);
}
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // === 1. Hi·ªáu ·ª©ng loading khi ƒêƒÉng b√†i ===
  const postForm = document.getElementById('create-post-form');
  const submitButton = document.getElementById('create-post-submit');

  if (postForm && submitButton) {
    postForm.addEventListener('submit', () => {
      // Th√™m class 'is-loading'
      submitButton.classList.add('is-loading');

      // V√¥ hi·ªáu h√≥a n√∫t
      submitButton.disabled = true;

      // Thay ƒë·ªïi n·ªôi dung (nh·ªõ th√™m fa-spin ƒë·ªÉ n√≥ xoay)
      submitButton.innerHTML = 'ƒêang ƒëƒÉng <i class="fa-solid fa-spinner fa-spin"></i>';

      // Khi form submit (full page reload), n√∫t s·∫Ω t·ª± reset.
      // N·∫øu sau n√†y b·∫°n ƒë·ªïi sang AJAX, h√£y g·ª° b·ªè class/disabled khi AJAX ho√†n t·∫•t.
    });
  }

  // === 2. Xem tr∆∞·ªõc ·∫£nh khi upload ===
  const fileInput = document.getElementById('post-images-input');
  const previewContainer = document.getElementById('image-preview-container');

  if (fileInput && previewContainer) {
    fileInput.addEventListener('change', (event) => {
      // X√≥a c√°c ·∫£nh xem tr∆∞·ªõc c≈©
      previewContainer.innerHTML = '';

      const files = event.target.files;

      // Gi·ªõi h·∫°n 5 ·∫£nh
      if (files.length > 5) {
          alert("B·∫°n ch·ªâ c√≥ th·ªÉ t·∫£i l√™n t·ªëi ƒëa 5 ·∫£nh.");
          fileInput.value = ""; // X√≥a c√°c file ƒë√£ ch·ªçn
          return;
      }

      // L·∫∑p qua c√°c file v√† t·∫°o preview
      for (const file of files) {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();

          reader.onload = (e) => {
            const wrapper = document.createElement('div');
            wrapper.classList.add('image-preview-wrapper');

            const img = document.createElement('img');
            img.src = e.target.result;
            img.alt = file.name;

            wrapper.appendChild(img);
            previewContainer.appendChild(wrapper);
          };

          // ƒê·ªçc file
          reader.readAsDataURL(file);
        }
      }
    });
  }
});
</script>
<script>document.addEventListener("click", function(e){
  const btn = e.target.closest(".post-menu-btn");

  if (btn){
    const id = btn.dataset.menu;
    document.querySelectorAll(".post-menu").forEach(m=>m.style.display="none");
    document.getElementById("menu-"+id).style.display="block";
    return;
  }

  // Click b√™n ngo√†i -> ƒë√≥ng menu
  if (!e.target.closest(".post-menu")){
    document.querySelectorAll(".post-menu").forEach(m=>m.style.display="none");
  }
});
</script>
<script>document.addEventListener("DOMContentLoaded", () => {
    const editForm = document.getElementById("edit-post-form");
    const editCard = document.getElementById("edit-card");
    const postPreview = document.getElementById("post-preview");
    const previewTitle = document.getElementById("preview-title");
    const previewContent = document.getElementById("preview-content");
    const previewImages = document.getElementById("preview-images");

    // X·ª≠ l√Ω x√≥a ·∫£nh c≈© (t∆∞∆°ng t·ª± post_list)
    document.addEventListener("click", (e) => {
        const btn = e.target.closest(".remove-old-img");
        if (!btn) return;

        const id = btn.dataset.id;
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "delete_images";
        hidden.value = id;
        editForm.appendChild(hidden);

        btn.parentElement.remove();
    });

    // Xem tr∆∞·ªõc ·∫£nh m·ªõi (t∆∞∆°ng t·ª± post_list)
    const fileInput = editForm.querySelector('input[type="file"]');
    const previewContainer = document.getElementById("edit-preview");
    if (fileInput) {
        fileInput.addEventListener("change", (event) => {
            previewContainer.innerHTML = "";
            const files = event.target.files;
            if (files.length > 5) {
                alert("T·ªëi ƒëa 5 ·∫£nh.");
                fileInput.value = "";
                return;
            }
            for (const file of files) {
                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wrapper = document.createElement("div");
                        wrapper.classList.add("image-preview-wrapper");
                        wrapper.style = "width:90px;height:90px;border-radius:8px;overflow:hidden;border:1px solid #e2e8f0;";
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.style = "width:100%;height:100%;object-fit:cover;";
                        wrapper.appendChild(img);
                        previewContainer.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    }

    // Submit AJAX
    editForm.addEventListener("submit", async (e) => {
        e.preventDefault();



        const res = await fetch(editForm.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        });

        const data = await res.json();

        if (data.status === "ok") {
            // Sau khi th√™m ·∫£nh m·ªõi v√†o DOM
if (data.images && data.images.length > 0) {
    const newBox = document.createElement("div");
    const count = data.images.length;
    newBox.className = `post-images images-count-${count > 4 ? 'more' : count}`;

    newBox.innerHTML = data.images.map(url => `
        <div class="image-wrapper">
            <img src="${url}" class="js-lightbox-trigger" style="cursor:pointer;">
        </div>
    `).join("");

    // X√≥a box c≈© v√† th√™m box m·ªõi
    const oldBox = article.querySelector(".post-images");
    if (oldBox) oldBox.remove();
    article.querySelector(".actions").before(newBox);

    // G·∫Øn l·∫°i event lightbox cho ·∫£nh m·ªõi (v√¨ DOM m·ªõi t·∫°o)
    newBox.querySelectorAll('.js-lightbox-trigger').forEach(img => {
        img.addEventListener('click', (e) => {
            e.preventDefault();
            openLightbox(img.closest('.post-images'), img.src);
        });
    });
}
            // ·∫®n khung ch·ªânh s·ª≠a
            editCard.style.display = "none";

            // Hi·ªÉn th·ªã preview c·∫≠p nh·∫≠t
            previewTitle.textContent = data.title;
            previewContent.innerHTML = data.content.replace(/\n/g, "<br>");
            previewImages.innerHTML = data.images.map(url => `<img src="${url}">`).join("");
            postPreview.style.display = "block";

            // T√πy ch·ªçn: Redirect t·ª± ƒë·ªông sau 3s v·ªÅ my_profile
            // setTimeout(() => { window.location.href = "{% url 'profiles:my_profile' %}"; }, 3000);
        } else {
            alert("C√≥ l·ªói x·∫£y ra!");
        }
    });
});


</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    console.log("Script loaded!"); // Debug: Ki·ªÉm tra script ch·∫°y ch∆∞a

    const editForm = document.getElementById("edit-post-form");
    const editCard = document.getElementById("edit-card");
    const postPreview = document.getElementById("post-preview");
    const previewTitle = document.getElementById("preview-title");
    const previewContent = document.getElementById("preview-content");
    const previewImages = document.getElementById("preview-images");

    if (!editForm || !editCard || !postPreview) {
        console.error("L·ªói: Kh√¥ng t√¨m th·∫•y element form ho·∫∑c preview!");
        return;
    }

    // X·ª≠ l√Ω x√≥a ·∫£nh c≈©
    document.addEventListener("click", (e) => {
        const btn = e.target.closest(".remove-old-img");
        if (!btn) return;

        const id = btn.dataset.id;
        const hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "delete_images";
        hidden.value = id;
        editForm.appendChild(hidden);

        btn.parentElement.remove();
        console.log("·∫¢nh c≈© ID " + id + " ƒë√£ x√≥a kh·ªèi UI"); // Debug
    });

    // Xem tr∆∞·ªõc ·∫£nh m·ªõi
    const fileInput = document.getElementById("edit-images-input");
    const previewContainer = document.getElementById("edit-preview");
    if (fileInput) {
        fileInput.addEventListener("change", (event) => {
            previewContainer.innerHTML = "";
            const files = event.target.files;
            if (files.length > 5) {
                alert("T·ªëi ƒëa 5 ·∫£nh.");
                fileInput.value = "";
                return;
            }
            for (const file of files) {
                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const wrapper = document.createElement("div");
                        wrapper.classList.add("image-preview-wrapper");
                        wrapper.style = "width:90px;height:90px;border-radius:8px;overflow:hidden;border:1px solid #e2e8f0;";
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.style = "width:100%;height:100%;object-fit:cover;";
                        wrapper.appendChild(img);
                        previewContainer.appendChild(wrapper);
                    };
                    reader.readAsDataURL(file);
                }
            }
            console.log("ƒê√£ ch·ªçn " + files.length + " ·∫£nh m·ªõi"); // Debug
        });
    }

    // Submit AJAX
    editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log("Form submit intercepted! B·∫Øt ƒë·∫ßu AJAX..."); // Debug

        const formData = new FormData(editForm);

        try {
            const res = await fetch(editForm.action, {
                method: "POST",
                body: formData,
                headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            if (!res.ok) {
                throw new Error("Response not OK: " + res.status);
            }

            const data = await res.json();
            console.log("Response data:", data); // Debug: Xem JSON tr·∫£ v·ªÅ

            if (data.status === "ok") {
                // ·∫®n form
                editCard.style.display = "none";
                console.log("·∫®n edit-card th√†nh c√¥ng"); // Debug

                // Hi·ªÉn th·ªã preview
                previewTitle.textContent = data.title;
                previewContent.innerHTML = data.content.replace(/\n/g, "<br>");
                previewImages.innerHTML = data.images.map(url => `<img src="${url}">`).join("");
                postPreview.style.display = "block";
                console.log("Hi·ªán preview th√†nh c√¥ng"); // Debug

                // Optional: Redirect sau 3s
                // setTimeout(() => { window.location.href = "{% url 'profiles:my_profile' %}"; }, 3000);
            } else {
                alert("C√≥ l·ªói t·ª´ server: " + (data.error || "Kh√¥ng r√µ"));
            }
        } catch (error) {
            console.error("L·ªói AJAX:", error);
            alert("C√≥ l·ªói khi submit: " + error.message);
        }
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let currentPostId = null;
  const editModal = document.getElementById("edit-post-modal");
  const editForm = document.getElementById("edit-post-form");
  const oldImages = document.getElementById("old-images");
  const editPreview = document.getElementById("edit-preview");
  const submitBtn = editForm.querySelector(".btn-primary");
  const submitText = submitBtn.querySelector(".text");
  const spinner = submitBtn.querySelector("i");

  // === M·ªû MODAL CH·ªàNH S·ª¨A ===
  document.querySelectorAll(".js-open-edit").forEach(btn => {
    btn.addEventListener("click", async () => {
      currentPostId = btn.dataset.post;
      const res = await fetch(`/forum/${currentPostId}/edit-data/`);
      const data = await res.json();

      document.getElementById("edit-title").value = data.title;
      document.getElementById("edit-content").value = data.content;
      document.getElementById("edit-topic").value = data.topic;
      editForm.action = `/forum/post/${currentPostId}/edit/`;

      // Load ·∫£nh c≈©
      oldImages.innerHTML = "";
      data.images.forEach(img => {
        oldImages.innerHTML += `
          <div style="position:relative;display:inline-block;margin:4px;">
            <img src="${img.url}" style="width:90px;height:90px;object-fit:cover;border-radius:8px;">
            <button type="button" class="remove-old-img" data-id="${img.id}"
              style="position:absolute;top:2px;right:2px;background:rgba(0,0,0,0.6);color:white;border:none;border-radius:50%;width:24px;height:24px;font-size:12px;">√ó</button>
          </div>`;
      });

      editPreview.innerHTML = "";
      editModal.style.display = "flex";
    });
  });

  // === ƒê√ìNG MODAL ===
  editModal.addEventListener("click", e => {
    if (e.target === editModal || e.target.hasAttribute("data-close")) {
      editModal.style.display = "none";
    }
  });

  // === X√ìA ·∫¢NH C≈® ===
  oldImages.addEventListener("click", e => {
    const btn = e.target.closest(".remove-old-img");
    if (!btn) return;
    const hidden = document.createElement("input");
    hidden.type = "hidden"; hidden.name = "delete_images"; hidden.value = btn.dataset.id;
    editForm.appendChild(hidden);
    btn.parentElement.remove();
  });

  // === XEM TR∆Ø·ªöC ·∫¢NH M·ªöI ===
  document.getElementById("edit-images-input").addEventListener("change", e => {
    editPreview.innerHTML = "";
    const files = e.target.files;
    if (files.length > 5) { alert("T·ªëi ƒëa 5 ·∫£nh!"); e.target.value = ""; return; }
    [...files].forEach(file => {
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = ev => {
          const wrapper = document.createElement("div");
          wrapper.className = "image-preview-wrapper";
          const img = document.createElement("img");
          img.src = ev.target.result;
          wrapper.appendChild(img);
          editPreview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      }
    });
  });

  // === SUBMIT CH·ªàNH S·ª¨A (AJAX) ===
  editForm.addEventListener("submit", async e => {
    e.preventDefault();
    submitText.style.display = "none";
    spinner.style.display = "inline-block";
    submitBtn.disabled = true;

    // === FIX BUG: TH√äM 1 ·∫¢NH HI·ªÜN 2 + ·∫¢NH C≈® H·ªíI SINH ===
const formData = new FormData();

// 1. C√°c field text b√¨nh th∆∞·ªùng
formData.append('title', document.getElementById('edit-title').value);
formData.append('content', document.getElementById('edit-content').value);
formData.append('topic', document.getElementById('edit-topic').value);

// 2. CSRF
formData.append('csrfmiddlewaretoken', csrftoken);

// 3. Ch·ªâ l·∫•y ·∫£nh M·ªöI t·ª´ input file (kh√¥ng l·∫•y file c≈© c√≤n s√≥t)
const newImageFiles = document.getElementById('edit-images-input').files;
for (let i = 0; i < newImageFiles.length; i++) {
  formData.append('images', newImageFiles[i]);
}

// 4. ·∫¢nh c·∫ßn x√≥a (t·ª´ c√°c hidden input b·∫°n t·∫°o khi b·∫•m √ó)
document.querySelectorAll('input[name="delete_images"]').forEach(input => {
  formData.append('delete_images', input.value);
});
    try {
      const res = await fetch(editForm.action, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await res.json();

      if (data.status === "ok") {
        editModal.style.display = "none";

        const article = document.querySelector(`article[data-post="${currentPostId}"]`);
        article.querySelector(".post-title").textContent = data.title;
        article.querySelector(".post-content").innerHTML = data.content.replace(/\n/g, "<br>");

        // X√≥a ·∫£nh c≈©
        const oldBox = article.querySelector(".post-images");
        if (oldBox) oldBox.remove();

        // Th√™m ·∫£nh m·ªõi (v√† quan tr·ªçng: g·∫Øn l·∫°i lightbox!)
        if (data.images.length > 0) {
          const count = data.images.length;
          const newBox = document.createElement("div");
          newBox.className = `post-images images-count-${count > 4 ? "more" : count}`;

          newBox.innerHTML = data.images.map(url => `
            <div class="image-wrapper">
              <img src="${url}" class="js-lightbox-trigger" style="cursor:pointer;">
            </div>
          `).join("");

          article.querySelector(".actions").before(newBox);

          // ‚òÖ ƒêO·∫†N QUAN TR·ªåNG NH·∫§T: g·∫Øn l·∫°i s·ª± ki·ªán click cho ·∫£nh m·ªõi
          newBox.querySelectorAll(".js-lightbox-trigger").forEach(img => {
            img.addEventListener("click", ev => {
              ev.preventDefault();
              openLightbox(img.closest(".post-images"), img.src);
            });
          });

          // N·∫øu c√≥ "+3" th√¨ c≈©ng g·∫Øn lightbox
          const moreWrapper = newBox.querySelector("[data-more-count]");
          if (moreWrapper) {
            moreWrapper.addEventListener("click", () => {
              const firstImg = newBox.querySelector(".js-lightbox-trigger");
              if (firstImg) openLightbox(newBox, firstImg.src);
            });
          }
        }

        alert("ƒê√£ s·ª≠a b√†i vi·∫øt th√†nh c√¥ng!");
      } else {
        alert("L·ªói: " + JSON.stringify(data));
      }
    } catch (err) {
      alert("L·ªói m·∫°ng!");
    }
    finally {
  submitText.style.display = "";
  spinner.style.display = "none";
  submitBtn.disabled = false;

  // SI√äU QUAN TR·ªåNG: l√†m tr·ªëng input file ƒë·ªÉ l·∫ßn sau kh√¥ng b·ªã g·ª≠i ·∫£nh c≈©
  document.getElementById('edit-images-input').value = "";
}
  });
});

// === LIGHTBOX (gi·ªØ nguy√™n, ch·ªâ ƒë·ªÉ l·∫°i 1 l·∫ßn) ===
let lightboxImages = [], currentImageIndex = 0;
const lightbox = document.getElementById('image-lightbox');
const lightboxImg = document.getElementById('lightbox-img');
const lightboxPrev = document.getElementById('lightbox-prev');
const lightboxNext = document.getElementById('lightbox-next');
const lightboxClose = document.querySelector('.lightbox-close');

const openLightbox = (postElement, src) => {
  lightboxImages = Array.from(postElement.querySelectorAll('.js-lightbox-trigger')).map(img => img.src);
  currentImageIndex = lightboxImages.indexOf(src);
  updateLightboxImage();
  lightbox.style.display = 'block';
  document.body.style.overflow = 'hidden';
};
const updateLightboxImage = () => {
  lightboxImg.src = lightboxImages[currentImageIndex];
  lightboxPrev.style.display = lightboxImages.length > 1 ? 'block' : 'none';
  lightboxNext.style.display = lightboxImages.length > 1 ? 'block' : 'none';
};
const closeLightbox = () => {
  lightbox.style.display = 'none';
  document.body.style.overflow = 'auto';
};
const nextImage = () => {
  currentImageIndex = (currentImageIndex + 1) % lightboxImages.length;
  updateLightboxImage();
};

const prevImage = () => {
  currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length;
  updateLightboxImage();
};
lightboxNext.onclick = nextImage;
lightboxPrev.onclick = prevImage;
lightboxClose.onclick = closeLightbox;
lightbox.onclick = e => { if (e.target === lightbox) closeLightbox(); };
document.addEventListener('keydown', e => {
  if (lightbox.style.display === 'block') {
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
    if (e.key === 'Escape') closeLightbox();
  }
});
</script>
{% endblock %}