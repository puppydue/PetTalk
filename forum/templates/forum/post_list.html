{% extends "base.html" %}
{% load static %}

{% block title %}Di·ªÖn ƒë√†n PetTalk{% endblock %}

{% block extra_css %}
<style>
/* ... (T·∫•t c·∫£ CSS c≈© c·ªßa b·∫°n gi·ªØ nguy√™n) ... */

/* ====== CSS CHO N√öT K√çCH HO·∫†T POPUP ====== */
.create-post-trigger {
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 15px;
  cursor: pointer;
  transition: background 0.2s;
}
.create-post-trigger:hover {
  background: #fcfcfc;
}
.trigger-avatar {
  background: #003459;
  color: #fff;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
  flex-shrink: 0;
}
.trigger-text {
  flex-grow: 1;
  background: #f8fafc;
  border: 1px solid #e0e0e0;
  padding: 12px 16px;
  border-radius: 8px;
  color: #666;
}

/* ====== CSS CHO POPUP (MODAL) T·∫†O B√ÄI VI·∫æT ====== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: none;
  z-index: 1000;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

.modal-content {
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  width: 100%;
  max-width: 600px;
  position: relative;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #eee;
  padding-bottom: 12px;
  margin-bottom: 20px;
}
.modal-header h4 {
  font-size: 1.25rem;
  font-weight: 700;
  color: #003459;
  margin: 0;
}

.modal-close {
  font-size: 24px;
  color: #888;
  cursor: pointer;
  background: none;
  border: none;
  line-height: 1;
}
.modal-close:hover {
  color: #000;
}

/* CSS cho form b√™n trong popup */
.modal-form .form-group {
  margin-bottom: 16px;
}
.modal-form .form-label {
  display: block;
  font-weight: 600;
  color: #333;
  margin-bottom: 6px;
}

/* ======== CSS N√ÄY S·∫º S·ª¨A L·ªñI STYLE C·ª¶A B·∫†N ======== */
.modal-form .form-control {
  width: 100%; /* ƒê·∫£m b·∫£o full-width */
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 15px;
  outline: none;
  background: #fff; /* ƒê·∫£m b·∫£o n·ªÅn tr·∫Øng */
  -webkit-appearance: none; /* S·ª≠a l·ªói style tr√™n iOS */
  -moz-appearance: none;
  appearance: none;
}
.modal-form .form-control:focus {
  border-color: #003459;
  box-shadow: 0 0 0 2px rgba(0, 52, 89, 0.1);
}
.modal-form .form-textarea {
  min-height: 120px;
  resize: vertical;
}
.modal-form .image-upload-input {
  display: none;
}
/* ======== H·∫æT PH·∫¶N CSS S·ª¨A ======== */

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}

/* ... (To√†n b·ªô CSS c≈© cho post-list, post-card, ... gi·ªØ nguy√™n) ... */

/* ====== DANH S√ÅCH B√ÄI VI·∫æT (C·ªòT GI·ªÆA) ====== */
.post-list {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  padding: 20px 0;
  max-width: 800px;
  margin: 0 auto;
}
.search-form {
  display: flex;
  width: 100%;
}
.search-input {
  flex-grow: 1;
  border: 2px solid #e0e0e0;
  padding: 12px 16px;
  font-size: 15px;
  border-radius: 10px 0 0 10px;
  border-right: none;
  outline: none;
  transition: border-color 0.2s;
  background: #fff;
}
.search-input:focus {
  border-color: #003459;
}
.search-button {
  border: 2px solid #003459;
  background: #003459;
  color: #fff;
  padding: 0 18px;
  border-radius: 0 10px 10px 0;
  cursor: pointer;
  font-size: 16px;
  transition: background 0.2s;
}

/* ... (T·∫•t c·∫£ CSS c≈© kh√°c gi·ªØ nguy√™n) ... */
.post-card {
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  border-left: 6px solid #003459;
  transition: all 0.3s ease;
}
.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}
.avatar {
  background: #003459;
  color: #fff;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 16px;
}
.user-meta {
  display: flex;
  flex-direction: column;
  line-height: 1.3;
}
.username {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 700;
  color: #003459;
}
.badge {
  background: linear-gradient(90deg, #f7dba7, #fff2cc);
  color: #7c3b00;
  padding: 3px 8px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: 600;
}
.post-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-top: 5px;
  color: #222;
}
.post-content {
  margin-top: 10px;
  line-height: 1.5;
  color: #333;
}
.post-images {
  margin-top: 12px;
  display: flex;
  gap: 10px;
}
.post-images img {
  width: 130px;
  height: 130px;
  border-radius: 12px;
  object-fit: cover;
  border: 2px solid #eee;
}
.actions {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 14px;
}
.vote-btn {
  border: 1px solid #cbd5e1;
  background: #f8fafc;
  color: #003459;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  justify-content: center;
  align-items: center;
}
.vote-btn:hover {
  background: #f7dba7;
  border-color: #f7dba7;
}
.vote-count {
  font-weight: 600;
  color: #003459;
  font-size: 15px;
  min-width: 28px;
  text-align: center;
}
.btn-report {
  background: #fff;
  color: #ef4444;
  border: 1px solid #ef4444;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}
.comment-form {
  margin-top: 10px;
  display: none;
}
.comment-form textarea {
  width: 100%;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  font-size: 14px;
  resize: none;
}
.comment-form button {
  margin-top: 8px;
  padding: 6px 14px;
  border-radius: 6px;
  border: none;
  background: #003459;
  color: #fff;
  cursor: pointer;
}
.comment-box {
  margin-top: 8px;
  background: #f9f9f9;
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 14px;
}
.comment-box strong {
  color: #003459;
}
.right-panel-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
  padding: 20px 0;
}
.panel {
  background: #fff;
  border: 1px solid #f2e3b3;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.panel h4 {
  font-weight: 700;
  color: #003459;
  margin-bottom: 10px;
}
.panel .chip {
  background: #fff;
  border: 1px solid #f2e3b3;
  border-radius: 999px;
  padding: 6px 12px;
  color: #003459;
  font-size: 13px;
  margin: 4px;
  display: inline-block;
  cursor: pointer;
  transition: 0.2s;
}
.vote-btn.with-count {
  width: auto;
  padding: 0 12px;
  gap: 8px;
}
.comment-count-inside {
  font-weight: 600;
  font-size: 15px;
  color: #003459;
}
.vote-btn.active {
  background: #f7dba7;
  border-color: #f7dba7;
  color: #7c3b00;
}
.vote-btn.active:hover {
    opacity: 0.8;
}
.btn-primary {
  background: #003459;
  color: #fff;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.btn-primary:hover {
  background: #005086;
}
.btn-secondary {
  background: #fff;
  color: #003459;
  border: 1px solid #003459;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.btn-secondary:hover {
  background: #f0f0f9;
}
</style>
{% endblock %}


{% block content %}
<div class="post-list">

  <!-- ======== TRIGGER M·ªû POPUP ======== -->
  <div class="create-post-trigger" id="open-post-modal">
    <div class="trigger-avatar">
      {{ request.user.username|slice:":1"|upper }}
    </div>
    <div class="trigger-text">
      ƒê·∫∑t c√¢u h·ªèi cho c·ªông ƒë·ªìng...
    </div>
    <button type="button" class="btn-secondary" style="pointer-events: none;">·∫¢nh</button>
    <button type="button" class="btn-primary" style="pointer-events: none;">ƒêƒÉng</button>
  </div>
  <!-- ======== H·∫æT TRIGGER ======== -->

  <!-- ... (Thanh t√¨m ki·∫øm) ... -->
  <div class="search-bar-container">
    <form action="" method="GET" class="search-form">
      <input type="text" name="q" placeholder="T√¨m ki·∫øm b√†i vi·∫øt theo ti√™u ƒë·ªÅ..." class="search-input" value="{{ request.GET.q | default:'' }}">
      <button type="submit" class="search-button">
        <i class="fa-solid fa-search"></i>
      </button>
    </form>
  </div>

  <h2 style="margin-bottom: 10px; color:#003459;">üêæ B√†i vi·∫øt n·ªïi b·∫≠t tr√™n PetTalk</h2>

  <!-- ... (V√≤ng l·∫∑p for post in posts) ... -->
  {% for post in posts %}
  <div class="post-card">
    <div class="user-info">
      <div class="avatar">{{ post.username.username|slice:":1"|upper }}</div>
      <div class="user-meta">
        <div class="username">
          {{ post.username.username }}
          <span class="badge">C·ªông t√°c vi√™n Spa</span>
        </div>
        <div class="meta">{{ post.created_at|date:"d/m/Y H:i" }}</div>
      </div>
    </div>
    <div class="post-title">{{ post.title }}</div>
    <div class="post-content">{{ post.content }}</div>

    {% if post.images.all %}
    <div class="post-images">
      {% for img in post.images.all %}
        <img src="{{ img.image.url }}" alt="·∫¢nh b√†i vi·∫øt">
      {% endfor %}
    </div>
    {% endif %}

    <div class="actions">
      <button class="vote-btn up"><i class="fa-solid fa-arrow-up"></i></button>
      <span class="vote-count">{{ post.total_votes | default:0 }}</span>
      <button class="vote-btn down"><i class="fa-solid fa-arrow-down"></i></button>
      <button class="vote-btn comment-btn with-count">
        <i class="fa-regular fa-comment"></i>
        <span class="comment-count-inside">{{ post.comments.all|length }}</span>
      </button>
      <button class="btn-report"><i class="fa-solid fa-flag"></i> B√°o c√°o</button>
    </div>

    <div class="comment-form">
      <textarea placeholder="Vi·∫øt b√¨nh lu·∫≠n..."></textarea>
      <button type="button" class="btn-submit-comment">ƒêƒÉng</button>
    </div>

    <div class="comment-list-container" style="margin-top:10px;">
      {% if post.comments.all %}
        {% for cmt in post.comments.all %}
        <div class="comment-box">
          <strong>{{ cmt.username.username }}</strong>: {{ cmt.content }}
        </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
  {% empty %}
  <p>Ch∆∞a c√≥ b√†i vi·∫øt n√†o ƒë∆∞·ª£c ƒëƒÉng.</p>
  {% endfor %}

</div> <!-- K·∫øt th√∫c .post-list -->


<!-- ======== HTML C·ª¶A POPUP (MODAL) T·∫†O B√ÄI VI·∫æT ======== -->
<div class="modal-overlay" id="create-post-modal" style="display: none;">
  <div class="modal-content">

    <div class="modal-header">
      <h4>T·∫°o b√†i vi·∫øt m·ªõi</h4>
      <button class="modal-close" id="close-post-modal">&times;</button>
    </div>

    <form class="modal-form" method="POST" action="" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- ======== S·ª¨A L·ªñI STYLE: Th√™m class="form-control" ======== -->
      <div class="form-group">
        <label for="post-title" class="form-label">Ti√™u ƒë·ªÅ</label>
        <input type="text" name="title" id="post-title" class="form-control" required>
      </div>

      <!-- ======== S·ª¨A L·ªñI STYLE: Th√™m class="form-control" ======== -->
      <div class="form-group">
        <label for="post-topic" class="form-label">Ch·ªß ƒë·ªÅ</label>
        <select name="topic" id="post-topic" class="form-control" required>
          <!--
            V√≤ng l·∫∑p n√†y S·∫º HI·ªÇN TH·ªä CH·ª¶ ƒê·ªÄ
            n·∫øu b·∫°n l√†m ƒë√∫ng B∆∞·ªõc 2 (s·ª≠a views.py)
          -->
          <option value="" disabled selected>-- Ch·ªçn ch·ªß ƒë·ªÅ --</option> <!-- Th√™m d√≤ng placeholder -->
          {% for value, label in topic_choices %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- ======== S·ª¨A L·ªñI STYLE: Th√™m class="form-control" ======== -->
      <div class="form-group">
        <label for="post-content" class="form-label">N·ªôi dung</label>
        <textarea name="content" id="post-content" class="form-control form-textarea"></textarea>
      </div>

      <input type="file" name="image" class="image-upload-input" id="modal-image-upload" accept="image/*">

      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="modal-btn-add-image">
          <i class="fa-regular fa-image"></i> ·∫¢nh
        </button>
        <button type="submit" class="btn-primary">ƒêƒÉng</button>
      </div>
    </form>
  </div>
</div>
<!-- ======== H·∫æT HTML C·ª¶A POPUP ======== -->

{% endblock %}
{% block right %}

<div class="right-panel-content">

  <div class="panel">

    <h4>üî• Ch·ªß ƒë·ªÅ n·ªïi b·∫≠t</h4>

    <div class="chip">Hu·∫•n luy·ªán</div>

    <div class="chip">ChƒÉm s√≥c</div>

    <div class="chip">Dinh d∆∞·ª°ng</div>

    <div class="chip">C·∫•p c·ª©u</div>

  </div>



  <div class="panel">

    <h4>üìÖ S·ª± ki·ªán s·∫Øp di·ªÖn ra</h4>

    <div class="event">

      <strong>Workshop Grooming</strong>

      <small>11/11/2025</small>

    </div>

    <div class="event">

      <strong>Pet Adoption Day</strong>

      <small>25/11/2025</small>

    </div>

  </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
// L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·ªßa modal
const postModal = document.getElementById('create-post-modal');
const openModalBtn = document.getElementById('open-post-modal');
const closeModalBtn = document.getElementById('close-post-modal');

// --- 1. LOGIC M·ªöI: M·ªû POPUP ---
if (openModalBtn) {
  openModalBtn.addEventListener('click', () => {
    postModal.style.display = 'flex';
  });
}

// --- 2. LOGIC M·ªöI: ƒê√ìNG POPUP (B·∫∞NG N√öT X) ---
if (closeModalBtn) {
  closeModalBtn.addEventListener('click', () => {
    postModal.style.display = 'none';
  });
}

// --- 3. LOGIC M·ªöI: ƒê√ìNG POPUP (B·∫∞NG C√ÅCH B·∫§M RA NGO√ÄI) ---
if (postModal) {
  postModal.addEventListener('click', e => {
    if (e.target.classList.contains('modal-overlay')) {
      postModal.style.display = 'none';
    }
  });
}


// --- 4. LOGIC CHUNG (D√ôNG event delegation) ---
document.addEventListener("click", e => {

  // --- 4a. X·ª¨ L√ù HI·ªÜN/·∫®N FORM B√åNH LU·∫¨N ---
  const commentBtn = e.target.closest(".comment-btn");
  if (commentBtn) {
    const postCard = commentBtn.closest(".post-card");
    if (postCard) {
      const form = postCard.querySelector(".comment-form");
      if (form) {
        form.style.display = form.style.display === "block" ? "none" : "block";
      }
    }
  }

  // --- 4b. X·ª¨ L√ù VOTE (LOGIC 1 S·ªê DUY NH·∫§T) ---
  const voteBtn = e.target.closest(".vote-btn.up, .vote-btn.down");
  if (voteBtn) {
    const actions = voteBtn.closest('.actions');
    const upBtn = actions.querySelector('.vote-btn.up');
    const downBtn = actions.querySelector('.vote-btn.down');
    const countSpan = actions.querySelector('.vote-count');
    let currentCount = parseInt(countSpan.textContent);
    const isUpvote = voteBtn.classList.contains('up');
    const upActive = upBtn.classList.contains('active');
    const downActive = downBtn.classList.contains('active');

    if (isUpvote) {
      if (upActive) {
        upBtn.classList.remove('active');
        countSpan.textContent = currentCount - 1;
      } else {
        upBtn.classList.add('active');
        let newCount = currentCount + 1;
        if (downActive) {
          downBtn.classList.remove('active');
          newCount = newCount + 1;
        }
        countSpan.textContent = newCount;
      }
    } else {
      if (downActive) {
        downBtn.classList.remove('active');
        countSpan.textContent = currentCount + 1;
      } else {
        downBtn.classList.add('active');
        let newCount = currentCount - 1;
        if (upActive) {
          upBtn.classList.remove('active');
          newCount = newCount - 1;
        }
        countSpan.textContent = newCount;
      }
    }
  }

  // --- 4c. X·ª¨ L√ù ƒêƒÇNG B√åNH LU·∫¨N (HI·ªÇN TH·ªä NGAY) ---
  const submitCommentBtn = e.target.closest(".btn-submit-comment");
  if (submitCommentBtn) {
    const postCard = submitCommentBtn.closest(".post-card");
    const commentForm = submitCommentBtn.closest(".comment-form");
    const textarea = commentForm.querySelector("textarea");
    const content = textarea.value.trim();
    if (content === "") return;

    const container = postCard.querySelector(".comment-list-container");
    const newComment = document.createElement('div');
    newComment.className = 'comment-box';
    // Gi·∫£ s·ª≠ t√™n user l√† "Minh Nguyen" (b·∫°n c·∫ßn thay b·∫±ng logic user th·∫≠t)
    newComment.innerHTML = `<strong>Minh Nguyen</strong>: ${content}`;
    container.appendChild(newComment);
    textarea.value = "";
    commentForm.style.display = "none";
  }

  // --- 4d. LOGIC M·ªöI: X·ª¨ L√ù N√öT "·∫¢NH" (TRONG POPUP) ---
  const addImageBtn = e.target.closest("#modal-btn-add-image");
  if (addImageBtn) {
    document.getElementById('modal-image-upload').click();
  }

});
</script>
{% endblock %}

