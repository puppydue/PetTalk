{% extends "base.html" %}
{% load static %}
{% load forum_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
<style>
/* ================================================= */
/* 1. STYLE BÁO CÁO (REPORT) - ĐỒNG BỘ VỚI LIST     */
/* ================================================= */
.report-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 15px;
}
.report-radio-label {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  color: #334155;
  font-weight: 500;
}
.report-radio-label:hover {
  background: #f8fafc;
  border-color: #cbd5e1;
}
.report-radio-label input[type="radio"] {
  margin-right: 12px;
  width: 18px;
  height: 18px;
  accent-color: #003459;
}
.report-radio-label:has(input:checked) {
  background: #f0f9ff;
  border-color: #003459;
  color: #003459;
  font-weight: 600;
}

/* ================================================= */
/* 2. MENU & UI ELEMENTS CƠ BẢN                     */
/* ================================================= */
.comment-menu { display: none; position: absolute; right: 0; top: 100%; margin-top: 6px; background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.1); min-width: 160px; z-index: 20; overflow: hidden; font-size: 14px; }
.comment-menu .menu-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 14px; background: none; border: none; text-align: left; cursor: pointer; color: #334155; transition: background 0.2s; }
.comment-menu .menu-item i { width: 16px; text-align: center; color: #64748b; }
.comment-menu .menu-item:hover { background-color: #f8fafc; }
.comment-menu .menu-item.danger:hover { background-color: #fef2f2; color: #dc2626; }
.comment-menu .menu-item.danger:hover i { color: #dc2626; }
.comment-menu-btn { background: none; border: none; font-size: 16px; color: #94a3b8; cursor: pointer; padding: 4px 8px; border-radius: 50%; transition: all 0.2s; }
.comment-menu-btn:hover { background-color: #f1f5f9; color: #003459; }

.avatar { width: 40px; height: 40px; border-radius: 9999px; background: #003459; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; overflow: hidden; flex-shrink: 0; }
.avatar img { width: 100%; height: 100%; object-fit: cover; }
.avatar.sm { width: 32px; height: 32px; font-size: 12px; }

.badge-chip { display: inline-flex; align-items: center; gap: 4px; padding: 2px 6px; font-size: 11px; font-weight: 600; border-radius: 8px; border: 1px solid; cursor: default; white-space: nowrap; }
.badge-color-gold { background: #fff4c2; border-color: #f7d98b; color: #8a5a00; }
.badge-color-blue { background: #e0f2fe; border-color: #7dd3fc; color: #0369a1; }
.badge-color-green { background: #dcfce7; border-color: #86efac; color: #15803d; }
.badge-color-red { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
.badge-color-cyan { background: #cffafe; border-color: #67e8f9; color: #0e7490; }
.badge-color-lime { background: #f7fee7; border-color: #bef264; color: #4d7c0f; }

/* ================================================= */
/* 3. COMMENT STYLE MỚI (THREADED)                  */
/* ================================================= */
.comment-tree {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* Container của 1 comment (bao gồm cả replies con) */
.comment-node {
  position: relative;
}

/* Flex chứa Avatar + Nội dung chính */
.comment-main {
  display: flex;
  gap: 12px;
  align-items: flex-start;
}

/* Cột Avatar bên trái */
.comment-left {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Phần nội dung bên phải (Bubble) */
.comment-right {
  flex: 1;
  max-width: 100%;
}

/* Cái bong bóng nội dung */
.comment-bubble {
  background: #f8fafc;
  border: 1px solid #f1f5f9;
  border-radius: 12px;
  padding: 10px 14px;
  position: relative;
  transition: all 0.2s;
}
.comment-bubble:hover {
  background: #fff;
  border-color: #cbd5e1;
  box-shadow: 0 2px 8px rgba(0,0,0,0.03);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 4px;
}

.comment-author-name {
  font-weight: 700;
  color: #0f172a;
  font-size: 14px;
  text-decoration: none;
  margin-right: 6px;
}
.comment-time {
  font-size: 12px;
  color: #94a3b8;
  margin-left: 6px;
  font-weight: 400;
}
.comment-content {
  color: #334155;
  font-size: 14.5px;
  line-height: 1.5;
  word-break: break-word;
  white-space: pre-wrap;
}

/* Thanh hành động bên dưới (Reply/Like) */
.comment-actions-bar {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-top: 6px;
  margin-left: 4px;
}

.action-link {
  font-size: 13px;
  font-weight: 600;
  color: #64748b;
  cursor: pointer;
  background: none;
  border: none;
  padding: 0;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: color 0.2s;
}
.action-link:hover { color: #003459; }
.action-link i { font-size: 12px; }

/* Container chứa các comment con (Reply) */
.replies-container {
  margin-left: 20px; /* Thụt vào so với avatar cha */
  padding-left: 16px; /* Khoảng cách với đường kẻ */
  border-left: 2px solid #e2e8f0; /* Đường kẻ dọc */
  margin-top: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Form phản hồi/chỉnh sửa */
.reply-form-container, .edit-form-container {
  margin-top: 10px;
  animation: fadeIn 0.3s ease;
}
.reply-form textarea, .edit-form textarea {
  width: 100%;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  padding: 10px;
  font-family: inherit;
  font-size: 14px;
  resize: none;
  min-height: 80px;
}
.reply-form textarea:focus {
  outline: none;
  border-color: #003459;
  box-shadow: 0 0 0 3px rgba(0,52,89,0.1);
}

/* ================================================= */
/* 4. POST CARD & IMAGES (ĐỒNG BỘ LIST)             */
/* ================================================= */
.post-card {
  max-width: 780px;
  margin: 0 auto;
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.06);
}

.post-images { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; margin-top: 20px; }
.image-wrapper { position: relative; width: 100%; height: 100%; background: #f8fafc; }
.post-images img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
.post-images img:hover { transform: scale(1.03); }

/* Đồng bộ logic hiển thị ảnh với List */
.images-count-1 { display: flex; justify-content: center; align-items: center; padding: 10px; background: #f8fafc; border-radius: 12px; }
.images-count-1 .image-wrapper { width: 100%; height: auto; position: relative; }
.images-count-1 img { position: relative !important; width: 100%; height: auto; max-height: 500px; object-fit: contain; }

.images-count-2 { grid-template-columns: 1fr 1fr; height: 320px; }
.images-count-3 { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; height: 420px; }
.images-count-3 .image-wrapper:first-child { grid-row: span 2; }
.images-count-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 420px; }
.images-count-more { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 420px; }
.images-count-more .image-wrapper:nth-child(n+5) { display: none; }
.images-count-more .image-wrapper[data-more-count]::after { content: attr(data-more-count); position: absolute; inset: 0; background: rgba(15,23,42,0.6); color: white; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: 800; }

/* Vote & Action buttons */
.actions { display: flex; align-items: center; gap: 12px; margin-top: 16px; }
.vote-btn { width: 40px; height: 40px; border-radius: 10px; border: 1px solid #cbd5e1; background: #fff; color: #64748b; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: all 0.2s; }
.vote-btn:hover { background: #f1f5f9; color: #003459; }
.vote-count { font-weight: 700; font-size: 16px; min-width: 30px; text-align: center; color: #0f172a; }
.vote-btn.active-up { background: #ff4500; color: #fff; border-color: #ff4500; }
.vote-btn.active-down { background: #6a5cff; color: #fff; border-color: #6a5cff; }

.btn-ghost { border: 1px solid #cbd5e1; color: #475569; background: #fff; padding: 8px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; height: 40px; }
.btn-ghost:hover { background: #f8fafc; border-color: #94a3b8; color: #0f172a; }
.btn-primary { border: none; color: #fff; background: #003459; padding: 8px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background 0.2s; height: 40px; }
.btn-primary:hover { background: #004475; }

/* Lightbox */
.lightbox { position: fixed; z-index: 9990; padding-top: 50px; inset: 0; overflow: auto; background-color: rgba(0,0,0,0.95); display: none; animation: fadeIn 0.2s ease; }
.lightbox-content { margin: auto; display: block; max-width: 95%; max-height: 90vh; object-fit: contain; animation: zoom 0.3s ease; }
.lightbox-close { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; opacity: 0.8; }
.lightbox-close:hover { opacity: 1; }
.lightbox-prev, .lightbox-next { cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%); padding: 20px; color: white; font-weight: bold; font-size: 30px; user-select: none; background: rgba(0,0,0,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
.lightbox-next { right: 20px; } .lightbox-prev { left: 20px; }
.lightbox-prev:hover, .lightbox-next:hover { background-color: rgba(255,255,255,0.2); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoom { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
.hidden { display: none; }
</style>
{% endblock %}

{% block title %}Bài viết • {{ post.title }}{% endblock %}

{% block content %}
{% reaction_of post request.user as me_react %}

<article class="post-card">
  <!-- Header bài viết -->
  <div class="user-info" style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
    <div class="avatar">
      {% if post.username.userprofile.avatar_image %}
        <img src="{{ post.username.userprofile.avatar_image.url }}" alt="avatar">
      {% else %}
        {{ post.username.username|slice:":1"|upper }}
      {% endif %}
    </div>
    <div style="display:flex;flex-direction:column;">
      <div style="display:flex; align-items:center; gap:8px; font-weight:700; color:#0f172a; font-size:16px;">
        <a href="{% url 'profiles:view_user_profile' post.username.username %}" style="color:inherit;text-decoration:none;">
          {{ post.username.username }}
        </a>
        {% if post.username.userprofile.display_badge %}
            {% with badge=post.username.userprofile.display_badge %}
            <span class="badge-chip badge-color-{{ badge.color }}">{{ badge.icon }} {{ badge.name }}</span>
            {% endwith %}
        {% endif %}
      </div>
      <small style="color:#64748b;font-size:13px;">{{ post.created_at|date:"d/m/Y • H:i" }}</small>
    </div>
  </div>

  <h1 class="post-title" style="font-size:24px; margin:0 0 12px; color:#0f172a; line-height:1.3;">{{ post.title }}</h1>
  <div class="post-content" style="line-height:1.7; color:#334155; font-size:16px;">{{ post.content|linebreaksbr }}</div>

  <!-- Ảnh bài viết (Đồng bộ scale với List) -->
  {% if post.images.all %}
    {% with all_images=post.images.all %}
      {% with image_count=all_images|length %}
        {% if image_count == 1 %}
          {% with class_name="images-count-1" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper"><img src="{{ img.image.url }}" class="js-lightbox-trigger"></div>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif image_count == 2 %}
          {% with class_name="images-count-2" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper"><img src="{{ img.image.url }}" class="js-lightbox-trigger"></div>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif image_count == 3 %}
          {% with class_name="images-count-3" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper"><img src="{{ img.image.url }}" class="js-lightbox-trigger"></div>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif image_count == 4 %}
          {% with class_name="images-count-4" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper"><img src="{{ img.image.url }}" class="js-lightbox-trigger"></div>
              {% endfor %}
            </div>
          {% endwith %}
        {% else %}
          {% with class_name="images-count-more" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images|slice:":4" %}
              <div class="image-wrapper" {% if forloop.last %}data-more-count="+{{ image_count|add:"-4" }}"{% endif %}>
                <img src="{{ img.image.url }}" class="js-lightbox-trigger">
              </div>
              {% endfor %}
              <div style="display:none;">
                {% for img in all_images|slice:"4:" %}
                  <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                {% endfor %}
              </div>
            </div>
          {% endwith %}
        {% endif %}
      {% endwith %}
    {% endwith %}
  {% endif %}

  <!-- Actions -->
  <div class="actions">
    <div class="vote-box" data-post="{{ post.post_id }}" style="display:flex;align-items:center;gap:8px;">
      <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
      <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
    </div>
    <div style="flex:1"></div> <!-- Spacer -->
    <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
      <i class="fa-solid fa-flag"></i> Báo cáo
    </button>
  </div>
  {% include "forum/_report_modal.html" with post=post %}
</article>

<!-- COMMENT SECTION -->
<section class="comment-section" style="max-width:780px; margin:30px auto 60px;">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
    <h3 style="color:#0f172a; margin:0; font-size:20px; font-weight:700;">
      Bình luận <span style="color:#64748b; font-weight:500;">({{ post.comments.count }})</span>
    </h3>
  </div>

  <!-- Form viết bình luận chính -->
  <div style="display:flex; gap:12px; margin-bottom:30px;">
    <div class="avatar">
        {% if request.user.userprofile.avatar_image %}
          <img src="{{ request.user.userprofile.avatar_image.url }}">
        {% else %}
          {{ request.user.username|slice:":1"|upper }}
        {% endif %}
    </div>
    <form method="post" style="flex:1;">
      {% csrf_token %}
      <input type="hidden" name="comment" value="1">
      <textarea name="content" placeholder="Viết bình luận của bạn..."
                style="width:100%; border:1px solid #cbd5e1; border-radius:12px; padding:12px; min-height:80px; resize:vertical; font-family:inherit;"></textarea>
      <div style="display:flex; justify-content:flex-end; margin-top:10px;">
        <button class="btn-primary" type="submit">Đăng bình luận</button>
      </div>
    </form>
  </div>

  <!-- Danh sách bình luận -->
  <div class="comment-tree">
    {% for c in comments %}
       {% include "forum/_comment_node.html" %}
    {% empty %}
        <div style="text-align:center; padding:40px; background:#f8fafc; border-radius:12px; color:#64748b;">
          <i class="fa-regular fa-comments" style="font-size:32px; margin-bottom:10px; display:block;"></i>
          Chưa có bình luận nào. Hãy là người đầu tiên!
        </div>
    {% endfor %}
  </div>
</section>

<!-- Template form reply (ẩn) -->
<div id="reply-form-template" class="hidden">
    <form method="post" class="reply-form" style="background:#fff; border:1px solid #e2e8f0; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">
        {% csrf_token %}
        <input type="hidden" name="comment" value="1">
        <input type="hidden" name="parent_id" value="">
        <textarea name="content" placeholder="Viết phản hồi..."></textarea>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:10px;">
            <button type="button" class="btn-ghost js-cancel-reply" style="height:36px;">Hủy</button>
            <button type="submit" class="btn-primary" style="height:36px;">Gửi phản hồi</button>
        </div>
    </form>
</div>

<!-- Lightbox -->
<div id="image-lightbox" class="lightbox">
  <span class="lightbox-close">×</span>
  <img class="lightbox-content" id="lightbox-img">
  <a class="lightbox-prev" id="lightbox-prev">&#10094;</a>
  <a class="lightbox-next" id="lightbox-next">&#10095;</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

  // === Auto grow textarea ===
  const autoGrow = el => {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = el.scrollHeight + 'px';
  };
  document.querySelectorAll('textarea').forEach(el => {
    el.addEventListener('input', () => autoGrow(el));
  });

  // === Vote ===
  document.querySelectorAll('.vote-box').forEach(box => {
    const buttons = box.querySelectorAll('.js-vote');
    const countEl = box.querySelector('.js-count');
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const type = btn.dataset.type;
        const postId = box.dataset.post;
        const res = await fetch(`/forum/${postId}/react/${type}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (res.ok) {
          const data = await res.json();
          countEl.textContent = data.total_votes ?? 0;
          buttons.forEach(b => b.classList.remove('active-up', 'active-down'));
          if (data.reaction === 'upvote')
            box.querySelector('[data-type="upvote"]').classList.add('active-up');
          if (data.reaction === 'downvote')
            box.querySelector('[data-type="downvote"]').classList.add('active-down');
        }
      });
    });
  });

  // === Lightbox Logic ===
  let lightboxImages = [], currentImageIndex = 0;
  const lightbox = document.getElementById('image-lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const lightboxClose = document.querySelector('.lightbox-close');

  if (lightbox && lightboxImg) {
    const openLightbox = (postElement, src) => {
      lightboxImages = Array.from(postElement.querySelectorAll('.js-lightbox-trigger')).map(img => img.src);
      currentImageIndex = lightboxImages.indexOf(src);
      updateLightboxImage();
      lightbox.style.display = 'block';
      document.body.style.overflow = 'hidden';
    };

    const updateLightboxImage = () => {
      lightboxImg.src = lightboxImages[currentImageIndex];
      const show = lightboxImages.length > 1;
      lightboxPrev.style.display = show ? 'block' : 'none';
      lightboxNext.style.display = show ? 'block' : 'none';
    };

    const closeLightbox = () => {
      lightbox.style.display = 'none';
      document.body.style.overflow = 'auto';
    };

    lightboxNext.onclick = (e) => { e.stopPropagation(); if (lightboxImages.length > 1) { currentImageIndex = (currentImageIndex + 1) % lightboxImages.length; updateLightboxImage(); }};
    lightboxPrev.onclick = (e) => { e.stopPropagation(); if (lightboxImages.length > 1) { currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length; updateLightboxImage(); }};
    lightboxClose.onclick = closeLightbox;
    lightbox.onclick = e => { if (e.target === lightbox) closeLightbox(); };

    document.addEventListener('keydown', e => {
      if (lightbox.style.display === 'block') {
        if (e.key === 'ArrowRight') lightboxNext.click();
        else if (e.key === 'ArrowLeft') lightboxPrev.click();
        else if (e.key === 'Escape') closeLightbox();
      }
    });

    // Handle clicks
    document.addEventListener('click', async e => {
      // Lightbox
      const imgTrigger = e.target.closest('.js-lightbox-trigger, .image-wrapper[data-more-count]');
      if (imgTrigger) {
        e.preventDefault();
        let src;
        if (imgTrigger.hasAttribute('data-more-count')) {
            src = imgTrigger.closest('.post-images').querySelector('.js-lightbox-trigger').src;
        } else {
            src = imgTrigger.src;
        }
        openLightbox(imgTrigger.closest('.post-images'), src);
        return;
      }

      // Menu Comment (3 chấm)
      const menuBtn = e.target.closest('.comment-menu-btn');
      const allMenus = document.querySelectorAll('.comment-menu');

      if (menuBtn) {
        e.stopPropagation();
        const menu = menuBtn.nextElementSibling; // Menu ngay sau nút
        const isOpen = menu.style.display === 'block';
        allMenus.forEach(m => m.style.display = 'none'); // Đóng hết cái khác
        if (!isOpen) {
            menu.style.display = 'block';
        }
        return;
      }
      if (!e.target.closest('.comment-menu')) {
          allMenus.forEach(m => m.style.display = 'none');
      }

      // Modal Report
      const reportBtn = e.target.closest('.js-open-report');
      if (reportBtn) {
        const targetId = reportBtn.dataset.target;
        if (targetId) document.getElementById(targetId).style.display = 'flex';
        return;
      }
      const modal = e.target.closest('.modal');
      if (modal && (e.target === modal || e.target.hasAttribute('data-close'))) {
        modal.style.display = 'none';
        return;
      }

      // === EDIT COMMENT ===
      const editBtn = e.target.closest('.js-edit-comment');
      if (editBtn) {
        e.preventDefault();
        const id = editBtn.dataset.id;
        const commentNode = document.getElementById(`comment-${id}`);
        const contentDiv = commentNode.querySelector('.comment-content');

        if (commentNode.querySelector('.edit-form-container')) return; // Đang edit rồi thì thôi

        const rawText = contentDiv.textContent.trim();
        const editContainer = document.createElement('div');
        editContainer.className = 'edit-form-container';
        editContainer.innerHTML = `
          <form class="edit-form" data-id="${id}">
            <textarea>${rawText}</textarea>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
              <button type="button" class="btn-ghost js-cancel-edit" style="height:32px; font-size:13px;">Hủy</button>
              <button type="submit" class="btn-primary" style="height:32px; font-size:13px;">Lưu</button>
            </div>
          </form>`;

        contentDiv.style.display = 'none';
        contentDiv.parentNode.insertBefore(editContainer, contentDiv.nextSibling);
        editContainer.querySelector('textarea').focus();
        return;
      }

      // Cancel Edit
      if (e.target.closest('.js-cancel-edit')) {
        const container = e.target.closest('.edit-form-container');
        container.previousElementSibling.style.display = 'block'; // Hiện lại text cũ
        container.remove();
      }

      // Save Edit
      const saveForm = e.target.closest('.edit-form');
      if (saveForm && e.target.type === 'submit') {
        e.preventDefault();
        const id = saveForm.dataset.id;
        const newContent = saveForm.querySelector('textarea').value.trim();
        if (!newContent) return;

        const res = await fetch(`/forum/comment/${id}/edit/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
          body: JSON.stringify({ content: newContent })
        });
        if (res.ok) {
          const data = await res.json();
          const container = saveForm.closest('.edit-form-container');
          const contentDiv = container.previousElementSibling;
          contentDiv.innerHTML = data.new_content_html || newContent.replace(/\n/g, '<br>');
          contentDiv.style.display = 'block';
          container.remove();
        } else {
            alert('Lỗi khi lưu.');
        }
      }

      // Delete Comment
      const deleteBtn = e.target.closest('.js-delete-comment');
      if (deleteBtn) {
        if (!confirm('Xóa bình luận này?')) return;
        const id = deleteBtn.dataset.id;
        const res = await fetch(`/forum/comment/${id}/delete/`, {
          method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (res.ok) {
           const node = document.getElementById(`comment-${id}`);
           node.style.opacity = '0.5';
           node.innerHTML = '<div style="padding:10px; color:#94a3b8; font-style:italic;">Bình luận đã bị xóa</div>';
        }
      }

      // === REPLY ===
      const replyBtn = e.target.closest('.js-reply-trigger');
      if (replyBtn) {
          const commentId = replyBtn.dataset.id;
          const container = document.getElementById(`reply-container-${commentId}`);

          // Đóng các form reply khác
          document.querySelectorAll('.reply-form-container').forEach(el => el.innerHTML = '');

          const template = document.getElementById('reply-form-template').innerHTML;
          container.innerHTML = `<div class="reply-form-container">${template}</div>`;

          const form = container.querySelector('form');
          form.querySelector('input[name="parent_id"]').value = commentId;
          form.querySelector('textarea').focus();
      }

      if (e.target.closest('.js-cancel-reply')) {
          e.target.closest('.reply-form-container').remove();
      }
    });

    // Xử lý submit form Report
    document.addEventListener('submit', async e => {
      const form = e.target.closest('.js-report-form');
      if (!form) return;
      e.preventDefault();

      const isPost = form.hasAttribute('data-post');
      const id = isPost ? form.dataset.post : form.dataset.comment;
      const url = isPost ? `/forum/${id}/report/` : `/forum/comment/${id}/report/`;

      const btn = form.querySelector('button[type="submit"]');
      const oldText = btn.innerText;
      btn.innerText = 'Đang gửi...'; btn.disabled = true;

      try {
          const formData = new FormData(form);
          const res = await fetch(url, {
            method: 'POST', headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }, body: formData
          });
          const data = await res.json();
          if (data.status === 'ok') {
            alert('Đã gửi báo cáo thành công!');
            form.closest('.modal').style.display = 'none';
            form.reset();
          } else {
            alert('Có lỗi xảy ra.');
          }
      } catch (err) { console.error(err); }
      finally { btn.innerText = oldText; btn.disabled = false; }
    });
  }
});
</script>
{% endblock %}