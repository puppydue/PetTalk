{% extends "base.html" %}
{% load static %}
{% load forum_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
<style>
  .comment-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 4px;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    min-width: 150px;
    z-index: 10;
    overflow: hidden;
  }
  .comment-menu .menu-item {
    display: block;
    width: 100%;
    padding: 8px 12px;
    background: none;
    border: none;
    text-align: left;
    font-size: 14px;
    cursor: pointer;
    color: #1e293b;
    white-space: nowrap;
  }
  .comment-menu .menu-item:hover {
    background-color: #f8fafc;
  }
.comment-menu.menu-up {
  top: auto !important;
  bottom: 100%;
  margin-top: 0;
  margin-bottom: 6px;
  transform-origin: bottom right;
}

  .comment-menu .menu-item + .menu-item {
    border-top: 1px solid #f1f5f9;
  }
    .comment-content {
  white-space: pre-wrap; /* gi·ªØ xu·ªëng d√≤ng g·ªëc v√† cho ph√©p xu·ªëng d√≤ng t·ª± ƒë·ªông */
  word-break: break-word; /* c·∫Øt t·ª´ qu√° d√†i */
  overflow-wrap: anywhere; /* h·ªó tr·ª£ tr√¨nh duy·ªát m·ªõi */
}

</style>
{% endblock %}
{% block title %}B√†i vi·∫øt ‚Ä¢ {{ post.title }}{% endblock %}

{% block content %}
{% reaction_of post request.user as me_react %}

<article class="post-card" style="max-width:780px; margin:0 auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">

  <div class="user-info" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <div class="avatar">{{ post.username.username|slice:":1"|upper }}</div>
    <div style="display:flex;flex-direction:column;">
      <span style="font-weight:700;color:#003459;font-size:15px;">{{ post.username.username }}</span>
      <small style="color:#64748b;font-size:13px;">{{ post.created_at|date:"d/m/Y H:i" }}</small>
    </div>
  </div>

  <h1 class="post-title" style="font-size:22px">{{ post.title }}</h1>
  <div class="post-content">{{ post.content|linebreaksbr }}</div>

  {% if post.images.all %}
  <div class="post-images" style="margin-top:10px">
    {% for img in post.images.all %}
      <img src="{{ img.image.url }}" alt="post image">
    {% endfor %}
  </div>
  {% endif %}

  <div class="actions" style="display:flex;align-items:center;gap:12px;margin-top:12px">
    <div class="vote-box" data-post="{{ post.post_id }}">
      <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
      <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
    </div>

    <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
      <i class="fa-solid fa-flag"></i> B√°o c√°o
    </button>
  </div>

  {% include "forum/_report_modal.html" with post=post %}
</article>

<section class="comment-section" style="max-width:780px; margin:20px auto 0 auto;">
  <hr style="border:none;border-top:1px solid #eef2f7;margin:16px 0">
  <h3 style="color:#003459;margin:0 0 8px 0">B√¨nh lu·∫≠n ({{ comments|length }})</h3>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="comment" value="1">
    {{ comment_form.content }}
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn-primary" type="submit">ƒêƒÉng</button>
    </div>
  </form>

  <div style="display:flex;flex-direction:column;gap:10px;margin-top:16px">
    {% for c in comments %}
    <div class="comment-box" id="comment-{{ c.id }}" style="background:#f9fafb;padding:10px 12px;border-radius:12px;position:relative;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <strong style="color:#003459">{{ c.username.username }}</strong>
          <small style="color:#64748b"> ‚Ä¢ {{ c.created_at|date:"d/m/Y H:i" }}</small>
        </div>

        {% if c.username == request.user %}
        <div class="comment-menu-wrapper" style="position:relative;">
          <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
          <div class="comment-menu">
            <button class="menu-item js-edit-comment" data-id="{{ c.id }}">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
            <button class="menu-item js-delete-comment" data-id="{{ c.id }}">üóëÔ∏è X√≥a</button>
          </div>
        </div>
        {% else %}
        <div class="comment-menu-wrapper" style="position:relative;">
          <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
          <div class="comment-menu">
            <button class="menu-item js-open-report-comment" data-target="report-comment-{{ c.id }}">üö© B√°o c√°o</button>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="comment-content" style="margin-top:6px;">{{ c.content|linebreaksbr }}</div>
      {% include "forum/_report_comment_modal.html" with comment=c %}
    </div>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

  // === H√ÄM L·∫§Y CSRF TOKEN ===
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const c = document.cookie.split(';');
      for (let i = 0; i < c.length; i++) {
        const s = c[i].trim();
        if (s.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(s.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }
  const csrftoken = getCookie('csrftoken');

  // === VOTE B√ÄI VI·∫æT ===
  document.querySelectorAll('.vote-box').forEach(box => {
    const buttons = box.querySelectorAll('.js-vote');
    const countEl = box.querySelector('.js-count');
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const type = btn.dataset.type;
        const postId = box.dataset.post;
        const url = `/forum/${postId}/react/${type}/`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (res.ok) {
          const data = await res.json();
          countEl.textContent = data.total_votes ?? 0;
          buttons.forEach(b => b.classList.remove('active-up', 'active-down'));
          if (data.reaction === 'upvote') box.querySelector('[data-type="upvote"]').classList.add('active-up');
          if (data.reaction === 'downvote') box.querySelector('[data-type="downvote"]').classList.add('active-down');
        }
      });
    });
  });

  // === CLICK TO√ÄN TRANG ===
  document.addEventListener('click', async (e) => {
    const allMenus = document.querySelectorAll('.comment-menu');
    const btn = e.target.closest('.comment-menu-btn');

// 1Ô∏è‚É£ Menu ba ch·∫•m
if (btn) {
  e.stopPropagation();
  const menu = btn.parentElement.querySelector('.comment-menu');
  allMenus.forEach(m => { if (m !== menu) m.style.display = 'none'; });
  const isOpen = menu.style.display === 'block';
  menu.style.display = isOpen ? 'none' : 'block';

  if (!isOpen) {
    // üí° Ki·ªÉm tra xem menu c√≥ b·ªã tr√†n kh·ªèi m√†n h√¨nh hay kh√¥ng
    // B·∫≠t t·∫°m ƒë·ªÉ ƒëo ch√≠nh x√°c k√≠ch th∆∞·ªõc th·ª±c t·∫ø
    menu.style.visibility = 'hidden';
    menu.style.display = 'block';

    const rect = menu.getBoundingClientRect();
    const bottomOverflow = rect.bottom > window.innerHeight;

    // N·∫øu b·ªã tr√†n xu·ªëng ho·∫∑c g·∫ßn m√©p d∆∞·ªõi => m·ªü l√™n tr√™n
    if (bottomOverflow || (window.innerHeight - rect.bottom) < 20) {
      menu.classList.add('menu-up');
    } else {
      menu.classList.remove('menu-up');
    }

    // ·∫®n l·∫°i, s·∫Ω hi·ªÉn th·ªã ƒë√∫ng khi click xong
    menu.style.display = 'none';
    menu.style.visibility = '';
    menu.style.display = 'block';
  }
  return;
}
    // 2Ô∏è‚É£ Click ngo√†i menu ‚Üí ƒë√≥ng
    if (!e.target.closest('.comment-menu-wrapper')) {
      allMenus.forEach(m => m.style.display = 'none');
    }

    // 3Ô∏è‚É£ M·ªü modal b√°o c√°o
    const reportBtn = e.target.closest('.js-open-report') || e.target.closest('.js-open-report-comment');
    if (reportBtn) {
      const id = reportBtn.getAttribute('data-target');
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'flex';
      return;
    }

    // 4Ô∏è‚É£ ƒê√≥ng modal
    const modal = e.target.closest('.modal');
    if (modal && (e.target === modal || e.target.hasAttribute('data-close'))) {
      modal.style.display = 'none';
      return;
    }

    // 5Ô∏è‚É£ Ch·ªânh s·ª≠a b√¨nh lu·∫≠n
    if (e.target.classList.contains('js-edit-comment')) {
      const id = e.target.dataset.id;
      const box = document.getElementById(`comment-${id}`);
      const div = box.querySelector('.comment-content');
      const oldHtml = div.innerHTML;
      const text = oldHtml.replace(/<br\s*\/?>/ig, "\n").trim();
      div.innerHTML = `
        <form class="edit-form" data-id="${id}">
          <textarea rows="3" class="form-control" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;padding:6px;">${text}</textarea>
          <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px;">
            <button type="button" class="btn-ghost js-cancel-edit">H·ªßy</button>
            <button type="submit" class="btn-primary">L∆∞u</button>
          </div>
        </form>`;
      div.querySelector('.edit-form').dataset.oldHtml = oldHtml;
      return;
    }

    // 6Ô∏è‚É£ H·ªßy ch·ªânh s·ª≠a
    if (e.target.classList.contains('js-cancel-edit')) {
      const form = e.target.closest('.edit-form');
      const old = form.dataset.oldHtml;
      form.parentElement.innerHTML = old;
      return;
    }

    // 7Ô∏è‚É£ Submit ch·ªânh s·ª≠a
    if (e.target.closest('.edit-form') && e.target.type === 'submit') {
      e.preventDefault();
      const form = e.target.closest('.edit-form');
      const id = form.dataset.id;
      const newContent = form.querySelector('textarea').value;
      const res = await fetch(`/forum/comment/${id}/edit/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ content: newContent })
      });
      if (res.ok) {
        const data = await res.json();
        form.parentElement.innerHTML = data.new_content_html;
      } else alert('ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t b√¨nh lu·∫≠n.');
      return;
    }

    // 8Ô∏è‚É£ X√≥a b√¨nh lu·∫≠n
    if (e.target.classList.contains('js-delete-comment')) {
      const id = e.target.dataset.id;
      if (!confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) return;
      const res = await fetch(`/forum/comment/${id}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (res.ok) {
        const data = await res.json();
        if (data.status === 'deleted') {
          const el = document.getElementById(`comment-${id}`);
          el.style.transition = 'opacity .3s';
          el.style.opacity = '0';
          setTimeout(() => el.remove(), 300);
        } else alert('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n.');
      } else alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a b√¨nh lu·∫≠n.');
      return;
    }
  });

  // === G·ª¨I FORM B√ÅO C√ÅO (AJAX) ===
  document.querySelectorAll('.js-report-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const postId = form.dataset.post;
      const formData = new FormData(form);
      const res = await fetch(`/forum/${postId}/report/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });
      if (res.ok) {
        alert('‚úÖ B√°o c√°o c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. C·∫£m ∆°n b·∫°n!');
        form.closest('.modal').style.display = 'none';
        form.reset();
      } else alert('‚ö†Ô∏è L·ªói khi g·ª≠i b√°o c√°o.');
    });
  });

  // === AUTO RESIZE TEXTAREA ===
  const textarea = document.querySelector('textarea[name="content"]');
  if (textarea) {
    textarea.style.resize = 'none';
    textarea.style.overflowY = 'hidden';
    const autoGrow = el => {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    };
    textarea.addEventListener('input', () => autoGrow(textarea));
    autoGrow(textarea);
  }

});
</script>

<style>
/* üëá Fix comment d√†i b·ªã tr√†n, t·ª± xu·ªëng d√≤ng */
.comment-content {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
}
</style>
{% endblock %}

