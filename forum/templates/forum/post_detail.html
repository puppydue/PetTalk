{% extends "base.html" %}
{% load static %}
{% load forum_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
{% endblock %}
{% block title %}B√†i vi·∫øt ‚Ä¢ {{ post.title }}{% endblock %}

{% block content %}
{% reaction_of post request.user as me_react %}
<article class="post-card" style="max-width:780px;margin:0 auto">
  <div class="user-info" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <div class="avatar">{{ post.username.username|slice:":1"|upper }}</div>
    <div style="display:flex;flex-direction:column;">
      <span style="font-weight:700;color:#003459;font-size:15px;">{{ post.username.username }}</span>
      <small style="color:#64748b;font-size:13px;">{{ post.created_at|date:"d/m/Y H:i" }}</small>
    </div>
  </div>

  <h1 class="post-title" style="font-size:22px">{{ post.title }}</h1>
  <div class="post-content">{{ post.content|linebreaksbr }}</div>

  {% if post.images.all %}
  <div class="post-images" style="margin-top:10px">
    {% for img in post.images.all %}
      <img src="{{ img.image.url }}" alt="post image">
    {% endfor %}
  </div>
  {% endif %}

  <div class="actions" style="display:flex;align-items:center;gap:12px;margin-top:12px">
    <div class="vote-box" data-post="{{ post.post_id }}">
      <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote" title="Upvote">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
      <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote" title="Downvote">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
    </div>

    <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
      <i class="fa-solid fa-flag"></i> B√°o c√°o
    </button>
  </div>

  {% include "forum/_report_modal.html" with post=post %}

  <hr style="border:none;border-top:1px solid #eef2f7;margin:16px 0">

  <h3 style="color:#003459;margin:0 0 8px 0">B√¨nh lu·∫≠n ({{ comments|length }})</h3>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="comment" value="1">
    {{ comment_form.content }}
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn-primary" type="submit">ƒêƒÉng</button>
    </div>
  </form>

  <div style="display:flex;flex-direction:column;gap:10px;margin-top:16px">
    {% for c in comments %}
<div class="comment-box" id="comment-{{ c.id }}" style="background:#f9fafb;padding:10px 12px;border-radius:12px;position:relative;">

  <div style="display:flex;align-items:center;justify-content:space-between;">
    <div>
      <strong style="color:#003459">{{ c.username.username }}</strong>
      <small style="color:#64748b"> ‚Ä¢ {{ c.created_at|date:"d/m/Y H:i" }}</small>
    </div>

    {% if c.username == request.user %}
    <!-- N√∫t ba ch·∫•m -->
    <div class="comment-menu-wrapper" style="position:relative;">
      <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
      <div class="comment-menu">
        <button class="menu-item js-edit-comment" data-id="{{ c.id }}">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
        <button class="menu-item js-delete-comment" data-id="{{ c.id }}">üóëÔ∏è X√≥a</button>
      </div>
    </div>
    {% else %}
    <div class="comment-menu-wrapper" style="position:relative;">
      <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
      <div class="comment-menu">
        <button class="menu-item js-open-report-comment" data-target="report-comment-{{ c.id }}">üö© B√°o c√°o</button>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="comment-content" style="margin-top:6px;">{{ c.content|linebreaksbr }}</div>
  {% include "forum/_report_comment_modal.html" with comment=c %}
</div>
{% endfor %}

  </div>
</article>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){let v=null;if(document.cookie&&document.cookie!==''){const c=document.cookie.split(';');for(let i=0;i<c.length;i++){const s=c[i].trim();if(s.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(s.substring(name.length+1));break}}}return v}
const csrftoken=getCookie('csrftoken');

document.querySelectorAll('.vote-box').forEach(box=>{
  const buttons=box.querySelectorAll('.js-vote');
  const countEl=box.querySelector('.js-count');
  buttons.forEach(btn=>{
    btn.addEventListener('click',async()=>{
      const type=btn.dataset.type;
      const postId=box.dataset.post;
      const url=`/forum/${postId}/react/${type}/`;
      const res=await fetch(url,{method:'POST',headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}});
      if(res.ok){
        const data=await res.json();
        countEl.textContent=data.total_votes??0;
        buttons.forEach(b=>b.classList.remove('active-up','active-down'));
        if(data.reaction==='upvote')box.querySelector('[data-type="upvote"]').classList.add('active-up');
        if(data.reaction==='downvote')box.querySelector('[data-type="downvote"]').classList.add('active-down');
      }
    });
  });
});
</script>
<script>
document.addEventListener('click', e => {
  // Toggle menu ba ch·∫•m
  const btn = e.target.closest('.comment-menu-btn');
  document.querySelectorAll('.comment-menu').forEach(m => m.style.display='none');
  if (btn) {
    const menu = btn.parentElement.querySelector('.comment-menu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
  }

  // ƒê√≥ng khi click ngo√†i menu
  if (!e.target.closest('.comment-menu-wrapper')) {
    document.querySelectorAll('.comment-menu').forEach(m => m.style.display='none');
  }

  // M·ªü modal b√°o c√°o b√¨nh lu·∫≠n
  const reportBtn = e.target.closest('.js-open-report-comment');
  if (reportBtn) {
    const id = reportBtn.dataset.target;
    const modal = document.getElementById(id);
    if (modal) modal.style.display = 'flex';
  }

  // ƒê√≥ng modal b√°o c√°o
  const modal = e.target.closest('.modal');
  if (modal && (e.target === modal || e.target.hasAttribute('data-close'))) {
    modal.style.display = 'none';
  }
});
</script>
<script>
document.addEventListener('click', async (e) => {
  // Toggle menu ba ch·∫•m
  const btn = e.target.closest('.comment-menu-btn');
  document.querySelectorAll('.comment-menu').forEach(m => m.style.display = 'none');
  if (btn) {
    const menu = btn.parentElement.querySelector('.comment-menu');
    menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
  }

  // ƒê√≥ng menu khi click ngo√†i
  if (!e.target.closest('.comment-menu-wrapper')) {
    document.querySelectorAll('.comment-menu').forEach(m => m.style.display = 'none');
  }

  // ==== CH·ªàNH S·ª¨A COMMENT ====
  if (e.target.classList.contains('js-edit-comment')) {
    const id = e.target.dataset.id;
    const commentBox = document.getElementById(`comment-${id}`);
    const contentDiv = commentBox.querySelector('.comment-content');
    const oldText = contentDiv.textContent.trim();

    // Hi·ªÉn th·ªã form ch·ªânh s·ª≠a
    contentDiv.innerHTML = `
      <form class="edit-form" data-id="${id}" style="margin-top:6px;">
        <textarea rows="3" class="form-control" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;padding:6px;">${oldText}</textarea>
        <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px;">
          <button type="button" class="btn-ghost js-cancel-edit">H·ªßy</button>
          <button type="submit" class="btn-primary">L∆∞u</button>
        </div>
      </form>
    `;
  }

  // H·ªßy ch·ªânh s·ª≠a
  if (e.target.classList.contains('js-cancel-edit')) {
    e.target.closest('.edit-form').remove();
    window.location.reload(); // reload l·∫°i comment g·ªëc (ho·∫∑c c√≥ th·ªÉ fetch l·∫°i qua AJAX)
  }

  // Submit ch·ªânh s·ª≠a
  if (e.target.closest('.edit-form') && e.target.type === 'submit') {
    e.preventDefault();
    const form = e.target.closest('.edit-form');
    const id = form.dataset.id;
    const newContent = form.querySelector('textarea').value;
    const csrftoken = getCookie('csrftoken');
    const res = await fetch(`/forum/comment/${id}/edit/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({ content: newContent })
    });
    if (res.ok) {
      location.reload();
    }
  }

  // ==== X√ìA COMMENT ====
  if (e.target.classList.contains('js-delete-comment')) {
    const id = e.target.dataset.id;
    if (confirm("üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?")) {
      const csrftoken = getCookie('csrftoken');
      const res = await fetch(`/forum/comment/${id}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });
      if (res.ok) {
        document.getElementById(`comment-${id}`).remove();
      }
    }
  }
});
</script>

{% endblock %}
