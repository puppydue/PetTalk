{% extends "base.html" %}
{% load static %}
{% load forum_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
<style>
  /* === B·ªî SUNG CSS CHO COMMENT MENU === */
  .comment-menu {
    display: none; /* ·∫®n ban ƒë·∫ßu */
    position: absolute;
    right: 0;
    top: 100%; /* M·∫∑c ƒë·ªãnh: bung xu·ªëng d∆∞·ªõi */
    margin-top: 4px;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    min-width: 150px;
    z-index: 10;
    overflow: hidden; /* ƒê·ªÉ bo g√≥c cho item b√™n trong */
  }

  /* Class n√†y s·∫Ω l√†m menu bung l√™n tr√™n */
  .comment-menu.menu-up {
    top: auto;
    bottom: 100%;
    margin-top: 0;
    margin-bottom: 4px;
  }

  .comment-menu .menu-item {
    display: block;
    width: 100%;
    padding: 8px 12px;
    background: none;
    border: none;
    text-align: left;
    font-size: 14px;
    cursor: pointer;
    color: #1e293b;
    white-space: nowrap; /* ƒê·∫£m b·∫£o kh√¥ng b·ªã xu·ªëng d√≤ng */
  }
  .comment-menu .menu-item:hover {
    background-color: #f8fafc;
  }
  /* Th√™m ƒë∆∞·ªùng k·∫ª ngƒÉn c√°ch */
  .comment-menu .menu-item + .menu-item {
      border-top: 1px solid #f1f5f9;
  }
  /* === H·∫æT CSS B·ªî SUNG === */
</style>
{% endblock %}
{% block title %}B√†i vi·∫øt ‚Ä¢ {{ post.title }}{% endblock %}

{% block content %}
{% reaction_of post request.user as me_react %}
<!-- === THAY ƒê·ªîI 1: Th√™m style ƒë·ªÉ ƒë√≥ng khung b√†i vi·∫øt === -->
<article class="post-card" style="max-width:780px; margin:0 auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">

  <div class="user-info" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <div class="avatar">{{ post.username.username|slice:":1"|upper }}</div>
    <div style="display:flex;flex-direction:column;">
      <span style="font-weight:700;color:#003459;font-size:15px;">{{ post.username.username }}</span>
      <small style="color:#64748b;font-size:13px;">{{ post.created_at|date:"d/m/Y H:i" }}</small>
    </div>
  </div>

  <h1 class="post-title" style="font-size:22px">{{ post.title }}</h1>
  <div class="post-content">{{ post.content|linebreaksbr }}</div>

  {% if post.images.all %}
  <div class="post-images" style="margin-top:10px">
    {% for img in post.images.all %}
      <img src="{{ img.image.url }}" alt="post image">
    {% endfor %}
  </div>
  {% endif %}

  <div class="actions" style="display:flex;align-items:center;gap:12px;margin-top:12px">
    <div class="vote-box" data-post="{{ post.post_id }}">
      <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote" title="Upvote">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
      <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote" title="Downvote">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
    </div>

    <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
      <i class="fa-solid fa-flag"></i> B√°o c√°o
    </button>
  </div>

  {% include "forum/_report_modal.html" with post=post %}

<!-- === THAY ƒê·ªîI 2: ƒê√≥ng th·∫ª </article> t·∫°i ƒë√¢y ƒë·ªÉ k·∫øt th√∫c khung === -->
</article>

<!-- === THAY ƒê·ªîI 3: B·ªçc ph·∫ßn b√¨nh lu·∫≠n trong th·∫ª <section> ri√™ng === -->
<section class="comment-section" style="max-width:780px; margin: 20px auto 0 auto;">
  <hr style="border:none;border-top:1px solid #eef2f7;margin:16px 0">

  <h3 style="color:#003459;margin:0 0 8px 0">B√¨nh lu·∫≠n ({{ comments|length }})</h3>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="comment" value="1">
    {{ comment_form.content }}
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn-primary" type="submit">ƒêƒÉng</button>
    </div>
  </form>

  <div style="display:flex;flex-direction:column;gap:10px;margin-top:16px">
    {% for c in comments %}
<div class="comment-box" id="comment-{{ c.id }}" style="background:#f9fafb;padding:10px 12px;border-radius:12px;position:relative;">

  <div style="display:flex;align-items:center;justify-content:space-between;">
    <div>
      <strong style="color:#003459">{{ c.username.username }}</strong>
      <small style="color:#64748b"> ‚Ä¢ {{ c.created_at|date:"d/m/Y H:i" }}</small>
    </div>

    {% if c.username == request.user %}
    <!-- N√∫t ba ch·∫•m -->
    <div class="comment-menu-wrapper" style="position:relative;">
      <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
      <div class="comment-menu">
        <button class="menu-item js-edit-comment" data-id="{{ c.id }}">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
        <button class="menu-item js-delete-comment" data-id="{{ c.id }}">üóëÔ∏è X√≥a</button>
      </div>
    </div>
    {% else %}
    <div class="comment-menu-wrapper" style="position:relative;">
      <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
      <div class="comment-menu">
        <button class="menu-item js-open-report-comment" data-target="report-comment-{{ c.id }}">üö© B√°o c√°o</button>
      </div>
    </div>
    {% endif %}
  </div>
  <div class="comment-content" style="margin-top:6px;">{{ c.content|linebreaksbr }}</div>
  {% include "forum/_report_comment_modal.html" with comment=c %}
</div>
{% endfor %}

  </div>
<!-- === THAY ƒê·ªîI 4: ƒê√≥ng th·∫ª </section> m·ªõi === -->
</section>
{% endblock %}

{% block extra_js %}
<!-- X√ìA SCRIPT ƒê·∫¶U TI√äN C·ª¶A B·∫†N V√å N√ì B·ªä L·∫∂P L·∫†I -->

<!-- G·ªòP T·∫§T C·∫¢ LOGIC V√ÄO SCRIPT N√ÄY -->
<script>
// --- H√ÄM L·∫§Y CSRF TOKEN ---
function getCookie(name){let v=null;if(document.cookie&&document.cookie!==''){const c=document.cookie.split(';');for(let i=0;i<c.length;i++){const s=c[i].trim();if(s.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(s.substring(name.length+1));break}}}return v}
const csrftoken=getCookie('csrftoken');

// --- LOGIC VOTE B√ÄI VI·∫æT (gi·ªØ nguy√™n) ---
document.querySelectorAll('.vote-box').forEach(box=>{
  const buttons=box.querySelectorAll('.js-vote');
  const countEl=box.querySelector('.js-count');
  buttons.forEach(btn=>{
    btn.addEventListener('click',async()=>{
      const type=btn.dataset.type;
      const postId=box.dataset.post;
      const url=`/forum/${postId}/react/${type}/`;
      const res=await fetch(url,{method:'POST',headers:{'X-CSRFToken':csrftoken,'X-Requested-With':'XMLHttpRequest'}});
      if(res.ok){
        const data=await res.json();
        countEl.textContent=data.total_votes??0;
        buttons.forEach(b=>b.classList.remove('active-up','active-down'));
        if(data.reaction==='upvote')box.querySelector('[data-type="upvote"]').classList.add('active-up');
        if(data.reaction==='downvote')box.querySelector('[data-type="downvote"]').classList.add('active-down');
      }
    });
  });
});

// --- B·ªò L·∫ÆNG NGHE S·ª∞ KI·ªÜN CLICK TO√ÄN TRANG (ƒê√É C·∫¨P NH·∫¨T) ---
document.addEventListener('click', async (e) => {

  // === LOGIC M·ªöI: M·ªû/ƒê√ìNG MENU BA CH·∫§M ===
  const btn = e.target.closest('.comment-menu-btn');

  // 1. ƒê√≥ng T·∫§T C·∫¢ c√°c menu kh√°c
  document.querySelectorAll('.comment-menu').forEach(m => {
      if (!m.parentElement.contains(btn)) {
          m.style.display = 'none';
          m.classList.remove('menu-up');
      }
  });

  // 2. N·∫øu click tr√∫ng n√∫t 3 ch·∫•m, x·ª≠ l√Ω m·ªü/ƒë√≥ng menu ƒë√≥
  if (btn) {
    const menu = btn.parentElement.querySelector('.comment-menu');
    const isAlreadyOpen = menu.style.display === 'block';

    if (isAlreadyOpen) {
      // N·∫øu ƒëang m·ªü -> ƒë√≥ng l·∫°i
      menu.style.display = 'none';
      menu.classList.remove('menu-up');
    } else {
      // N·∫øu ƒëang ƒë√≥ng -> m·ªü ra v√† ki·ªÉm tra v·ªã tr√≠
      menu.style.display = 'block'; // Hi·ªÉn th·ªã ƒë·ªÉ ƒëo k√≠ch th∆∞·ªõc

      const rect = btn.getBoundingClientRect();
      const menuHeight = menu.offsetHeight;
      const viewportHeight = window.innerHeight;

      // Ki·ªÉm tra xem c√≥ b·ªã tr√†n kh√¥ng
      if (rect.bottom + menuHeight + 10 > viewportHeight) { // +10 l√† kho·∫£ng ƒë·ªám
        // B·ªã tr√†n -> Th√™m class ƒë·ªÉ bung l√™n
        menu.classList.add('menu-up');
      } else {
        // ƒê·ªß ch·ªó -> X√≥a class (ph√≤ng tr∆∞·ªùng h·ª£p n√≥ c√≤n)
        menu.classList.remove('menu-up');
      }
    }
  }

  // === LOGIC C≈®: ƒê√ìNG MENU KHI CLICK B√äN NGO√ÄI ===
  if (!e.target.closest('.comment-menu-wrapper')) {
    document.querySelectorAll('.comment-menu').forEach(m => {
        m.style.display='none';
        m.classList.remove('menu-up');
    });
  }

  // === LOGIC M·ªû MODAL B√ÅO C√ÅO (ƒê√£ g·ªôp t·ª´ script 1) ===
  const reportBtn = e.target.closest('.js-open-report') || e.target.closest('.js-open-report-comment');
  if (reportBtn) {
    const id = reportBtn.dataset.target;
    const modal = document.getElementById(id);
    if (modal) modal.style.display = 'flex';
  }

  // === LOGIC ƒê√ìNG MODAL (ƒê√£ g·ªôp t·ª´ script 1) ===
  const modal = e.target.closest('.modal');
  if (modal && (e.target === modal || e.target.hasAttribute('data-close'))) {
    modal.style.display = 'none';
  }

  // ==== LOGIC CH·ªàNH S·ª¨A COMMENT (gi·ªØ nguy√™n) ====
  if (e.target.classList.contains('js-edit-comment')) {
    const id = e.target.dataset.id;
    const commentBox = document.getElementById(`comment-${id}`);
    const contentDiv = commentBox.querySelector('.comment-content');
    const oldText = contentDiv.textContent.trim(); // L·∫•y text th√¥

    // L·∫•y n·ªôi dung HTML g·ªëc (c√≥ th·ªÉ ch·ª©a <br>) ƒë·ªÉ h·ªßy cho chu·∫©n
    const oldHtml = contentDiv.innerHTML;
    // Chuy·ªÉn <br> th√†nh k√Ω t·ª± xu·ªëng d√≤ng cho textarea
    const textForTextarea = oldText.replace(/<br\s*\/?>/ig, "\n");

    // Hi·ªÉn th·ªã form ch·ªânh s·ª≠a
    contentDiv.innerHTML = `
      <form class="edit-form" data-id="${id}" style="margin-top:6px;">
        <textarea rows="3" class="form-control" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;padding:6px;">${textForTextarea}</textarea>
        <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px;">
          <button type="button" class="btn-ghost js-cancel-edit">H·ªßy</button>
          <button type="submit" class="btn-primary">L∆∞u</button>
        </div>
      </form>
    `;
    // L∆∞u l·∫°i n·ªôi dung HTML c≈© v√†o form ƒë·ªÉ H·ªßy
    contentDiv.querySelector('.edit-form').dataset.oldHtml = oldHtml;
  }

  // ==== LOGIC H·ª¶Y CH·ªàNH S·ª¨A (gi·ªØ nguy√™n, c·∫£i ti·∫øn 1 ch√∫t) ====
  if (e.target.classList.contains('js-cancel-edit')) {
    const form = e.target.closest('.edit-form');
    const oldHtml = form.dataset.oldHtml;
    const contentDiv = form.parentElement;
    contentDiv.innerHTML = oldHtml; // Tr·∫£ l·∫°i n·ªôi dung HTML g·ªëc
  }

  // ==== LOGIC SUBMIT CH·ªàNH S·ª¨A (gi·ªØ nguy√™n) ====
  if (e.target.closest('.edit-form') && e.target.type === 'submit') {
    e.preventDefault();
    const form = e.target.closest('.edit-form');
    const id = form.dataset.id;
    const newContent = form.querySelector('textarea').value;
    const csrftoken = getCookie('csrftoken');
    const res = await fetch(`/forum/comment/${id}/edit/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({ content: newContent })
    });
    if (res.ok) {
      // Thay v√¨ reload, c·∫≠p nh·∫≠t n·ªôi dung m·ªõi
      const data = await res.json();
      form.parentElement.innerHTML = data.new_content_html; // Gi·∫£ s·ª≠ view tr·∫£ v·ªÅ HTML m·ªõi
    } else {
      alert("ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t b√¨nh lu·∫≠n.");
    }
  }

  // ==== LOGIC X√ìA COMMENT (gi·ªØ nguy√™n) ====
  if (e.target.classList.contains('js-delete-comment')) {
    const id = e.target.dataset.id;
    if (confirm("üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?")) {
      const csrftoken = getCookie('csrftoken');
      const res = await fetch(`/forum/comment/${id}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });
      if (res.ok) {
        document.getElementById(`comment-${id}`).remove();
      } else {
        alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a b√¨nh lu·∫≠n.");
      }
    }
  }
});
</script>

{% endblock %}

