{% extends "base.html" %}
{% load static %}
{% load forum_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
<style>
  .comment-menu {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    margin-top: 4px;
    background: #fff;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    min-width: 150px;
    z-index: 10;
    overflow: hidden;
  }
  .comment-menu .menu-item {
    display: block;
    width: 100%;
    padding: 8px 12px;
    background: none;
    border: none;
    text-align: left;
    font-size: 14px;
    cursor: pointer;
    color: #1e293b;
    white-space: nowrap;
  }
  .comment-menu .menu-item:hover {
    background-color: #f8fafc;
  }
.comment-menu.menu-up {
  top: auto !important;
  bottom: 100%;
  margin-top: 0;
  margin-bottom: 6px;
  transform-origin: bottom right;
}

  .comment-menu .menu-item + .menu-item {
    border-top: 1px solid #f1f5f9;
  }
    .comment-content {
  white-space: pre-wrap; /* gi·ªØ xu·ªëng d√≤ng g·ªëc v√† cho ph√©p xu·ªëng d√≤ng t·ª± ƒë·ªông */
  word-break: break-word; /* c·∫Øt t·ª´ qu√° d√†i */
  overflow-wrap: anywhere; /* h·ªó tr·ª£ tr√¨nh duy·ªát m·ªõi */
}

  /* === ‚≠êÔ∏è T·ªêI ∆ØU L∆Ø·ªöI ·∫¢NH (Facebook-style) ‚≠êÔ∏è === */

  .post-images {
      display: grid;
      gap: 4px; /* Kho·∫£ng c√°ch gi·ªØa c√°c ·∫£nh */
      border-radius: 12px; /* Bo g√≥c cho c·∫£ kh·ªëi ·∫£nh */
      overflow: hidden; /* B·∫Øt bu·ªôc ƒë·ªÉ bo g√≥c c√°c ·∫£nh b√™n trong */
      margin-top: 15px;
      height: auto; /* ƒê·ªÉ chi·ªÅu cao t·ª± ƒë·ªông theo n·ªôi dung */
  }
  .image-wrapper {
      position: relative;
      width: 100%;
      height: 100%; /* Height s·∫Ω ƒë∆∞·ª£c set b·ªüi grid row */
      background: #f8fafc; /* N·ªÅn m·ªù khi t·∫£i */
  }
  .post-images img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover; /* ‚≠êÔ∏è ƒê√¢y l√† ch√¨a kh√≥a: T·ª∞ CROP ·∫¢NH V·ª™A KHUNG */
      cursor: pointer;
      transition: transform 0.2s ease;
  }
  .post-images img:hover {
      transform: scale(1.03); /* Hi·ªáu ·ª©ng zoom nh·∫π khi di chu·ªôt */
  }

  /* --- L∆∞·ªõi 1 ·∫£nh (Nh·ªè h∆°n) --- */
  .images-count-1 {
      display: flex;
      justify-content: center;
      max-height: 450px; /* Gi·ªõi h·∫°n chi·ªÅu cao "nh·ªè h∆°n n·ªØa" */
  }
  .images-count-1 .image-wrapper {
      height: auto;
  }
  .images-count-1 img {
      position: relative;
      object-fit: contain; /* 1 ·∫£nh th√¨ kh√¥ng crop, ch·ªâ thu nh·ªè */
      max-height: 450px;
      width: auto;
      max-width: 100%;
      cursor: zoom-in;
  }

  /* --- L∆∞·ªõi 2 ·∫£nh (1x2) --- */
  .images-count-2 {
      grid-template-columns: 1fr 1fr;
      height: 300px; /* C·ªë ƒë·ªãnh chi·ªÅu cao t·ªïng */
  }

  /* --- L∆∞·ªõi 3 ·∫£nh (1 to, 2 nh·ªè) --- */
  .images-count-3 {
      grid-template-columns: 2fr 1fr; /* C·ªôt tr√°i 66%, c·ªôt ph·∫£i 33% */
      grid-template-rows: 1fr 1fr; /* 2 h√†ng */
      height: 400px; /* C·ªë ƒë·ªãnh chi·ªÅu cao t·ªïng */
  }
  .images-count-3 .image-wrapper:first-child {
      grid-row: span 2; /* ·∫¢nh ƒë·∫ßu ti√™n chi·∫øm 2 h√†ng */
  }

  /* --- L∆∞·ªõi 4 ·∫£nh (2x2) --- */
  .images-count-4 {
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      height: 400px; /* C·ªë ƒë·ªãnh chi·ªÅu cao t·ªïng */
  }

  /* --- L∆∞·ªõi 5+ ·∫£nh --- */
  .images-count-more { /* D√πng class chung cho 5+ */
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      height: 400px;
  }
  /* ·∫®n ·∫£nh th·ª© 5 tr·ªü ƒëi */
  .images-count-more .image-wrapper:nth-child(n+5) {
      display: none;
  }
  /* Overlay cho ·∫£nh th·ª© 4, hi·ªÉn th·ªã s·ªë ·∫£nh c√≤n l·∫°i */
  .images-count-more .image-wrapper:nth-child(4) {
      position: relative;
  }
  .images-count-more .image-wrapper:nth-child(4)::after {
      content: attr(data-more-count); /* S·∫Ω l√† "+3" */
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
  }

  /* === ‚≠êÔ∏è CSS CHO LIGHTBOX (MODAL ·∫¢NH) ‚≠êÔ∏è === */
  .lightbox {
    position: fixed;
    z-index: 9990; /* N·∫±m tr√™n m·ªçi th·ª© */
    padding-top: 50px;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.9);
    display: none; /* ·∫®n ban ƒë·∫ßu */
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .lightbox-content {
    margin: auto;
    display: block;
    max-width: 90%;
    max-height: 85vh;
    animation: zoom 0.3s ease;
  }
  @keyframes zoom {
    from {transform: scale(0.8); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
  }
  .lightbox-close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
  }
  .lightbox-close:hover { color: #bbb; }
  .lightbox-prev, .lightbox-next {
    cursor: pointer;
    position: absolute;
    top: 50%;
    width: auto;
    padding: 16px;
    margin-top: -50px;
    color: white;
    font-weight: bold;
    font-size: 30px;
    transition: 0.3s;
    border-radius: 0 3px 3px 0;
    user-select: none;
    display: none; /* ·∫®n khi ch·ªâ c√≥ 1 ·∫£nh */
  }
  .lightbox-next { right: 0; border-radius: 3px 0 0 3px; }
  .lightbox-prev { left: 0; }
  .lightbox-prev:hover, .lightbox-next:hover {
    background-color: rgba(255,255,255,0.2);
  }
  /* === H·∫æT CSS LIGHTBOX === */

</style>
{% endblock %}
{% block title %}B√†i vi·∫øt ‚Ä¢ {{ post.title }}{% endblock %}

{% block content %}
{% reaction_of post request.user as me_react %}

<article class="post-card" style="max-width:780px; margin:0 auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.05);">

  <div class="user-info" style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
    <div class="avatar">{{ post.username.username|slice:":1"|upper }}</div>
    <div style="display:flex;flex-direction:column;">
      <span style="font-weight:700;color:#003459;font-size:15px;">{{ post.username.username }}</span>
      <small style="color:#64748b;font-size:13px;">{{ post.created_at|date:"d/m/Y H:i" }}</small>
    </div>
  </div>

  <h1 class="post-title" style="font-size:22px">{{ post.title }}</h1>
  <div class="post-content">{{ post.content|linebreaksbr }}</div>

  <!-- === ‚≠êÔ∏è KH·ªêI CODE ƒê√öNG (ƒê√É T·ªêI ∆ØU) ‚≠êÔ∏è === -->
  {% if post.images.all %}
    {% with image_count=post.images.all|length %}
      {% if image_count == 1 %}
        {% with class_name="images-count-1" %}
          {% include "forum/_post_images.html" %}
        {% endwith %}
      {% elif image_count == 2 %}
        {% with class_name="images-count-2" %}
          {% include "forum/_post_images.html" %}
        {% endwith %}
      {% elif image_count == 3 %}
        {% with class_name="images-count-3" %}
          {% include "forum/_post_images.html" %}
        {% endwith %}
      {% elif image_count == 4 %}
        {% with class_name="images-count-4" %}
          {% include "forum/_post_images.html" %}
        {% endwith %}
      {% else %}
        {% with class_name="images-count-more" %}
          {% include "forum/_post_images.html" %}
        {% endwith %}
      {% endif %}
    {% endwith %}
  {% endif %}

  <!-- === ‚≠êÔ∏è X√ìA KH·ªêI CODE B·ªä L·∫∂P ·ªû ƒê√ÇY ‚≠êÔ∏è === -->
  <!--
      {% if image_count == 1 %}
        ... (TO√ÄN B·ªò KH·ªêI CODE C≈® ƒê√É B·ªä X√ìA) ...
      {% endif %}
  -->
  <!-- === H·∫æT X√ìA === -->


  <div class="actions" style="display:flex;align-items:center;gap:12px;margin-top:12px">
    <div class="vote-box" data-post="{{ post.post_id }}">
      <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
      <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
    </div>

    <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
      <i class="fa-solid fa-flag"></i> B√°o c√°o
    </button>
  </div>

  {% include "forum/_report_modal.html" with post=post %}
</article>

<!-- ... (Ph·∫ßn b√¨nh lu·∫≠n gi·ªØ nguy√™n) ... -->
<section class="comment-section" style="max-width:780px; margin:20px auto 0 auto;">
  <hr style="border:none;border-top:1px solid #eef2f7;margin:16px 0">
  <h3 style="color:#003459;margin:0 0 8px 0">B√¨nh lu·∫≠n ({{ comments|length }})</h3>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="comment" value="1">
    {{ comment_form.content }}
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn-primary" type="submit">ƒêƒÉng</button>
    </div>
  </form>

  <div style="display:flex;flex-direction:column;gap:10px;margin-top:16px">
    {% for c in comments %}
    <div class="comment-box" id="comment-{{ c.id }}" style="background:#f9fafb;padding:10px 12px;border-radius:12px;position:relative;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <strong style="color:#003459">{{ c.username.username }}</strong>
          <small style="color:#64748b"> ‚Ä¢ {{ c.created_at|date:"d/m/Y H:i" }}</small>
        </div>

        {% if c.username == request.user %}
        <div class="comment-menu-wrapper" style="position:relative;">
          <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
          <div class="comment-menu">
            <button class="menu-item js-edit-comment" data-id="{{ c.id }}">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
            <button class="menu-item js-delete-comment" data-id="{{ c.id }}">üóëÔ∏è X√≥a</button>
          </div>
        </div>
        {% else %}
        <div class="comment-menu-wrapper" style="position:relative;">
          <button class="comment-menu-btn" style="background:none;border:none;font-size:18px;color:#64748b;cursor:pointer;">‚ãØ</button>
          <div class="comment-menu">
            <button class="menu-item js-open-report-comment" data-target="report-comment-{{ c.id }}">üö© B√°o c√°o</button>
          </div>
        </div>
        {% endif %}
      </div>
      <div class="comment-content" style="margin-top:6px;">{{ c.content|linebreaksbr }}</div>
      {% include "forum/_report_comment_modal.html" with comment=c %}
    </div>
    {% endfor %}
  </div>
</section>

<!-- === ‚≠êÔ∏è TH√äM HTML CHO LIGHTBOX (MODAL ·∫¢NH) ‚≠êÔ∏è === -->
<div id="image-lightbox" class="lightbox">
  <span class="lightbox-close">&times;</span>
  <img class="lightbox-content" id="lightbox-img">
  <a class="lightbox-prev" id="lightbox-prev">&#10094;</a>
  <a class="lightbox-next" id="lightbox-next">&#10095;</a>
</div>
<!-- === H·∫æT HTML LIGHTBOX === -->

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

  // === H√ÄM L·∫§Y CSRF TOKEN ===
  function getCookie(name) {
    let v = null;
    if (document.cookie && document.cookie !== '') {
      const c = document.cookie.split(';');
      for (let i = 0; i < c.length; i++) {
        const s = c[i].trim();
        if (s.substring(0, name.length + 1) === (name + '=')) {
          v = decodeURIComponent(s.substring(name.length + 1));
          break;
        }
      }
    }
    return v;
  }
  const csrftoken = getCookie('csrftoken');

  // === VOTE B√ÄI VI·∫æT ===
  document.querySelectorAll('.vote-box').forEach(box => {
    const buttons = box.querySelectorAll('.js-vote');
    const countEl = box.querySelector('.js-count');
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const type = btn.dataset.type;
        const postId = box.dataset.post;
        const url = `/forum/${postId}/react/${type}/`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (res.ok) {
          const data = await res.json();
          countEl.textContent = data.total_votes ?? 0;
          buttons.forEach(b => b.classList.remove('active-up', 'active-down'));
          if (data.reaction === 'upvote') box.querySelector('[data-type="upvote"]').classList.add('active-up');
          if (data.reaction === 'downvote') box.querySelector('[data-type="downvote"]').classList.add('active-down');
        }
      });
    });
  });

  // === ‚≠êÔ∏è LOGIC M·ªöI CHO LIGHTBOX ‚≠êÔ∏è ===
  let lightboxImages = [];
  let currentImageIndex = 0;
  const lightbox = document.getElementById('image-lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const lightboxClose = document.querySelector('.lightbox-close');

  function openLightbox(postElement, clickedImgSrc) {
    // 1. T√¨m t·∫•t c·∫£ ·∫£nh trong c√πng 1 b√†i post
    lightboxImages = [];
    // L·∫•y T·∫§T C·∫¢ ·∫£nh, bao g·ªìm c·∫£ c√°i b·ªã ·∫©n (trong tr∆∞·ªùng h·ª£p 5+)
    postElement.querySelectorAll('.js-lightbox-trigger').forEach(img => {
      lightboxImages.push(img.src);
    });

    if (lightboxImages.length === 0) return;

    // 2. T√¨m index c·ªßa ·∫£nh ƒë∆∞·ª£c click
    currentImageIndex = lightboxImages.findIndex(src => src === clickedImgSrc);

    // 3. C·∫≠p nh·∫≠t UI v√† hi·ªÉn th·ªã
    updateLightboxImage();
    lightbox.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Ch·ªëng cu·ªôn trang
  }

  function updateLightboxImage() {
    if (lightboxImages.length === 0) return;
    lightboxImg.src = lightboxImages[currentImageIndex];

    // Ch·ªâ hi·ªÉn th·ªã n√∫t next/prev n·∫øu c√≥ nhi·ªÅu h∆°n 1 ·∫£nh
    const hasMultiple = lightboxImages.length > 1;
    lightboxPrev.style.display = hasMultiple ? 'block' : 'none';
    lightboxNext.style.display = hasMultiple ? 'block' : 'none';
  }

  function showNextImage() {
    currentImageIndex = (currentImageIndex + 1) % lightboxImages.length;
    updateLightboxImage();
  }

  function showPrevImage() {
    currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length;
    updateLightboxImage();
  }

  function closeLightbox() {
    lightbox.style.display = 'none';
    lightboxImages = []; // X√≥a cache ·∫£nh
    document.body.style.overflow = 'auto'; // Cho ph√©p cu·ªôn l·∫°i
  }

  // --- Th√™m Event Listeners cho Lightbox ---
  if(lightbox) {
    lightboxNext.addEventListener('click', showNextImage);
    lightboxPrev.addEventListener('click', showPrevImage);
    lightboxClose.addEventListener('click', closeLightbox);
    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) { // Ch·ªâ ƒë√≥ng khi click v√†o n·ªÅn ƒëen
        closeLightbox();
      }
    });
  }
  // --- H·∫øt Logic Lightbox ---


  // === CLICK TO√ÄN TRANG ===
  document.addEventListener('click', async (e) => {
    const allMenus = document.querySelectorAll('.comment-menu');
    const btn = e.target.closest('.comment-menu-btn');

    // ‚≠êÔ∏è M·ªöI: M·ªü Lightbox
    // Ph·∫£i ƒë·∫∑t listener n√†y *b√™n trong* click event ch√≠nh
    const imgTrigger = e.target.closest('.js-lightbox-trigger');
    if (imgTrigger) {
      e.preventDefault();
      const postContainer = imgTrigger.closest('.post-images');
      openLightbox(postContainer, imgTrigger.src);
      return; // D·ª´ng l·∫°i, kh√¥ng ch·∫°y logic kh√°c
    }

    // 1Ô∏è‚É£ Menu ba ch·∫•m
    if (btn) {
      e.stopPropagation();
      const menu = btn.parentElement.querySelector('.comment-menu');
      allMenus.forEach(m => { if (m !== menu) m.style.display = 'none'; });
      const isOpen = menu.style.display === 'block';
      menu.style.display = isOpen ? 'none' : 'block';

      if (!isOpen) {
        menu.style.visibility = 'hidden';
        menu.style.display = 'block';
        const rect = menu.getBoundingClientRect();
        const bottomOverflow = rect.bottom > window.innerHeight;
        if (bottomOverflow || (window.innerHeight - rect.bottom) < 20) {
          menu.classList.add('menu-up');
        } else {
          menu.classList.remove('menu-up');
        }
        menu.style.display = 'none';
        menu.style.visibility = '';
        menu.style.display = 'block';
      }
      return;
    }
    // 2Ô∏è‚É£ Click ngo√†i menu ‚Üí ƒë√≥ng
    if (!e.target.closest('.comment-menu-wrapper')) {
      allMenus.forEach(m => m.style.display = 'none');
    }

    // 3Ô∏è‚É£ M·ªü modal b√°o c√°o
    const reportBtn = e.target.closest('.js-open-report') || e.target.closest('.js-open-report-comment');
    if (reportBtn) {
      const id = reportBtn.getAttribute('data-target');
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'flex';
      return;
    }

    // 4Ô∏è‚É£ ƒê√≥ng modal
    const modal = e.target.closest('.modal');
    if (modal && (e.target === modal || e.target.hasAttribute('data-close'))) {
      modal.style.display = 'none';
      return;
    }

    // 5Ô∏è‚É£ Ch·ªânh s·ª≠a b√¨nh lu·∫≠n
    if (e.target.classList.contains('js-edit-comment')) {
      const id = e.target.dataset.id;
      const box = document.getElementById(`comment-${id}`);
      const div = box.querySelector('.comment-content');
      const oldHtml = div.innerHTML;
      const text = oldHtml.replace(/<br\s*\/?>/ig, "\n").trim();
      div.innerHTML = `
        <form class="edit-form" data-id="${id}">
          <textarea rows="3" class="form-control" style="width:100%;border:1px solid #e2e8f0;border-radius:8px;padding:6px;">${text}</textarea>
          <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px;">
            <button type="button" class="btn-ghost js-cancel-edit">H·ªßy</button>
            <button type="submit" class="btn-primary">L∆∞u</button>
          </div>
        </form>`;
      div.querySelector('.edit-form').dataset.oldHtml = oldHtml;
      return;
    }

    // 6Ô∏è‚É£ H·ªßy ch·ªânh s·ª≠a
    if (e.target.classList.contains('js-cancel-edit')) {
      const form = e.target.closest('.edit-form');
      const old = form.dataset.oldHtml;
      form.parentElement.innerHTML = old;
      return;
    }

    // 7Ô∏è‚É£ Submit ch·ªânh s·ª≠a
    if (e.target.closest('.edit-form') && e.target.type === 'submit') {
      e.preventDefault();
      const form = e.target.closest('.edit-form');
      const id = form.dataset.id;
      const newContent = form.querySelector('textarea').value;
      const res = await fetch(`/forum/comment/${id}/edit/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ content: newContent })
      });
      if (res.ok) {
        const data = await res.json();
        form.parentElement.innerHTML = data.new_content_html;
      } else alert('ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t b√¨nh lu·∫≠n.');
      return;
    }

    // 8Ô∏è‚É£ X√≥a b√¨nh lu·∫≠n
    if (e.target.classList.contains('js-delete-comment')) {
      const id = e.target.dataset.id;
      if (!confirm('üóëÔ∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y kh√¥ng?')) return;
      const res = await fetch(`/forum/comment/${id}/delete/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
      });
      if (res.ok) {
        const data = await res.json();
        if (data.status === 'deleted') {
          const el = document.getElementById(`comment-${id}`);
          el.style.transition = 'opacity .3s';
          el.style.opacity = '0';
          setTimeout(() => el.remove(), 300);
        } else alert('Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n.');
      } else alert('ƒê√£ x·∫£y ra l·ªói khi x√≥a b√¨nh lu·∫≠n.');
      return;
    }
  });

  // === G·ª¨I FORM B√ÅO C√ÅO (AJAX) ===
  document.querySelectorAll('.js-report-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const postId = form.dataset.post;
      const formData = new FormData(form);
      const res = await fetch(`/forum/${postId}/report/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });
      if (res.ok) {
        alert('‚úÖ B√°o c√°o c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i. C·∫£m ∆°n b·∫°n!');
        form.closest('.modal').style.display = 'none';
        form.reset();
      } else alert('‚ö†Ô∏è L·ªói khi g·ª≠i b√°o c√°o.');
    });
  });

  // === AUTO RESIZE TEXTAREA ===
  const textarea = document.querySelector('textarea[name="content"]');
  if (textarea) {
    textarea.style.resize = 'none';
    textarea.style.overflowY = 'hidden';
    const autoGrow = el => {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    };
    textarea.addEventListener('input', () => autoGrow(textarea));
    autoGrow(textarea);
  }

});
</script>

<style>
/* üëá Fix comment d√†i b·ªã tr√†n, t·ª± xu·ªëng d√≤ng */
.comment-content {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
}
</style>
{% endblock %}