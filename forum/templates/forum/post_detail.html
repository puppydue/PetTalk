{% extends "base.html" %}
{% load static %}
{% load forum_extras %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/forum.css' %}">
<style>
/* === MENU COMMENT - ƒê·∫∏P H∆†N === */
.comment-menu {
  display: none;
  position: absolute;
  right: 0;
  top: 100%;
  margin-top: 6px;
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  min-width: 160px;
  z-index: 20;
  overflow: hidden;
  font-size: 14px;
}
.comment-menu .menu-item {
  display: flex;
  align-items: center;
  gap: 10px; /* TƒÉng gap ƒë·ªÉ c√≥ kh√¥ng gian cho icon */
  width: 100%;
  padding: 10px 14px;
  background: none;
  border: none;
  text-align: left;
  cursor: pointer;
  color: #334155;
  transition: background 0.2s;
}
.comment-menu .menu-item i {
  width: 16px; /* C·ªë ƒë·ªãnh ƒë·ªô r·ªông icon */
  text-align: center;
  color: #64748b;
}
.comment-menu .menu-item:hover {
  background-color: #f8fafc;
}
.comment-menu .menu-item.danger:hover {
  background-color: #fef2f2;
  color: #dc2626;
}
.comment-menu .menu-item.danger:hover i {
  color: #dc2626;
}
.comment-menu .menu-item + .menu-item {
  border-top: 1px solid #f1f5f9;
}
.comment-menu.menu-up {
  top: auto !important;
  bottom: 100%;
  margin-bottom: 6px;
}

/* === N√öT ... (TRIGGER MENU) - N√ÇNG C·∫§P GI·ªêNG H√åNH ·∫¢NH === */
.comment-menu-btn {
  background: #fff;
  border: 1px solid #e2e8f0; /* Th√™m vi·ªÅn */
  font-size: 14px; /* Ch·ªânh size icon */
  color: #64748b; /* M√†u icon */
  cursor: pointer;
  padding: 0; /* Reset padding */
  border-radius: 10px; /* Bo tr√≤n gi·ªëng h√¨nh */
  transition: all 0.2s;
  width: 36px; /* K√≠ch th∆∞·ªõc n√∫t */
  height: 36px;
  display: flex; /* CƒÉn gi·ªØa icon */
  align-items: center;
  justify-content: center;
  line-height: 1;
}
.comment-menu-btn:hover {
  background-color: #f8fafc; /* ƒê·ªïi m√†u n·ªÅn khi hover */
  color: #003459;
  border-color: #cbd5e1;
}

/* === AVATAR === */
.avatar {
  width: 40px;
  height: 40px;
  border-radius: 9999px;
  background: #003459;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  overflow: hidden;
  flex-shrink: 0;
}
.avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* === ‚úÖ TH√äM M·ªöI: CSS CHO CHIP DANH HI·ªÜU ƒêA M√ÄU === */
.badge-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 8px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 10px;
    border: 1px solid;
    cursor: default;
    transition: all 0.2s ease-out;
    animation: badgeGlow 3s ease-in-out infinite;
}
.badge-chip:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    animation: none;
}
@keyframes badgeGlow {
  0%, 100% { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  50% { box-shadow: 0 3px 8px rgba(0,0,0,0.08); }
}
/* C√°c m√†u cho chip */
.badge-color-gold { background: #fff4c2; border-color: #f7d98b; color: #8a5a00; }
.badge-color-blue { background: #e0f2fe; border-color: #7dd3fc; color: #0369a1; }
.badge-color-green { background: #dcfce7; border-color: #86efac; color: #15803d; }
.badge-color-red { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
.badge-color-cyan { background: #cffafe; border-color: #67e8f9; color: #0e7490; }
.badge-color-lime { background: #f7fee7; border-color: #bef264; color: #4d7c0f; }
/* === H·∫æT CSS M·ªöI === */


/* === COMMENT TEXT === */
.comment-content {
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.5;
  color: #1e293b;
  margin-top: 6px;
}

/* === TEXTAREA CH√çNH === */
textarea[name="content"] {
  width: 100%;
  min-height: 50px;
  max-height: 500px;
  padding: 10px 12px;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  resize: none;
  font-family: inherit;
  line-height: 1.5;
  overflow-y: hidden;
}

/* === EDIT FORM - ƒê·∫∏P, TR·ª∞C QUAN === */
.edit-form-container {
  margin-top: 10px;
  animation: slideDown 0.2s ease;
}

.edit-form {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.edit-form textarea {
  width: 100%;
  min-height: 80px;
  max-height: 180px;
  padding: 10px 12px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  resize: none;
  font-family: inherit;
  line-height: 1.5;
  margin-bottom: 8px;
  outline: none;
  transition: border 0.2s;
}
.edit-form textarea:focus {
  border-color: #003459;
}

.edit-help-text {
  font-size: 12px;
  color: #64748b;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.edit-help-text .old {
  color: #94a3b8;
  font-style: italic;
}

.edit-form .btn-group {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* === (B·∫ÆT ƒê·∫¶U) CSS SAO CH√âP T·ª™ POST_LIST.HTML === */

/* === Khu v·ª±c vote + actions === */
.actions {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 12px;
}
.vote-btn {
  width: 42px;
  height: 42px;
  border-radius: 10px;
  border: 1px solid #cbd5e1;
  background: #f8fafc;
  color: #003459;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.25s ease;
}
.vote-btn:hover { background: #f7dba7; }
.vote-count {
  font-weight: 700;
  font-size: 15px;
  min-width: 28px;
  text-align: center;
  color: #003459;
}
.vote-btn.active-up { background: #ff4500; color: #fff; border-color: #ff4500; }
.vote-btn.active-down { background: #6a5cff; color: #fff; border-color: #6a5cff; }

/* === N√∫t v√† button (cho n√∫t B√°o c√°o) === */
.btn-ghost {
  border: 1px solid #003459;
  color: #003459;
  background: #fff;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  text-decoration: none !important;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.25s ease;
}
.btn-ghost:hover { background: #f7dba7; border-color: #003459; }
/* N√∫t primary ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n cho c√°c n√∫t kh√°c */
.btn-primary {
  border: none;
  color: #fff;
  background: #003459;
  padding: 8px 14px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.25s ease;
}
.btn-primary:hover { background: #00509e; }

/* === (K·∫æT TH√öC) CSS SAO CH√âP T·ª™ POST_LIST.HTML === */


/* === LIGHTBOX === */
.post-images { display: grid; gap: 4px; border-radius: 12px; overflow: hidden; margin-top: 15px; }
.image-wrapper { position: relative; width: 100%; height: 100%; background: #f8fafc; }
.post-images img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
.post-images img:hover { transform: scale(1.03); }

.images-count-1 { display: flex; justify-content: center; max-height: 450px; }
.images-count-1 img { position: relative; object-fit: contain; max-height: 450px; width: auto; max-width: 100%; cursor: zoom-in; }
.images-count-2 { grid-template-columns: 1fr 1fr; height: 300px; }
.images-count-3 { grid-template-columns: 2fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-3 .image-wrapper:first-child { grid-row: span 2; }
.images-count-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-more { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
.images-count-more .image-wrapper:nth-child(n+5) { display: none; }
.images-count-more .image-wrapper[data-more-count]::after {
  content: attr(data-more-count);
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6); color: white; display: flex;
  align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; cursor: pointer;
}

.lightbox {
  position: fixed; z-index: 9990; padding-top: 50px; left: 0; top: 0;
  width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);
  display: none; animation: fadeIn 0.3s ease;
}
.lightbox-content { margin: auto; display: block; max-width: 90%; max-height: 85vh; animation: zoom 0.3s ease; }
.lightbox-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
.lightbox-close:hover { color: #bbb; }

.lightbox-prev, .lightbox-next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  margin-top: -50px;
  color: white;
  font-weight: bold;
  font-size: 30px;
  user-select: none;
}
.lightbox-next { right: 0; border-radius: 3px 0 0 3px; }
.lightbox-prev { left: 0; }
.lightbox-prev:hover, .lightbox-next:hover { background-color: rgba(255,255,255,0.2); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes zoom { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
</style>
{% endblock %}

{% block title %}B√†i vi·∫øt ‚Ä¢ {{ post.title }}{% endblock %}

{% block content %}
{% reaction_of post request.user as me_react %}

<article class="post-card" style="max-width:780px;margin:0 auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);">
  <div class="user-info" style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
    <div class="avatar">
      {% if post.username.userprofile.avatar_image %}
        <img src="{{ post.username.userprofile.avatar_image.url }}" alt="avatar">
      {% else %}
        {{ post.username.username|slice:":1"|upper }}
      {% endif %}
    </div>
    <div style="display:flex;flex-direction:column;">
      <div style="display:flex; align-items:center; gap:8px; font-weight:700; color:#003459; font-size:15px;">
        {{ post.username.username }}

        {% if post.username.userprofile.display_badge %}
            {% with badge=post.username.userprofile.display_badge %}
            <span class="badge-chip badge-color-{{ badge.color }}">
                {{ badge.icon }}
                {{ badge.name }}
            </span>
            {% endwith %}
        {% endif %}
      </div>
      <small style="color:#64748b;font-size:13px;">{{ post.created_at|date:"d/m/Y H:i" }}</small>
    </div>
  </div>

  <h1 class="post-title" style="font-size:22px;margin:8px 0">{{ post.title }}</h1>
  <div class="post-content" style="line-height:1.6;color:#1e293b;">{{ post.content|linebreaksbr }}</div>

  {% if post.images.all %}
    {% with all_images=post.images.all %}
      {% with image_count=all_images|length %}
        {% if image_count == 1 %}
          {% with class_name="images-count-1" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper">
                <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
              </div>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif image_count == 2 %}
          {% with class_name="images-count-2" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper">
                <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
              </div>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif image_count == 3 %}
          {% with class_name="images-count-3" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper">
                <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
              </div>
              {% endfor %}
            </div>
          {% endwith %}
        {% elif image_count == 4 %}
          {% with class_name="images-count-4" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images %}
              <div class="image-wrapper">
                <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
              </div>
              {% endfor %}
            </div>
          {% endwith %}
        {% else %}
          {% with class_name="images-count-more" %}
            <div class="post-images {{ class_name }}">
              {% for img in all_images|slice:":4" %}
              <div class="image-wrapper"
                   {% if forloop.last %}data-more-count="+{{ image_count|add:"-4" }}"{% endif %}>
                <img src="{{ img.image.url }}" alt="Post image {{ forloop.counter }}" class="js-lightbox-trigger">
              </div>
              {% endfor %}
              <div style="display:none;">
                {% for img in all_images|slice:"4:" %}
                  <img src="{{ img.image.url }}" class="js-lightbox-trigger">
                {% endfor %}
              </div>
            </div>
          {% endwith %}
        {% endif %}
      {% endwith %}
    {% endwith %}
  {% endif %}
  <div class="actions">
    <div class="vote-box" data-post="{{ post.post_id }}">
      <button class="vote-btn js-vote {% if me_react == 'upvote' %}active-up{% endif %}" data-type="upvote">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
      <span class="vote-count js-count">{{ post.total_vote|default:0 }}</span>
      <button class="vote-btn js-vote {% if me_react == 'downvote' %}active-down{% endif %}" data-type="downvote">
        <i class="fa-solid fa-arrow-down"></i>
      </button>
    </div>

    <button class="btn-ghost js-open-report" data-target="report-{{ post.post_id }}">
      <i class="fa-solid fa-flag"></i> B√°o c√°o
    </button>
  </div>
  {% include "forum/_report_modal.html" with post=post %}
</article>

<section class="comment-section" style="max-width:780px;margin:20px auto 0;">
  <hr style="border:none;border-top:1px solid #eef2f7;margin:16px 0">
  <h3 style="color:#003459;margin:0 0 8px 0;font-size:18px">B√¨nh lu·∫≠n ({{ comments|length }})</h3>

  <form method="post" style="margin-bottom:16px">
    {% csrf_token %}
    <input type="hidden" name="comment" value="1">
    {{ comment_form.content }}
    <div style="display:flex;justify-content:flex-end;margin-top:8px">
      <button class="btn-primary" type="submit">ƒêƒÉng</button>
    </div>
  </form>

  <div style="display:flex;flex-direction:column;gap:12px">
    {% for c in comments %}
    <div class="comment-box" id="comment-{{ c.id }}" style="background:#f9fafb;padding:12px 14px;border-radius:16px;position:relative;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="avatar">
            {% if c.username.userprofile.avatar_image %}
              <img src="{{ c.username.userprofile.avatar_image.url }}" alt="avatar">
            {% else %}
              {{ c.username.username|slice:":1"|upper }}
            {% endif %}
          </div>
          <div>
            <div style="display:flex; align-items:center; gap:8px; font-weight:700; color:#003459; font-size:15px;">
                {{ c.username.username }}

                {% if c.username.userprofile.display_badge %}
                    {% with badge=c.username.userprofile.display_badge %}
                    <span class="badge-chip badge-color-{{ badge.color }}">
                        {{ badge.icon }}
                        {{ badge.name }}
                    </span>
                    {% endwith %}
                {% endif %}
            </div>
            <small style="color:#94a3b8;font-size:13px"> ‚Ä¢ {{ c.created_at|date:"d/m/Y H:i" }}</small>
          </div>
        </div>

        <div class="comment-menu-wrapper" style="position:relative;">
          <button class="comment-menu-btn" aria-label="Menu">
            <i class="fa-solid fa-ellipsis"></i>
          </button>
          <div class="comment-menu">
            {% if c.username == request.user %}
              <button type="button" class="menu-item js-edit-comment" data-id="{{ c.id }}">
                <i class="fa-solid fa-pen"></i> Ch·ªânh s·ª≠a
              </button>
              <button type="button" class="menu-item danger js-delete-comment" data-id="{{ c.id }}">
                <i class="fa-solid fa-trash"></i> X√≥a
              </button>
            {% else %}
              <button type="button" class="menu-item js-open-report-comment" data-target="report-comment-{{ c.id }}">
                <i class="fa-solid fa-flag"></i> B√°o c√°o
              </button>
            {% endif %}
          </div>
        </div>
        </div>

      <div class="comment-content">{{ c.content|linebreaksbr }}</div>
      {% include "forum/_report_comment_modal.html" with comment=c %}
    </div>
    {% endfor %}
  </div>
</section>

<div id="image-lightbox" class="lightbox">
  <span class="lightbox-close">√ó</span>
  <img class="lightbox-content" id="lightbox-img">
  <a class="lightbox-prev" id="lightbox-prev">&#10094;</a>
  <a class="lightbox-next" id="lightbox-next">&#10095;</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const csrftoken = document.cookie.split('; ')
    .find(row => row.startsWith('csrftoken='))?.split('=')[1];

  // === Auto grow ===
  const autoGrow = el => {
    if (!el) return;
    const maxHeight = parseInt(getComputedStyle(el).maxHeight, 10) || 0;
    el.style.height = 'auto';
    const scrollHeight = el.scrollHeight;
    el.style.height = (maxHeight && scrollHeight > maxHeight)
      ? maxHeight + 'px' : scrollHeight + 'px';
    el.style.overflowY = (maxHeight && scrollHeight > maxHeight)
      ? 'auto' : 'hidden';
  };

  // === Main textarea auto grow ===
  const mainTextarea = document.querySelector('textarea[name="content"]');
  if (mainTextarea) {
    mainTextarea.addEventListener('input', () => autoGrow(mainTextarea));
    autoGrow(mainTextarea);
  }

  // === Vote ===
  document.querySelectorAll('.vote-box').forEach(box => {
    const buttons = box.querySelectorAll('.js-vote');
    const countEl = box.querySelector('.js-count');
    buttons.forEach(btn => {
      btn.addEventListener('click', async () => {
        const type = btn.dataset.type;
        const postId = box.dataset.post;
        const res = await fetch(`/forum/${postId}/react/${type}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (res.ok) {
          const data = await res.json();
          countEl.textContent = data.total_votes ?? 0;
          buttons.forEach(b => b.classList.remove('active-up', 'active-down'));
          if (data.reaction === 'upvote')
            box.querySelector('[data-type="upvote"]').classList.add('active-up');
          if (data.reaction === 'downvote')
            box.querySelector('[data-type="downvote"]').classList.add('active-down');
        }
      });
    });
  });

  // === Lightbox ===
  let lightboxImages = [], currentImageIndex = 0;
  const lightbox = document.getElementById('image-lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const lightboxClose = document.querySelector('.lightbox-close');

  if (lightbox && lightboxImg && lightboxPrev && lightboxNext && lightboxClose) {
    const openLightbox = (postElement, src) => {
      lightboxImages = Array.from(postElement.querySelectorAll('.js-lightbox-trigger')).map(img => img.src);
      currentImageIndex = lightboxImages.indexOf(src);
      updateLightboxImage();
      lightbox.style.display = 'block';
      document.body.style.overflow = 'hidden';
    };

    const updateLightboxImage = () => {
      lightboxImg.src = lightboxImages[currentImageIndex];
      const show = lightboxImages.length > 1;
      lightboxPrev.style.display = show ? 'block' : 'none';
      lightboxNext.style.display = show ? 'block' : 'none';
    };

    const closeLightbox = () => {
      lightbox.style.display = 'none';
      document.body.style.overflow = 'auto';
    };

    const nextImage = () => {
      if (lightboxImages.length > 1) {
        currentImageIndex = (currentImageIndex + 1) % lightboxImages.length;
        updateLightboxImage();
      }
    };

    const prevImage = () => {
      if (lightboxImages.length > 1) {
        currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length;
        updateLightboxImage();
      }
    };

    lightboxNext.onclick = nextImage;
    lightboxPrev.onclick = prevImage;
    lightboxClose.onclick = closeLightbox;
    lightbox.onclick = e => { if (e.target === lightbox) closeLightbox(); };

    document.addEventListener('keydown', e => {
      if (lightbox.style.display === 'block') {
        if (e.key === 'ArrowRight') nextImage();
        else if (e.key === 'ArrowLeft') prevImage();
        else if (e.key === 'Escape') closeLightbox();
      }
    });

    // === Main Click Handler (menus, modals, edit, delete, lightbox trigger) ===
    document.addEventListener('click', async e => {
      const allMenus = document.querySelectorAll('.comment-menu');
      const menuBtn = e.target.closest('.comment-menu-btn');

      // ·∫¢nh (bao g·ªìm +X)
      // ‚úÖ S·ª¨A L·ªñI: C·∫≠p nh·∫≠t JS cho +X
      const imgTrigger = e.target.closest('.js-lightbox-trigger, .image-wrapper[data-more-count]');
      if (imgTrigger) {
        e.preventDefault();
        let src;
        // N·∫øu click v√†o n√∫t +X, h√£y l·∫•y ·∫£nh ƒë·∫ßu ti√™n
        if (imgTrigger.hasAttribute('data-more-count')) {
            src = imgTrigger.closest('.post-images').querySelector('.js-lightbox-trigger').src;
        } else {
            // Ng∆∞·ª£c l·∫°i, l·∫•y ·∫£nh ƒë√£ click
            src = imgTrigger.src;
        }
        openLightbox(imgTrigger.closest('.post-images'), src);
        return;
      }


      // Menu "..."
      if (menuBtn) {
        e.stopPropagation();
        const menu = menuBtn.parentElement.querySelector('.comment-menu');
        const isOpen = menu.style.display === 'block';
        allMenus.forEach(m => { if (m !== menu) m.style.display = 'none'; });
        if (isOpen) { menu.style.display = 'none'; return; }
        menu.classList.remove('menu-up');
        menu.style.visibility = 'hidden';
        menu.style.display = 'block';
        const spaceBelow = window.innerHeight - menuBtn.getBoundingClientRect().bottom;
        if (spaceBelow < menu.offsetHeight + 20) menu.classList.add('menu-up');
        menu.style.visibility = 'visible';
        return;
      }

      // ƒê√≥ng menu khi click ra ngo√†i
      if (!e.target.closest('.comment-menu-wrapper')) allMenus.forEach(m => m.style.display = 'none');

      // M·ªü modal b√°o c√°o
      const reportBtn = e.target.closest('.js-open-report, .js-open-report-comment');
      if (reportBtn) {
        const targetId = reportBtn.dataset.target;
        if (targetId) document.getElementById(targetId).style.display = 'flex';
        return;
      }

      // ƒê√≥ng modal khi click ngo√†i / n√∫t h·ªßy
      const modal = e.target.closest('.modal');
      if (modal && (e.target === modal || e.target.hasAttribute('data-close'))) {
        modal.style.display = 'none';
        return;
      }

      // === Edit comment ===
      const editBtn = e.target.closest('.js-edit-comment');
      if (editBtn) {
        e.preventDefault();
        const id = editBtn.dataset.id;
        const commentBox = document.getElementById(`comment-${id}`);
        const contentDiv = commentBox.querySelector('.comment-content');
        if (commentBox.querySelector('.edit-form-container')) return;
        const rawText = contentDiv.textContent || contentDiv.innerText;
        const editContainer = document.createElement('div');
        editContainer.className = 'edit-form-container';
        editContainer.innerHTML = `
          <form class="edit-form" data-id="${id}">
            <div class="edit-help-text">
              <span>N·ªôi dung c≈©:</span>
              <span class="old">${rawText.replace(/\n/g, ' [Enter] ')}</span>
            </div>
            <textarea placeholder="Nh·∫≠p n·ªôi dung m·ªõi...">${rawText}</textarea>
            <div class="btn-group">
              <button type="button" class="btn-ghost js-cancel-edit">H·ªßy</button>
              <button type="submit" class="btn-primary">L∆∞u</button>
            </div>
          </form>`;
        commentBox.appendChild(editContainer);
        const textarea = editContainer.querySelector('textarea');
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
        textarea.addEventListener('input', () => autoGrow(textarea));
        autoGrow(textarea);
        return;
      }

      // H·ªßy Edit
      const cancelBtn = e.target.closest('.js-cancel-edit');
      if (cancelBtn) {
        e.preventDefault();
        cancelBtn.closest('.edit-form-container').remove();
        return;
      }

      // L∆∞u Edit
      const saveForm = e.target.closest('.edit-form');
      if (saveForm && e.target.type === 'submit') {
        e.preventDefault();
        const id = saveForm.dataset.id;
        const newContent = saveForm.querySelector('textarea').value.trim();
        if (!newContent) { alert('N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!'); return; }
        const res = await fetch(`/forum/comment/${id}/edit/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
          body: JSON.stringify({ content: newContent })
        });
        if (res.ok) {
          const data = await res.json();
          const commentBox = document.getElementById(`comment-${id}`);
          commentBox.querySelector('.comment-content').innerHTML = data.new_content_html;
          saveForm.closest('.edit-form-container').remove();
        } else {
          alert('L·ªói khi l∆∞u b√¨nh lu·∫≠n.');
        }
        return;
      }

      // X√≥a Comment
      const deleteBtn = e.target.closest('.js-delete-comment');
      if (deleteBtn) {
        if (!confirm('X√≥a b√¨nh lu·∫≠n n√†y?')) return;
        const id = deleteBtn.dataset.id;
        const res = await fetch(`/forum/comment/${id}/delete/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (res.ok) {
          const data = await res.json();
          if (data.status === 'deleted') {
            const el = document.getElementById(`comment-${id}`);
            el.style.transition = 'opacity .3s';
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
          }
        }
      }
    }); // end main click handler
  } // end lightbox check

  // === G·ª¨I FORM B√ÅO C√ÅO B√åNH LU·∫¨N ===
  document.addEventListener('submit', async e => {
    const form = e.target.closest('.js-report-form[data-comment]');
    if (!form) return;
    e.preventDefault();

    const commentId = form.dataset.comment;
    const url = `/forum/comment/${commentId}/report/`;
    const formData = new FormData(form);

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    });

    if (res.ok) {
      const data = await res.json();
      if (data.status === 'ok') {
        alert('‚úÖ G·ª≠i b√°o c√°o b√¨nh lu·∫≠n th√†nh c√¥ng!');
        form.closest('.modal').style.display = 'none';
        form.reset();
      } else alert('‚ùå L·ªói khi g·ª≠i b√°o c√°o.');
    } else alert('‚ùå L·ªói server khi g·ª≠i b√°o c√°o.');
  });
  // === G·ª¨I FORM B√ÅO C√ÅO B√ÄI VI·∫æT ===
  document.addEventListener('submit', async e => {
    const form = e.target.closest('.js-report-form[data-post]');
    if (!form || form.dataset.handled) return;  // üîπ NgƒÉn g·ªçi l·∫∑p
    form.dataset.handled = "true";              // üîπ ƒê√°nh d·∫•u ƒë√£ x·ª≠ l√Ω
    e.preventDefault();

    const postId = form.dataset.post;
    const url = `/forum/${postId}/report/`;
    const formData = new FormData(form);

    const res = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    });

    if (res.ok) {
      const data = await res.json();
      if (data.status === 'ok') {
        alert('‚úÖ G·ª≠i b√°o c√°o b√†i vi·∫øt th√†nh c√¥ng!');
        form.closest('.modal').style.display = 'none';
        form.reset();
      } else alert('‚ùå L·ªói khi g·ª≠i b√°o c√°o.');
    } else alert('‚ùå L·ªói server khi g·ª≠i b√°o c√°o.');

    delete form.dataset.handled; // cho ph√©p g·ª≠i l·∫°i sau n·∫øu c·∫ßn
  });
}); // END DOMContentLoaded
</script>

{% endblock %}