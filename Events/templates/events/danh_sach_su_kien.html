{% extends "base.html" %}
{% load static %}
{% block title %}S·ª± ki·ªán PetTalk{% endblock %}

{% block content %}

<div class="event-page-container fade-in-up">

  <!-- 1. HEADER -->
  <div class="event-header">
    <div class="header-text">
      <h2>üéâ Kh√°m ph√° S·ª± ki·ªán</h2>
      <p>Tham gia vui ch∆°i, offline c√πng c·ªông ƒë·ªìng th√∫ c∆∞ng</p>
    </div>
    <a href="{% url 'tao_su_kien' %}" class="btn-create-event pulse-effect">
      <i class="fa-solid fa-plus"></i> T·∫°o s·ª± ki·ªán m·ªõi
    </a>
  </div>

  <!-- 2. S·ª∞ KI·ªÜN C·ª¶A T√îI (CAROUSEL) -->
  {% if su_kien_cua_toi %}
  <section class="section-my-events">
    <div class="section-title">
      <h3><i class="fa-solid fa-user-gear"></i> S·ª± ki·ªán b·∫°n qu·∫£n l√Ω</h3>
      <div class="carousel-nav">
        <button onclick="scrollCarousel('myEventsCarousel', -1)"><i class="fa-solid fa-chevron-left"></i></button>
        <button onclick="scrollCarousel('myEventsCarousel', 1)"><i class="fa-solid fa-chevron-right"></i></button>
      </div>
    </div>

    <div class="carousel-wrapper">
      <div class="carousel-container" id="myEventsCarousel">
        {% for e in su_kien_cua_toi %}
          <!-- B·ªè class hover-lift, glass-card ƒë·ªÉ tr√°nh b√≥ng ƒë·ªï c·∫Øt vi·ªÅn -->
          <div class="event-card my-card">
            <!-- ·∫¢nh Cover -->
            <div class="card-cover">
              {% if e.image %}
                <img src="{{ e.image.url }}" alt="{{ e.title }}">
              {% else %}
                <div class="img-placeholder"><i class="fa-solid fa-image"></i></div>
              {% endif %}

              <div class="status-badge {{ e.status }}">
                {% if e.status == 'approved' %}ƒê√£ duy·ªát
                {% elif e.status == 'rejected' %}T·ª´ ch·ªëi
                {% else %}ƒêang ch·ªù{% endif %}
              </div>
            </div>

            <div class="card-body">
              <div class="date-box">
                <span class="day">{{ e.date|date:"d" }}</span>
                <span class="month">TH{{ e.date|date:"m" }}</span>
              </div>

              <div class="info-content">
                <h4 class="card-title">{{ e.title|truncatechars:40 }}</h4>
                <div class="meta-row">
                  <span><i class="fa-regular fa-clock"></i> {{ e.date|date:"H:i" }}</span>
                  <span><i class="fa-solid fa-users"></i> {{ e.participants.count }}/{{ e.capacity|default:"‚àû" }}</span>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="card-footer">
              {% if not e.is_past %}
                <div class="action-row">
                  <div class="icon-group">
                    <a href="{% url 'chinh_sua_su_kien' e.id %}" class="btn-icon edit" title="S·ª≠a">
                      <i class="fa-solid fa-pen"></i>
                    </a>
                    <a href="{% url 'xoa_su_kien' e.id %}" class="btn-icon delete" title="X√≥a">
                      <i class="fa-solid fa-trash"></i>
                    </a>
                  </div>

                  {% if e.status == 'approved' %}
                    <a href="{% url 'danh_sach_nguoi_dang_ky' e.id %}" class="btn-view-list">
                      DS Tham gia <i class="fa-solid fa-arrow-right"></i>
                    </a>
                  {% endif %}
                </div>
              {% else %}
                <!-- N√∫t "ƒê√£ k·∫øt th√∫c" ƒë·ªìng b·ªô k√≠ch th∆∞·ªõc -->
                <div class="ended-block">
                  <i class="fa-solid fa-hourglass-end"></i> ƒê√£ k·∫øt th√∫c
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- 3. S·ª∞ KI·ªÜN C·ªòNG ƒê·ªíNG (GRID) -->
  <section class="section-community">
    <div class="section-title">
      <h3><i class="fa-solid fa-fire"></i> S·ª± ki·ªán s·∫Øp di·ªÖn ra</h3>
    </div>

    {% if danh_sach_su_kien %}
    <div class="event-grid">

      <!-- L∆Ø·ª¢T 1: S·∫ÆP DI·ªÑN RA -->
      {% for e in danh_sach_su_kien|dictsort:"date" %}
        {% if not e.is_past %}
          <div class="event-card public-card">
            <div class="card-creator">
              <a href="{% url 'profiles:view_user_profile' e.creator.username %}" class="creator-link">
                <div class="creator-avatar">
                  {% if e.creator.userprofile.avatar_image %}
                    <img src="{{ e.creator.userprofile.avatar_image.url }}" alt="{{ e.creator.username }}">
                  {% else %}
                    <span>{{ e.creator.username|slice:":1"|upper }}</span>
                  {% endif %}
                </div>
                <div class="creator-info">
                  <span class="creator-name">{{ e.creator.username }}</span>
                </div>
              </a>
            </div>

            <div class="card-main">
              <div class="main-image">
                {% if e.image %}
                  <img src="{{ e.image.url }}" alt="{{ e.title }}">
                {% else %}
                  <img src="https://placehold.co/600x400/fff8ed/003459?text=PetTalk+Event" alt="No Image">
                {% endif %}
              </div>

              <div class="main-content">
                <h4 class="card-title-lg">{{ e.title }}</h4>

                <div class="event-details">
                  <p><i class="fa-solid fa-location-dot"></i> {{ e.location|default:"Ch∆∞a c·∫≠p nh·∫≠t ƒë·ªãa ƒëi·ªÉm"|truncatechars:30 }}</p>
                  <p><i class="fa-regular fa-calendar-check"></i> <strong>{{ e.date|date:"d/m/Y" }}</strong> l√∫c {{ e.date|date:"H:i" }}</p>
                  <p><i class="fa-solid fa-user-group"></i> ƒê√£ ƒëƒÉng k√Ω: <strong>{{ e.participants.count }}</strong> th√†nh vi√™n</p>
                </div>
              </div>
            </div>

            <div class="card-action-lg">
              {% if e.creator == user %}
                <a href="{% url 'danh_sach_nguoi_dang_ky' e.id %}" class="btn-lg owner">Qu·∫£n l√Ω danh s√°ch</a>
              {% elif user in e.participants.all %}
                <a href="{% url 'huy_dang_ky_tham_gia' e.id %}" class="btn-lg cancel">H·ªßy tham gia</a>
              {% else %}
                <a href="{% url 'dang_ky_tham_gia' e.id %}" class="btn-lg join">Tham gia ngay</a>
              {% endif %}
            </div>
          </div>
        {% endif %}
      {% endfor %}

      <!-- L∆Ø·ª¢T 2: ƒê√É K·∫æT TH√öC -->
      {% for e in danh_sach_su_kien|dictsortreversed:"date" %}
        {% if e.is_past %}
          <div class="event-card public-card faded">
            <div class="card-creator">
              <a href="{% url 'profiles:view_user_profile' e.creator.username %}" class="creator-link">
                <div class="creator-avatar">
                  {% if e.creator.userprofile.avatar_image %}
                    <img src="{{ e.creator.userprofile.avatar_image.url }}" alt="{{ e.creator.username }}">
                  {% else %}
                    <span>{{ e.creator.username|slice:":1"|upper }}</span>
                  {% endif %}
                </div>
                <div class="creator-info">
                  <span class="creator-name">{{ e.creator.username }}</span>
                </div>
              </a>
            </div>

            <div class="card-main">
              <div class="main-image grayscale">
                {% if e.image %}
                  <img src="{{ e.image.url }}" alt="{{ e.title }}">
                {% else %}
                  <img src="https://placehold.co/600x400/fff8ed/003459?text=PetTalk+Event" alt="No Image">
                {% endif %}
              </div>

              <div class="main-content">
                <h4 class="card-title-lg">{{ e.title }}</h4>
                <div class="event-details">
                  <p><i class="fa-solid fa-location-dot"></i> {{ e.location|default:"Ch∆∞a c·∫≠p nh·∫≠t ƒë·ªãa ƒëi·ªÉm"|truncatechars:30 }}</p>
                  <p><i class="fa-regular fa-calendar-check"></i> {{ e.date|date:"d/m/Y H:i" }}</p>
                </div>
              </div>
            </div>

            <div class="card-action-lg">
              <!-- N√∫t ƒê√£ k·∫øt th√∫c l√†m gi·ªëng h·ªát n√∫t Tham gia nh∆∞ng disabled -->
              <button class="btn-lg disabled-flat">
                <i class="fa-solid fa-lock"></i> ƒê√£ k·∫øt th√∫c
              </button>
            </div>
          </div>
        {% endif %}
      {% endfor %}

    </div>
    {% else %}
      <div class="empty-state">
        <i class="fa-regular fa-calendar-xmark" style="font-size: 48px; color: #cbd5e1; margin-bottom: 10px;"></i>
        <p>Ch∆∞a c√≥ s·ª± ki·ªán n√†o s·∫Øp di·ªÖn ra.</p>
      </div>
    {% endif %}
  </section>

</div>

<style>
/* --- 1. CONFIG CHUNG --- */
.event-page-container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 30px 20px;
  color: #003459;
}
h2, h3, h4 { color: #003459; }

/* --- 2. HEADER --- */
.event-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 40px; background: #ffffff; padding: 25px 30px;
  border-radius: 24px; border: 1px solid #e2e8f0;
  /* B·ªè b√≥ng ƒë·ªï n·∫øu kh√¥ng th√≠ch */
  /* box-shadow: 0 4px 20px rgba(0,0,0,0.02); */
}
.header-text h2 { margin: 0; font-weight: 800; font-size: 28px; }
.header-text p { margin: 5px 0 0; color: #64748b; font-weight: 600; font-size: 15px; }
.btn-create-event {
  background: #003459; color: #fff; padding: 12px 24px; border-radius: 12px;
  font-weight: 700; text-decoration: none; transition: 0.3s;
  box-shadow: 0 4px 10px rgba(0, 52, 89, 0.15); display: inline-flex; align-items: center; gap: 8px;
}
.btn-create-event:hover { background: #004e85; transform: translateY(-2px); }

/* --- 3. MY EVENTS --- */
.section-my-events { margin-bottom: 50px; padding: 10px 0; }
.section-title h3 { font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px; }

.carousel-nav button {
  width: 38px; height: 38px; border-radius: 50%; border: 1px solid #e2e8f0;
  background: #fff; color: #003459; cursor: pointer; transition: 0.2s;
}
.carousel-nav button:hover { background: #003459; color: #fff; }

.carousel-wrapper { overflow: hidden; padding: 10px 5px; }
.carousel-container { display: flex; gap: 20px; overflow-x: auto; scrollbar-width: none; scroll-behavior: smooth; }
.carousel-container::-webkit-scrollbar { display: none; }

/* === MY CARD - FIXED: B·ªé B√ìNG ƒê·ªî, B·ªé VI·ªÄN, B·ªé HOVER LIFT === */
.my-card {
  min-width: 290px; max-width: 290px;
  background: #fff;
  border-radius: 24px;
  border: 1px solid #eef2f6; /* Vi·ªÅn si√™u nh·∫°t thay v√¨ shadow */
  overflow: hidden;
  display: flex; flex-direction: column;

  /* Fix l·ªói render */
  transform: translateZ(0);
}

.card-cover { position: relative; height: 180px; }
.card-cover img { width: 100%; height: 100%; object-fit: cover; display: block; }

/* STATUS BADGE - L√ÄM R√ï H∆†N */
.status-badge {
  position: absolute; top: 12px; right: 12px; padding: 6px 14px;
  border-radius: 8px; /* Bo g√≥c vu√¥ng h∆°n x√≠u cho c·ª©ng c√°p */
  font-size: 12px; font-weight: 800; text-transform: uppercase;
  background: #fff; border: 2px solid transparent;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* B√≥ng nh·∫π ri√™ng cho badge */
}
.status-badge.approved { color: #047857; border-color: #d1fae5; background: #ecfdf5; }
.status-badge.rejected { color: #b91c1c; border-color: #fee2e2; background: #fff1f2; }
.status-badge.pending { color: #b45309; border-color: #fef3c7; background: #fffbeb; }

.card-body { padding: 20px; display: flex; gap: 14px; align-items: flex-start; }
.date-box {
  background: #fff8ed; border-radius: 14px;
  padding: 8px 12px; text-align: center; display: flex; flex-direction: column;
  min-width: 55px; height: fit-content; color: #003459;
}
.date-box .day { font-size: 22px; font-weight: 800; line-height: 1; margin-bottom: 2px; }
.date-box .month { font-size: 12px; font-weight: 700; color: #d97706; text-transform: uppercase; }

.info-content { flex: 1; }
.card-title { margin: 0 0 8px; font-size: 16px; font-weight: 700; color: #003459; line-height: 1.4; }
.meta-row { font-size: 13px; color: #64748b; display: flex; gap: 12px; font-weight: 500; }
.meta-row i { color: #003459; }

.card-footer { padding: 15px 20px; background: #fff; border-top: 1px solid #f8f8f8; }
.action-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
.icon-group { display: flex; gap: 10px; }

.btn-icon {
  width: 38px; height: 38px; border-radius: 50%; background: #f8fafc; border: 1px solid #e2e8f0;
  display: flex; align-items: center; justify-content: center; color: #64748b;
  transition: 0.2s; text-decoration: none !important;
}
.btn-icon:hover { background: #e0f2fe; color: #003459; border-color: #003459; }
.btn-icon.delete:hover { background: #fee2e2; color: #ef4444; }

.btn-view-list {
  font-size: 13px; font-weight: 700; color: #003459; text-decoration: none;
  background: #e0f2fe; padding: 10px 16px; border-radius: 20px; transition: 0.2s;
}
.btn-view-list:hover { background: #bae6fd; }

/* FIX: N√∫t "ƒê√£ k·∫øt th√∫c" trong My Events ngang h√†ng n√∫t kh√°c */
.ended-block {
  text-align: center; font-weight: 700; font-size: 13px; color: #64748b;
  padding: 10px 0; background: #f8fafc; border-radius: 12px; width: 100%;
}

/* 4. PUBLIC EVENTS */
.event-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 28px; }

/* B·ªè b√≥ng ƒë·ªï public card lu√¥n */
.public-card {
  background: #fff; border-radius: 24px;
  border: 1px solid #eef2f6; overflow: hidden; display: flex; flex-direction: column;
}
.public-card.faded { opacity: 0.8; background: #fafafa; }
.public-card.faded .grayscale { filter: grayscale(100%); }

.main-image { overflow: hidden; height: 180px; width: 100%; background: #fffcf5; }
.main-image img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s ease; }

.card-creator { padding: 14px 18px; border-bottom: 1px solid #fbfbfb; background: #fff; }
.creator-link { display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; transition: opacity 0.2s; }
.creator-link:hover { opacity: 0.8; }

.creator-avatar { width: 42px; height: 42px; border-radius: 50%; overflow: hidden; border: 2px solid #e0f2fe; }
.creator-avatar img { width: 100%; height: 100%; object-fit: cover; }
.creator-avatar span {
  width: 100%; height: 100%; background: #003459; color: #fff;
  display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;
}
.creator-name { font-size: 16px; font-weight: 700; color: #003459; }

.main-content { padding: 25px 20px 20px; flex: 1; }
.card-title-lg { font-size: 20px; font-weight: 800; color: #003459; margin: 0 0 18px; line-height: 1.35; }

.event-details p { margin: 12px 0; font-size: 14px; color: #334155; display: flex; align-items: center; gap: 12px; font-weight: 500; }
.event-details i { width: 18px; color: #003459; font-size: 16px; text-align: center; }

.card-action-lg { padding: 20px; background: #fff; border-top: 1px dashed #e2e8f0; }
.btn-lg {
  display: block; width: 100%; padding: 14px; text-align: center; border-radius: 12px;
  font-weight: 700; text-decoration: none; font-size: 15px; transition: 0.2s; box-sizing: border-box;
}
.btn-lg.join { background: #003459; color: #fff; margin-bottom: 4px; }
.btn-lg.join:hover { background: #004270; }

.btn-lg.cancel { background: #fff; border: 2px solid #fee2e2; color: #ef4444; }
.btn-lg.cancel:hover { background: #fef2f2; }

.btn-lg.owner { background: #e0f2fe; color: #003459; border: 2px solid transparent; }
.btn-lg.owner:hover { background: #bae6fd; }

/* FIX: N√∫t "ƒê√£ k·∫øt th√∫c" ph·∫≥ng, ngang h√†ng v·ªõi n√∫t tham gia */
.btn-lg.disabled-flat {
  background: #f1f5f9; color: #94a3b8; border: none; cursor: default;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}

.empty-state { text-align: center; padding: 60px 20px; background: #fff; border-radius: 20px; border: 2px dashed #e2e8f0; }

@media (max-width: 768px) {
  .event-header { flex-direction: column; align-items: flex-start; gap: 15px; }
  .btn-create-event { width: 100%; justify-content: center; }
}
</style>

<script>
function scrollCarousel(carouselId, direction) {
  const container = document.getElementById(carouselId);
  const scrollAmount = 320;
  container.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
}
</script>

{% endblock %}