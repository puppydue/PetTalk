{% extends "base.html" %}
{% block title %}Danh s√°ch s·ª± ki·ªán{% endblock %}
{% block content %}

<div class="event-list">

  <div class="create-event-wrapper">
    <a href="{% url 'tao_su_kien' %}" class="create-event-btn"> T·∫°o s·ª± ki·ªán m·ªõi</a>
  </div>

  <h2> Danh s√°ch s·ª± ki·ªán</h2>

  <!-- üë§ S·ª∞ KI·ªÜN C·ª¶A T√îI -->
  <section class="my-events">
    <h3> S·ª± ki·ªán c·ªßa t√¥i</h3>

    {% if su_kien_cua_toi %}
    <div class="carousel-wrapper">
      <button class="carousel-btn left" onclick="scrollCarousel('myEventsCarousel', -1)">&#10094;</button>

      <div class="carousel-container" id="myEventsCarousel">
        {% for e in su_kien_cua_toi %}
          <div class="event-card">

            <!-- ‚≠ê FIX ƒê·ªíNG B·ªò ·∫¢NH & KHUNG TR·ªêNG -->
            {% if e.image %}
              <img src="{{ e.image.url }}" alt="{{ e.title }}"
                   style="width:100%;height:140px;object-fit:cover;border-radius:12px;margin-bottom:12px;">
            {% else %}
              <div style="
                  width:100%;
                  height:140px;
                  border-radius:12px;
                  margin-bottom:12px;
                  background:#f3f4f6;
                  border:2px dashed #cbd5e1;">
              </div>
            {% endif %}
            <!-- ‚≠ê END FIX -->

            <h4>{{ e.title }}</h4>
            <p>{{ e.description|truncatechars:80 }}</p>
            <p><strong>Th·ªùi gian:</strong> {{ e.date|date:"d/m/Y H:i" }}</p>
            <p><strong>üë• S·ªë l∆∞·ª£ng:</strong> {{ e.participants.count }} / {{ e.capacity|default:"‚àû" }}</p>

            <div class="status-wrapper">
              <strong>Tr·∫°ng th√°i:</strong>
              {% if e.status == 'approved' %}
                <span class="status-badge status-approved"> ƒê√£ ph√™ duy·ªát</span>
              {% elif e.status == 'rejected' %}
                <span class="status-badge status-rejected"> B·ªã t·ª´ ch·ªëi</span>
              {% else %}
                <span class="status-badge status-pending"> Ch·ªù ph√™ duy·ªát</span>
              {% endif %}
            </div>

            {% if not e.is_past %}
              <div class="event-actions">
                <div>
                  <a href="{% url 'chinh_sua_su_kien' e.id %}" class="edit-btn">Ch·ªânh s·ª≠a</a>
                  <a href="{% url 'xoa_su_kien' e.id %}" class="cancel-btn">X√≥a</a>
                </div>

                {% if e.status == 'approved' %}
                  <div style="margin-top: 10px;">
                    <a href="{% url 'danh_sach_nguoi_dang_ky' e.id %}" class="view-btn">
                      Xem danh s√°ch ng∆∞·ªùi tham gia
                    </a>
                  </div>
                {% endif %}
              </div>
            {% else %}
              <div class="event-ended"> S·ª± ki·ªán ƒë√£ k·∫øt th√∫c</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <button class="carousel-btn right" onclick="scrollCarousel('myEventsCarousel', 1)">&#10095;</button>

      <div class="carousel-fade left-fade"></div>
      <div class="carousel-fade right-fade"></div>
    </div>
    {% else %}
      <p>B·∫°n ch∆∞a t·∫°o s·ª± ki·ªán n√†o.</p>
    {% endif %}
  </section>

  <!-- üåç DANH S√ÅCH S·ª∞ KI·ªÜN -->
  <section class="community-events">
    <h3> Danh s√°ch s·ª± ki·ªán</h3>

    {% if danh_sach_su_kien %}
    <div class="event-grid">
      {% for e in danh_sach_su_kien %}
        <div class="event-card">
          {% if e.image %}
            <img src="{{ e.image.url }}" alt="{{ e.title }}">
          {% endif %}

          <h4>{{ e.title }}</h4>

          <p class="creator-highlight">
            üë§ T·∫°o b·ªüi: <span class="highlight-username">{{ e.creator.username }}</span>
          </p>

          <p>{{ e.description|truncatechars:80 }}</p>
          <p><strong>üìç ƒê·ªãa ƒëi·ªÉm:</strong> {{ e.location }}</p>
          <p><strong>üïì Th·ªùi gian:</strong> {{ e.date|date:"d/m/Y H:i" }}</p>
          <p>
            <strong>üë• S·ªë l∆∞·ª£ng:</strong>
            {{ e.participants.count }} / {{ e.capacity|default:"‚àû" }} ng∆∞·ªùi tham gia
          </p>

          {% if e.is_past %}
            <div class="event-ended">üïì S·ª± ki·ªán ƒë√£ k·∫øt th√∫c</div>
          {% else %}
            {% if e.creator == user %}
              <a href="{% url 'danh_sach_nguoi_dang_ky' e.id %}" class="view-btn">
                Xem danh s√°ch ng∆∞·ªùi tham gia
              </a>
            {% elif user in e.participants.all %}
              <a href="{% url 'huy_dang_ky_tham_gia' e.id %}" class="cancel-btn">
                H·ªßy ƒëƒÉng k√Ω
              </a>
            {% else %}
              <a href="{% url 'dang_ky_tham_gia' e.id %}" class="join-btn"> Tham gia</a>
            {% endif %}
          {% endif %}
        </div>
      {% endfor %}
    </div>
    {% else %}
      <p>Ch∆∞a c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ph√™ duy·ªát.</p>
    {% endif %}
  </section>
</div>

<!-- ‚≠ê CSS -->
<style>
.main-content .event-list {
  width: 100%;
  max-width: 100%;
  margin: 0;
  padding: 20px;
  background: none;
  border: none;
  box-sizing: border-box;
}

.carousel-wrapper {
  position: relative;
  margin-bottom: 40px;
  overflow: hidden;
  padding: 0 105px;
}

.carousel-fade { position: absolute; top: 0; bottom: 0; width: 50px; pointer-events: none; z-index: 10; }
.left-fade { left: 0; background: linear-gradient(to right, #fff8ed, rgba(255,248,237,0)); }
.right-fade { right: 0; background: linear-gradient(to left, #fff8ed, rgba(255,248,237,0)); }

.carousel-container { display: flex; overflow-x: auto; scroll-behavior: smooth; gap: 25px; padding: 10px 0; scrollbar-width: none; }
.carousel-container::-webkit-scrollbar { display: none; }

.carousel-btn { background: #ffb84d; border: none; color: white; font-size: 20px; padding: 8px 12px; border-radius: 50%; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.15); position: absolute; top: 50%; transform: translateY(-50%); z-index: 11; }
.carousel-btn:hover { background: #ff9800; transform: translateY(-50%) scale(1.1); }
.left { left: 5px; }
.right { right: 5px; }

.status-wrapper { margin-top: 15px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
.status-badge { padding: 4px 10px; border-radius: 20px; font-weight: 600; font-size: 13px; }
.status-badge.status-approved { background: #dcfce7; color: #166534; }
.status-badge.status-pending { background: #fef9c3; color: #713f12; }
.status-badge.status-rejected { background: #fee2e2; color: #991b1b; }

.creator-highlight { font-size: 14px; margin-bottom: 6px; }
.creator-highlight .highlight-username {
  background: #e0f2fe;
  color: #003459;
  padding: 4px 10px;
  border-radius: 8px;
  font-weight: 600;
}

.event-card { flex: 0 0 280px; background: #ffffff; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 18px; border: 1.5px solid #003459; transition: 0.3s; display: flex; flex-direction: column; min-height: 350px; }
.event-card:hover { transform: translateY(-4px); box-shadow: 0 6px 14px rgba(0,0,0,0.15); }

.event-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 12px; margin-bottom: 10px; }

.event-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; }

.edit-btn, .join-btn, .view-btn, .cancel-btn, .delete-btn {
  padding: 8px 14px; border-radius: 8px; font-weight: 600; text-decoration: none; transition: 0.25s;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.edit-btn { background: linear-gradient(135deg, #ffb84d, #ff9800); color: white; }
.delete-btn { background: linear-gradient(135deg, #b71c1c, #f44336); color: white; }
.join-btn, .view-btn { background: #003459; color: white; }
.view-btn { background: linear-gradient(135deg, #6ba6ff, #1e88e5); }
.cancel-btn { background: linear-gradient(135deg, #ff6b6b, #ff4757); color: white; }

.event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }

.create-event-wrapper { justify-content: flex-end; display: flex; margin-bottom: 10px; }
.create-event-btn { background: linear-gradient(135deg, #4CAF50, #2E7D32); padding: 10px 18px; border-radius: 10px; color: white; font-weight: 600; text-decoration: none; }

.event-ended { text-align: center; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px dashed #bbb; }
</style>

<script>
function scrollCarousel(carouselId, direction) {
  const container = document.getElementById(carouselId);
  const scrollAmount = container.offsetWidth * 0.8;
  container.scrollBy({ left: scrollAmount * direction, behavior: 'smooth' });
}
</script>

{% endblock %}
