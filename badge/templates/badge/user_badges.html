{% extends "base.html" %}
{% load static %}

{% block title %}Điểm thưởng & Danh hiệu{% endblock %}

{% block extra_css %}
<style>
    body { background: #fff8ed; }

    :root {
      --primary: #003459;
      --secondary: #F7DBA7;
      --bg: #f8fafc;
      --card: #ffffff;
      --line: #e2e8f0;
      --text: #0f172a;
      --muted: #475569;
      --radius: 14px;
    }

    /* ✅ THÊM LẠI: Style .card (đồng bộ) */
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 24px; /* Đồng bộ padding */
      margin-bottom: 16px;
    }
    .card h3 {
        font-weight: 700;
        font-size: 20px;
        margin: 0 0 16px 0;
        color: var(--primary);
    }
    .text-muted {
        color: var(--muted);
        font-size: 14px;
    }

    /* === ✅ SỬA: Style Badge Row (từ code cũ) === */
    .badge-row {
        display: grid;
        grid-template-columns: 50px 1fr auto;
        gap: 16px;
        align-items: center;
        padding: 14px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: #fff;
        margin-bottom: 12px;
    }
    .b-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        font-size: 26px;
        background: var(--bg);
        border: 1px solid var(--line);
    }
    .b-name {
        font-weight: 700;
        font-size: 16px;
        color: var(--text);
    }
    .b-meta {
        color: var(--muted);
        font-size: 13px;
        margin-top: 2px;
    }
    .b-bar {
        height: 8px;
        background: #eef2ff;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 8px;
    }
    .b-bar > div {
        height: 100%;
        width: 0%;
        transition: width 0.5s ease;
    }

    /* ✅ SỬA (Task 1): Thêm màu cho thanh tiến trình */
    .b-bar-gold { background: #f59e0b; }
    .b-bar-blue { background: #3b82f6; }
    .b-bar-green { background: #16a34a; }
    .b-bar-red { background: #ef4444; }
    .b-bar-cyan { background: #06b6d4; }
    .b-bar-lime { background: #84cc16; }

    /* Style cho cột trạng thái */
    .b-status {
        text-align: right;
        font-weight: 600;
        font-size: 14px;
    }
    .b-status .percent {
        color: var(--primary);
    }
    /* ✅ SỬA (Task 2): Icon hoàn thành (thay cho check) */
    .b-status .completed-icon {
        font-size: 22px;
        color: #16a34a;
    }

    /* === ✅ SỬA (Task 3): Style Form Chọn Badge === */
    .achieved-option {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        font-size: 14px;
        cursor: pointer;
    }
    .achieved-option input[type="radio"] {
        accent-color: var(--primary);
        transform: scale(1.2);
    }

    /* ✅ SỬA LỖI (Task 1): Xóa style .badge-chip (màu vàng) CŨ */
    /* .badge-chip { ... } */
    /* .achieved-option:hover .badge-chip { ... } */


    /* === ✅ THÊM MỚI (Task 4): Khung xem trước === */
    .badge-preview-box {
        margin-top: 24px;
        padding: 16px;
        border: 2px dashed var(--line);
        border-radius: var(--radius);
        text-align: center;
        background: var(--bg);
    }
    .badge-preview-box p {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 12px;
        font-weight: 500;
        margin-top: 0;
    }
    .preview-username {
        font-weight: 700;
        font-size: 16px;
        color: var(--primary);
        margin-right: 8px;
    }
    /* Style cho chip XEM TRƯỚC (DÙNG CHUNG CHO CẢ 2 BÊN) */
    .preview-badge-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        font-size: 13px;
        font-weight: 700;
        border-radius: 12px;
        border: 1px solid;
        cursor: pointer;
        transition: 0.2s;
    }
    /* Các màu cho chip XEM TRƯỚC (dựa trên model.py) */
    .badge-color-gold { background: #fff4c2; border-color: #f7d98b; color: #8a5a00; }
    .badge-color-blue { background: #e0f2fe; border-color: #7dd3fc; color: #0369a1; }
    .badge-color-green { background: #dcfce7; border-color: #86efac; color: #15803d; }
    .badge-color-red { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
    .badge-color-cyan { background: #cffafe; border-color: #67e8f9; color: #0e7490; }
    .badge-color-lime { background: #f7fee7; border-color: #bef264; color: #4d7c0f; }

    /* Thêm hover cho các chip chọn */
    .achieved-option:hover .preview-badge-chip {
        transform: scale(1.05);
    }

</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">

        <div class="col-lg-4">
            <div class="card">
                <h3>Danh hiệu của bạn</h3>

                {% if achieved_badges %}
                <form id="badgeDisplayForm">
                    <label class="achieved-option">
                        <input type="radio" name="display_badge" value="none"
                               {% if not current_display_id %}checked{% endif %}>
                        Không hiển thị
                    </label>

                    {% for b in achieved_badges %}
                    <label class="achieved-option">
                        <input type="radio"
                               name="display_badge"
                               value="{{ b.id }}"
                               {% if current_display_id == b.id %}checked{% endif %}>
                        <span class="preview-badge-chip badge-color-{{ b.color }}">{{ b.icon }} {{ b.name }}</span>
                    </label>
                    {% endfor %}
                </form>

                <div class="badge-preview-box">
                    <p>Xem trước (hiển thị cạnh tên bạn):</p>
                    <div>
                        <span class="preview-username">{{ request.user.username }}</span>
                        <span id="preview-badge" class="preview-badge-chip" style="display:none;">
                            <span id="preview-icon"></span>
                            <span id="preview-name"></span>
                        </span>
                        <span id="preview-none" class="text-muted" style="font-style:italic; display:none;">(Không hiển thị)</span>
                    </div>
                </div>

                {% else %}
                <p class="text-muted">Bạn chưa đạt danh hiệu nào. Hãy cố gắng hơn nhé!</p>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card">
                <h3>Danh hiệu hệ thống</h3>
                <p class="text-muted" style="margin-top: -10px; margin-bottom: 20px;">
                    Đây là toàn bộ danh hiệu bạn có thể đạt được trong PetTalk.
                </p>

                {% for b in progress_data %}
                <div class="badge-row">
                    <div class="b-icon">{{ b.icon }}</div>
                    <div>
                        <div class="b-name">{{ b.name }}</div>
                        <div class="b-meta">
                            Mục tiêu: {{ b.target }} {{ b.type }}
                        </div>
                        <div class="b-bar">
                            <div class="b-bar-{{ b.color }}" style="width:{{ b.percent }}%;"></div>
                        </div>
                    </div>

                    <div class="b-status">
                        {% if b.completed %}
                            <span class="completed-icon" title="Đã hoàn thành">
                                <i class="fa-solid fa-trophy"></i>
                            </span>
                        {% else %}
                            <span class="percent">{{ b.percent }}%</span>
                            <div class="text-muted" style="font-size: 12px; font-weight: 500;">
                                {{ b.progress }}/{{ b.target }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Lấy CSRF token
function getCookie(name){let v=null;if(document.cookie&&document.cookie!==''){const c=document.cookie.split(';');for(let i=0;i<c.length;i++){const s=c[i].trim();if(s.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(s.substring(name.length+1));break}}}return v}
const csrftoken=getCookie('csrftoken');

// Lấy dữ liệu badge từ Django
const achievedBadges = {{ achieved_badges_json|safe }};

// Map màu từ model (Python) sang CSS class (cho preview)
const colorMap = {
    "gold": "badge-color-gold",
    "blue": "badge-color-blue",
    "green": "badge-color-green",
    "red": "badge-color-red",
    "cyan": "badge-color-cyan",
    "lime": "badge-color-lime",
};

// Lấy các phần tử DOM của preview
const previewBadge = document.getElementById('preview-badge');
const previewIcon = document.getElementById('preview-icon');
const previewName = document.getElementById('preview-name');
const previewNone = document.getElementById('preview-none');

/**
 * ✅ THÊM MỚI (Task 4): Hàm cập nhật preview
 * @param {string} selectedId ID của badge được chọn, hoặc "none"
 */
function updatePreview(selectedId) {
    if (!previewBadge || !previewNone) return; // Thoát nếu không ở đúng trang

    if (selectedId === 'none' || !selectedId) {
        // Ẩn chip, hiện text "Không hiển thị"
        previewBadge.style.display = 'none';
        previewNone.style.display = 'inline';
    } else {
        // Tìm badge trong data
        // ✅ SỬA LỖI: So sánh b.id (số) với selectedId (string)
        const badge = achievedBadges.find(b => b.id == selectedId);
        if (badge) {
            // Cập nhật nội dung
            previewIcon.textContent = badge.icon;
            previewName.textContent = badge.name;

            // Xóa class màu cũ
            previewBadge.className = 'preview-badge-chip';
            // Thêm class màu mới
            // ✅ SỬA LỖI: Giờ "badge.color" đã tồn tại, nó sẽ lấy đúng màu
            const colorClass = colorMap[badge.color] || 'badge-color-blue';
            previewBadge.classList.add(colorClass);

            // Hiển thị chip, ẩn text
            previewBadge.style.display = 'inline-flex';
            previewNone.style.display = 'none';
        }
    }
}

// Chạy khi trang tải xong
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('badgeDisplayForm');
    if (!form) return;

    // 1. Cập nhật preview lần đầu khi tải trang
    const currentSelectedRadio = form.querySelector('input[name="display_badge"]:checked');
    if (currentSelectedRadio) {
        updatePreview(currentSelectedRadio.value);
    } else {
        updatePreview('none'); // Mặc định là 'none' nếu không có gì được check
    }

    // 2. Thêm listener cho form (AJAX + Preview)
    form.addEventListener("change", function (e) {
        if (e.target.name !== 'display_badge') return;

        const selectedId = e.target.value;

        // Cập nhật preview ngay lập tức
        updatePreview(selectedId);

        // Gửi AJAX (code cũ của bạn)
        fetch("{% url 'badge:save_display_badge' %}", {
            method:"POST",
            headers:{
                "X-CSRFToken":csrftoken,
                "Content-Type":"application/x-www-form-urlencoded"
            },
            body:new URLSearchParams({
                badge_id: selectedId
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status !== 'success') {
                console.error('Lỗi khi lưu danh hiệu:', data.message);
            } else {
                console.log('Đã lưu danh hiệu!');
            }
        })
        .catch(err => console.error('Lỗi fetch:', err));
    });
});
</script>
{% endblock %}