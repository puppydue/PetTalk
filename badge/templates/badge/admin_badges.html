{% extends "base.html" %}
{% load static %}

{% block title %}Qu·∫£n l√Ω danh hi·ªáu | PetTalk Admin{% endblock %}

{% block extra_css %}
<style>
  /* V√πng n·ªôi dung ch√≠nh */
  .admin-badge {
    width: 85%;
    max-width: 1200px;
    margin: 50px auto; /* cƒÉn gi·ªØa, c√°ch header 1 ƒëo·∫°n */
    background: #fff;
    padding: 32px 40px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
  }

  /* Ti√™u ƒë·ªÅ + n√∫t th√™m */
  .header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  .header-row h2 {
    font-weight: 800;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .btn-add {
    background: var(--primary);
    color: #fff;
    padding: 10px 18px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
  }
  .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }

  /* B·∫£ng danh hi·ªáu */
  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
  }
  thead { background: #f7dba7; }
  th, td {
    padding: 14px 20px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }
  th {
    font-weight: 700;
    color: var(--primary);
    font-size: 15px;
  }
  td {
    font-size: 14px;
    color: var(--text);
  }
  tr:last-child td { border-bottom: none; }

  /* N√∫t thao t√°c */
  .actions {
    display: flex;
    gap: 10px;
  }
  .btn-edit, .btn-delete {
    padding: 6px 14px;
    border-radius: 8px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .btn-edit {
    background: #e0f2fe;
    color: #0369a1;
    border: 1px solid #7dd3fc;
  }
  .btn-delete {
    background: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fecaca;
  }
  .btn-edit:hover { background: #bae6fd; transform: translateY(-1px); }
  .btn-delete:hover { background: #fecaca; transform: translateY(-1px); }

  /* === MODAL FORM & MODAL DELETE === */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  .modal {
    background: #fff;
    border-radius: 16px;
    padding: 24px 28px;
    width: 460px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    animation: fadeIn 0.25s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .modal h3 {
    color: var(--primary);
    font-weight: 700;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 14px;
    display: flex;
    flex-direction: column;
  }

  label { font-weight: 600; margin-bottom: 6px; }

  input, textarea {
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--line);
    font-family: inherit;
    background: #f9fafb;
  }

  textarea { resize: vertical; min-height: 70px; }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 18px;
  }

  .btn-cancel, .btn-save {
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-cancel { background: #e2e8f0; color: #1e293b; }
  .btn-save { background: var(--primary); color: white; }
</style>

{% endblock %}

{% block content %}
<div class="admin-badge">
  <div class="header-row">
    <h2>üèÖ Qu·∫£n l√Ω danh hi·ªáu</h2>
    <a href="{% url 'badge:add_badge' %}" class="btn-add">+ Th√™m danh hi·ªáu m·ªõi</a>
  </div>
      <table>
  <thead>
    <tr>
      <th>ID</th>
      <th>T√™n danh hi·ªáu</th>
      <th>M√¥ t·∫£</th>
      <th>Ng√†y t·∫°o</th>
      <th>C·∫≠p nh·∫≠t</th>
      <th>Ng∆∞·ªùi ƒë·∫°t</th> <!-- üÜï C·ªôt m·ªõi -->
      <th>H√†nh ƒë·ªông</th>
    </tr>
  </thead>
  <tbody>
  {% for badge in badges %}
  <tr>
    <td>{{ badge.id }}</td>
    <td>{{ badge.name }}</td>
    <td>{{ badge.description }}</td>
    <td>{{ badge.created_at|date:"Y-m-d" }}</td>
    <td>{{ badge.updated_at|date:"Y-m-d" }}</td>
    <td>{{ badge.achieved_count }}</td>
    <td class="actions">
        <a href="{% url 'badge:edit_badge' badge.id %}" class="btn-edit">S·ª≠a</a>
        <a href="{% url 'badge:delete_badge' badge.id %}" class="btn-delete"
            onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh hi·ªáu n√†y?');">X√≥a</a>
    </td>
  </tr>
  {% empty %}
  <tr><td colspan="7">Ch∆∞a c√≥ danh hi·ªáu n√†o</td></tr>
  {% endfor %}
</tbody>
</table>

  </table>
</div>

<!-- === FORM TH√äM / S·ª¨A DANH HI·ªÜU === -->
<div class="modal-overlay" id="modalAdd">
  <div class="modal">
    <h3 id="modalTitle">‚ûï Th√™m danh hi·ªáu m·ªõi</h3>
    <form id="fakeForm">
      <div class="form-group">
        <label for="badge_name">T√™n danh hi·ªáu</label>
        <input type="text" id="badge_name" required>
      </div>
      <div class="form-group">
        <label for="description">M√¥ t·∫£</label>
        <textarea id="description" required></textarea>
      </div>
      <div class="form-group">
        <label for="created_at">Ng√†y t·∫°o</label>
        <input type="date" id="created_at" required>
      </div>
      <div class="form-group">
        <label for="updated_at">C·∫≠p nh·∫≠t</label>
        <input type="date" id="updated_at" required>
      </div>
      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="closeModal()">H·ªßy</button>
        <button type="submit" class="btn-save">L∆∞u</button>
      </div>
    </form>
  </div>
</div>

<!-- === MODAL X√ÅC NH·∫¨N X√ìA === -->
<div class="modal-overlay" id="modalDelete">
  <div class="modal">
    <h3>‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h3>
    <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh hi·ªáu "<b id="delName"></b>" kh√¥ng?</p>
    <div class="form-actions">
      <button type="button" class="btn-cancel" onclick="closeDelete()">H·ªßy</button>
      <button type="button" class="btn-save" style="background:#dc2626;" onclick="deleteBadge()">X√≥a</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentId = 3;

// === M·ªû FORM TH√äM / S·ª¨A ===
function openModal(editData = null) {
  const modal = document.getElementById("modalAdd");
  const title = document.getElementById("modalTitle");
  const form = document.getElementById("fakeForm");
  form.reset();

  if (editData) {
    title.innerText = "‚úèÔ∏è Ch·ªânh s·ª≠a danh hi·ªáu";
    form.dataset.mode = "edit";
    form.dataset.editId = editData.id;
    document.getElementById("badge_name").value = editData.name;
    document.getElementById("description").value = editData.desc;
    document.getElementById("created_at").value = editData.created;
    document.getElementById("updated_at").value = editData.updated;
  } else {
    title.innerText = "‚ûï Th√™m danh hi·ªáu m·ªõi";
    form.dataset.mode = "add";
  }
  modal.style.display = "flex";
}
function closeModal() {
  document.getElementById("modalAdd").style.display = "none";
}

// === SUBMIT FORM ===
document.getElementById("fakeForm").addEventListener("submit", function(e){
  e.preventDefault();
  const mode = this.dataset.mode;
  const id = this.dataset.editId;
  const name = document.getElementById("badge_name").value.trim();
  const desc = document.getElementById("description").value.trim();
  const created = document.getElementById("created_at").value;
  const updated = document.getElementById("updated_at").value;

  if (!name || !desc || !created || !updated) {
    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }

  if (mode === "add") {
    currentId++;
   const newRow = `
  <tr id="badge-${currentId}">
    <td>${currentId}</td>
    <td>${name}</td>
    <td>${desc}</td>
    <td>${created}</td>
    <td>${updated}</td>
    <td>0</td>
    <td class="actions">
      <button class="btn-edit" onclick="editBadge(${currentId})">S·ª≠a</button>
      <button class="btn-delete" onclick="confirmDelete(${currentId}, '${name}')">X√≥a</button>
    </td>
  </tr>`;

    document.getElementById("badgeTableBody").insertAdjacentHTML("beforeend", newRow);
  } else if (mode === "edit") {
    const row = document.getElementById(`badge-${id}`);
    row.children[1].innerText = name;
    row.children[2].innerText = desc;
    row.children[3].innerText = created;
    row.children[4].innerText = updated;
  }
  closeModal();
});

// === N√öT "S·ª¨A" ===
function editBadge(id) {
  const row = document.getElementById(`badge-${id}`);
  const data = {
    id: id,
    name: row.children[1].innerText,
    desc: row.children[2].innerText,
    created: row.children[3].innerText,
    updated: row.children[4].innerText
  };
  openModal(data);
}

// === X√ìA DANH HI·ªÜU ===
function confirmDelete(id, name) {
  const modal = document.getElementById("modalDelete");
  document.getElementById("delName").innerText = name;
  modal.dataset.deleteId = id;
  modal.style.display = "flex";
}
function closeDelete() {
  document.getElementById("modalDelete").style.display = "none";
}
function deleteBadge() {
  const modal = document.getElementById("modalDelete");
  const id = modal.dataset.deleteId;
  const row = document.getElementById(`badge-${id}`);
  if (row) row.remove();
  modal.style.display = "none";
}
</script>
{% endblock %}
